<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QuickChat ‚Äî Enhanced Edition</title>
<style>
:root {
  --bg: #0b0f14;
  --elev: #111723;
  --border: #1b2435;
  --text: #e6eefc;
  --muted: #98a7c0;
  --brand: #4f8cff;
  --success: #4caf50;
  --warning: #ff9800;
  --danger: #f44336;
  --transition: all 0.3s ease;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  --radius: 12px;
}

* {
  box-sizing: border-box;
  transition: var(--transition);
}

body.theme-high { --bg:#05070b; --elev:#0a1120; --border:#172135; --text:#eaf2ff; --muted:#9fb1cc; --brand:#4f8cff }
body.theme-dim { --bg:#0b0f14; --elev:#111723; --border:#1b2435; --text:#e6eefc; --muted:#98a7c0; --brand:#4f8cff }

html, body {
  height: 100%;
  margin: 0;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  overflow: hidden;
}

.app {
  display: flex;
  flex-direction: column;
  height: 100%;
}

/* Enhanced Header */
header {
  display: flex;
  align-items: center;
  gap: .6rem;
  padding: .7rem 1rem;
  background: linear-gradient(135deg, var(--elev) 0%, #0e1420 100%);
  border-bottom: 1px solid var(--border);
  box-shadow: var(--shadow);
  position: relative;
  z-index: 100;
}

.title {
  font-weight: 800;
  font-size: 1.4rem;
  background: linear-gradient(45deg, var(--brand), #6aa1ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: titleGlow 3s ease-in-out infinite alternate;
}

@keyframes titleGlow {
  from { filter: brightness(1); }
  to { filter: brightness(1.2); }
}

/* Enhanced Cards */
.card {
  background: var(--elev);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1rem;
  box-shadow: var(--shadow);
  animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.hidden {
  display: none !important;
}

/* Enhanced Inputs */
.input {
  width: 100%;
  padding: .8rem;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #0b1220;
  color: var(--text);
  margin: .4rem 0;
  font-size: 0.95rem;
  transition: all 0.3s ease;
}

.input:focus {
  outline: none;
  border-color: var(--brand);
  box-shadow: 0 0 0 2px rgba(79, 140, 255, 0.2);
  transform: translateY(-1px);
}

/* Enhanced Buttons */
.btn {
  background: linear-gradient(135deg, var(--brand), #3a7cff);
  border: none;
  color: #fff;
  padding: .7rem 1.2rem;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

.btn:hover::before {
  left: 100%;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(79, 140, 255, 0.4);
}

.btn.ghost {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
}

.btn.ghost:hover {
  background: var(--border);
  transform: translateY(-1px);
}

/* Enhanced Lists */
.list {
  display: flex;
  flex-direction: column;
  gap: .5rem;
  margin-top: .5rem;
}

.item {
  display: flex;
  align-items: center;
  gap: .5rem;
  padding: .8rem;
  border-radius: 10px;
  background: #0b1424;
  border: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.3s ease;
  animation: slideInLeft 0.4s ease-out;
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.item:hover {
  background: #0c1a30;
  border-color: var(--brand);
  transform: translateX(5px);
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--border);
  transition: all 0.3s ease;
}

.avatar:hover {
  border-color: var(--brand);
  transform: scale(1.1);
}

/* Enhanced Messages */
#messages {
  margin-top: .6rem;
  max-height: 360px;
  overflow: auto;
  background: #071022;
  padding: .8rem;
  border-radius: var(--radius);
  scroll-behavior: smooth;
}

#messages::-webkit-scrollbar {
  width: 6px;
}

#messages::-webkit-scrollbar-track {
  background: transparent;
}

#messages::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 3px;
}

#messages::-webkit-scrollbar-thumb:hover {
  background: var(--brand);
}

/* Enhanced Message Items */
.message-item {
  display: flex;
  align-items: flex-start;
  gap: .8rem;
  padding: .8rem;
  border-radius: var(--radius);
  margin-bottom: .5rem;
  animation: messageSlide 0.3s ease-out;
  position: relative;
}

@keyframes messageSlide {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-item.own {
  background: linear-gradient(135deg, #08263f, #0a2d4a);
  margin-left: 2rem;
}

.message-item.other {
  background: #071328;
  margin-right: 2rem;
}

.message-content {
  flex: 1;
}

.message-sender {
  font-weight: 700;
  margin-bottom: .3rem;
  color: var(--brand);
}

.message-text {
  margin: .3rem 0;
  line-height: 1.4;
}

.message-time {
  color: var(--muted);
  font-size: .75rem;
  margin-top: .3rem;
}

/* Enhanced Bottom Navigation */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  background: var(--elev);
  border-top: 1px solid var(--border);
  z-index: 1000;
  backdrop-filter: blur(10px);
  padding: 0.5rem;
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 8px;
  cursor: pointer;
  color: var(--muted);
  font-size: 0.8rem;
  transition: all 0.3s ease;
  border-radius: var(--radius);
  position: relative;
}

.nav-item.active {
  color: var(--brand);
  transform: translateY(-5px);
}

.nav-item.active::after {
  content: '';
  position: absolute;
  bottom: -8px;
  width: 4px;
  height: 4px;
  background: var(--brand);
  border-radius: 50%;
}

.nav-icon {
  font-size: 1.3rem;
  margin-bottom: 4px;
  transition: all 0.3s ease;
}

.nav-item.active .nav-icon {
  transform: scale(1.2);
}

/* Enhanced Pages */
.page {
  display: none;
  padding-bottom: 80px;
  animation: pageFade 0.4s ease-out;
}

@keyframes pageFade {
  from {
    opacity: 0;
    transform: translateX(20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.page.active {
  display: block;
}

/* Enhanced Games */
.game-container {
  background: var(--elev);
  border-radius: var(--radius);
  padding: 1.2rem;
  margin-bottom: 1rem;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  animation: fadeInUp 0.6s ease-out;
}

.game-title {
  font-size: 1.3rem;
  margin-bottom: 1rem;
  color: var(--brand);
  font-weight: 700;
}

/* Enhanced Tic Tac Toe */
.tic-tac-toe {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
  margin: 1rem 0;
  max-width: 240px;
  background: var(--border);
  padding: 6px;
  border-radius: var(--radius);
}

.ttt-cell {
  width: 70px;
  height: 70px;
  background: var(--bg);
  border: 2px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.8rem;
  cursor: pointer;
  transition: all 0.3s ease;
  border-radius: 8px;
}

.ttt-cell:hover {
  background: #0c1a30;
  border-color: var(--brand);
  transform: scale(1.05);
}

.ttt-cell.x {
  color: var(--brand);
}

.ttt-cell.o {
  color: var(--success);
}

/* Enhanced Settings */
.settings-section {
  margin-bottom: 1.5rem;
  animation: fadeInUp 0.5s ease-out;
}

.settings-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  border-bottom: 1px solid var(--border);
  transition: all 0.3s ease;
}

.settings-item:hover {
  background: #0c1a30;
  border-radius: var(--radius);
}

.settings-item:last-child {
  border-bottom: none;
}

/* Switch Toggle */
.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: var(--border);
  transition: .4s;
  border-radius: 24px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: var(--brand);
}

input:checked + .slider:before {
  transform: translateX(26px);
}

/* Enhanced Toast */
#toasts {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 100px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
}

.toast {
  padding: 12px 20px;
  background: var(--elev);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  box-shadow: var(--shadow);
  animation: toastSlide 0.3s ease-out;
  backdrop-filter: blur(10px);
}

@keyframes toastSlide {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Enhanced Status Indicators */
.status-indicator {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 8px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

.status-online {
  background: var(--success);
  box-shadow: 0 0 10px var(--success);
}

.status-offline {
  background: var(--muted);
}

.status-away {
  background: var(--warning);
  box-shadow: 0 0 10px var(--warning);
}

.status-busy {
  background: var(--danger);
  box-shadow: 0 0 10px var(--danger);
}

/* Enhanced Theme Selector */
.theme-selector {
  display: flex;
  gap: 12px;
  margin-top: 12px;
}

.theme-option {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  border: 3px solid transparent;
  transition: all 0.3s ease;
  position: relative;
}

.theme-option.active {
  border-color: var(--text);
  transform: scale(1.1);
}

.theme-option::after {
  content: '‚úì';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-weight: bold;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.theme-option.active::after {
  opacity: 1;
}

/* Enhanced Loading States */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid var(--border);
  border-radius: 50%;
  border-top-color: var(--brand);
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Enhanced Context Menu */
.context-menu {
  position: absolute;
  background: var(--elev);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 8px 0;
  z-index: 1000;
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  animation: contextMenuSlide 0.2s ease-out;
}

@keyframes contextMenuSlide {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.context-menu-item {
  padding: 10px 16px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.context-menu-item:hover {
  background: var(--brand);
  color: white;
}

/* Enhanced Search */
.search-container {
  position: relative;
  margin-bottom: 1rem;
}

.search-results {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--elev);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  max-height: 200px;
  overflow-y: auto;
  z-index: 100;
  display: none;
  box-shadow: var(--shadow);
}

.search-result-item {
  padding: 10px 12px;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  transition: all 0.2s ease;
}

.search-result-item:hover {
  background: var(--brand);
  color: white;
}

/* Enhanced File Preview */
.file-preview {
  max-width: 250px;
  margin-top: 8px;
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow);
  animation: fadeInUp 0.4s ease-out;
}

.file-preview img {
  width: 100%;
  height: auto;
  transition: transform 0.3s ease;
}

.file-preview img:hover {
  transform: scale(1.05);
}

.file-info {
  background: rgba(0,0,0,0.8);
  padding: 8px 12px;
  font-size: 0.8rem;
  color: white;
}

/* Enhanced Voice Message */
.voice-message {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 8px;
  padding: 8px 12px;
  background: rgba(79, 140, 255, 0.1);
  border-radius: var(--radius);
}

.voice-play-btn {
  background: var(--brand);
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.voice-play-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(79, 140, 255, 0.4);
}

.voice-progress {
  flex: 1;
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  position: relative;
  overflow: hidden;
}

.voice-progress-bar {
  position: absolute;
  height: 100%;
  background: linear-gradient(90deg, var(--brand), #6aa1ff);
  border-radius: 3px;
  width: 0%;
  transition: width 0.1s ease;
}

.voice-duration {
  font-size: 0.8rem;
  color: var(--muted);
  min-width: 40px;
}

/* Enhanced Reaction System */
.reaction-container {
  display: flex;
  gap: 6px;
  margin-top: 8px;
  flex-wrap: wrap;
}

.reaction {
  background: var(--elev);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 4px 8px;
  font-size: 0.8rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  transition: all 0.3s ease;
}

.reaction:hover {
  background: var(--brand);
  transform: scale(1.1);
}

.reaction-picker {
  position: absolute;
  background: var(--elev);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 6px;
  z-index: 100;
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  animation: fadeInUp 0.3s ease-out;
}

.reaction-emoji {
  cursor: pointer;
  padding: 6px;
  border-radius: 6px;
  font-size: 1.3rem;
  transition: all 0.2s ease;
  text-align: center;
}

.reaction-emoji:hover {
  background: var(--brand);
  transform: scale(1.2);
}

/* Enhanced Pinned Messages */
.pinned-message {
  border-left: 4px solid var(--brand);
  background: linear-gradient(135deg, #0c1a30, #0f2040) !important;
  animation: pulseGlow 2s infinite;
}

@keyframes pulseGlow {
  0% { box-shadow: 0 0 5px rgba(79, 140, 255, 0.3); }
  50% { box-shadow: 0 0 15px rgba(79, 140, 255, 0.6); }
  100% { box-shadow: 0 0 5px rgba(79, 140, 255, 0.3); }
}

.pin-indicator {
  color: var(--brand);
  font-size: 0.9rem;
  margin-right: 6px;
  animation: bounce 2s infinite;
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
  40% { transform: translateY(-5px); }
  60% { transform: translateY(-3px); }
}

/* Enhanced Call Items */
.call-item {
  display: flex;
  align-items: center;
  padding: 1rem;
  border-bottom: 1px solid var(--border);
  transition: all 0.3s ease;
  animation: slideInRight 0.4s ease-out;
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.call-item:hover {
  background: #0c1a30;
  border-radius: var(--radius);
  transform: translateX(5px);
}

.call-avatar {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  margin-right: 1rem;
  border: 2px solid var(--border);
}

.call-details {
  flex: 1;
}

.call-name {
  font-weight: bold;
  margin-bottom: 4px;
}

.call-info {
  color: var(--muted);
  font-size: 0.9rem;
}

.call-status {
  margin-left: 8px;
  font-size: 0.8rem;
  padding: 2px 8px;
  border-radius: 12px;
  font-weight: 600;
}

.call-incoming {
  background: rgba(76, 175, 80, 0.2);
  color: var(--success);
}

.call-missed {
  background: rgba(244, 67, 54, 0.2);
  color: var(--danger);
}

.call-outgoing {
  background: rgba(33, 150, 243, 0.2);
  color: #2196f3;
}

/* Responsive Design */
@media (max-width: 768px) {
  .app {
    font-size: 14px;
  }
  
  header {
    padding: 0.5rem;
  }
  
  .title {
    font-size: 1.2rem;
  }
  
  .card {
    padding: 0.8rem;
    margin-bottom: 0.8rem;
  }
  
  .bottom-nav {
    padding: 0.3rem;
  }
  
  .nav-icon {
    font-size: 1.1rem;
  }
  
  .page {
    padding-bottom: 70px;
  }
}

/* Dark mode toggle enhancement */
#darkModeToggle {
  position: relative;
  overflow: hidden;
}

/* Animation for new messages */
@keyframes newMessage {
  0% {
    background: rgba(79, 140, 255, 0.3);
  }
  100% {
    background: transparent;
  }
}

.new-message {
  animation: newMessage 2s ease-out;
}

/* Enhanced Typing Indicator */
.typing-dots {
  display: inline-block;
}

.typing-dots span {
  display: inline-block;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--brand);
  margin: 0 2px;
  animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}

/* Enhanced Scroll to Bottom Button */
.scroll-to-bottom {
  position: absolute;
  bottom: 80px;
  right: 20px;
  background: var(--brand);
  color: white;
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: all 0.3s ease;
  z-index: 99;
}

.scroll-to-bottom:hover {
  transform: scale(1.1) translateY(-5px);
  box-shadow: 0 6px 20px rgba(79, 140, 255, 0.4);
}

.status-option {
  padding: 6px 12px;
  border-radius: 16px;
  font-size: 0.8rem;
  cursor: pointer;
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 6px;
}

.status-option.active {
  background: var(--brand);
  border-color: var(--brand);
}
</style>
</head>
<body>
<div class="app" id="app">
<header>
<div class="title">QuickChat</div>
<div style="flex:1"></div>
<div style="display:flex;align-items:center;gap:0.5rem">
<img id="navAvatar" class="avatar" src="" alt="me" style="width:36px;height:36px;border:1px solid var(--border);cursor:pointer" title="Toggle Profile Menu"/>
<button id="darkModeToggle" class="btn ghost" title="Toggle Dark Mode" style="padding:0.3rem 0.6rem;">Dark Mode</button>
<button id="logoutBtn" class="btn ghost" title="Logout" style="padding:0.3rem 0.6rem;margin-left:8px;">Logout</button>
</div>
</header>

<div id="globalBanner" class="hidden" style="background:#0c2140;border-bottom:1px solid var(--border);padding:.5rem;text-align:center;color:#dfefff"></div>

<main>
<!-- AUTH CARD -->
<section id="auth" class="card" style="max-width:720px;margin:2rem auto;animation:fadeInUp 0.6s ease-out">
<h3 style="text-align:center;margin-bottom:1.5rem;color:var(--brand)">Sign in / Register</h3>
<input id="loginEmail" class="input" placeholder="Email" type="email" />
<input id="loginPass" class="input" placeholder="Password" type="password" />
<div style="display:flex;gap:.5rem;margin-top:1rem;flex-wrap:wrap">
<button id="loginBtn" class="btn" style="flex:1">Log in</button>
<button id="registerBtn" class="btn ghost" style="flex:1">Register</button>
<button id="googleBtn" class="btn ghost" style="flex:1">Sign in with Google</button>
</div>
<div id="authMsg" style="color:var(--muted);margin-top:.8rem;text-align:center;min-height:20px"></div>
</section>

<!-- APP PAGES -->
<section id="appUI" class="hidden" style="max-width:1100px;margin:16px auto 80px">
<!-- Navigation Tabs -->
<div class="bottom-nav">
  <div class="nav-item active" data-page="chats-page">
    <div class="nav-icon">üí¨</div>
    <div>Chats</div>
  </div>
  <div class="nav-item" data-page="calls-page">
    <div class="nav-icon">üìû</div>
    <div>Calls</div>
  </div>
  <div class="nav-item" data-page="games-page">
    <div class="nav-icon">üéÆ</div>
    <div>Games</div>
  </div>
  <div class="nav-item" data-page="settings-page">
    <div class="nav-icon">‚öôÔ∏è</div>
    <div>Settings</div>
  </div>
</div>

<!-- Chats Page -->
<div id="chats-page" class="page active">
  <div style="display:flex;gap:1rem;align-items:flex-start;flex-wrap:wrap">
    <div style="flex:1;min-width:300px">
      <!-- Profile and Admin Panel Container -->
      <div id="profileAdminPanel" class="card" style="margin-bottom:.8rem; display:none;">
        <strong style="display:block;margin-bottom:1rem;color:var(--brand)">My Profile</strong>
        <input id="profName" class="input" placeholder="Display name" />
        <input id="profAvatarUrl" class="input" placeholder="Avatar URL (optional)" />

        <!-- Enhanced User status selector -->
        <div class="status-selector" style="margin:1rem 0">
          <strong style="display:block;margin-bottom:8px">Status</strong>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <div class="status-option active" data-status="online">
              <span class="status-indicator status-online"></span>Online
            </div>
            <div class="status-option" data-status="away">
              <span class="status-indicator status-away"></span>Away
            </div>
            <div class="status-option" data-status="busy">
              <span class="status-indicator status-busy"></span>Busy
            </div>
          </div>
        </div>

        <div style="display:flex;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap">
          <button id="saveProfileBtn" class="btn" style="flex:1">Save Profile</button>
          <button id="resetAvatarBtn" class="btn ghost" style="flex:1">Reset Avatar</button>
        </div>

        <!-- Enhanced Theme selector -->
        <div style="margin-bottom: 1rem;">
          <strong style="display:block;margin-bottom:8px">Chat Theme</strong>
          <div class="theme-selector">
            <div class="theme-option theme-blue active" data-theme="blue" style="background:#4f8cff"></div>
            <div class="theme-option theme-green" data-theme="green" style="background:#4caf50"></div>
            <div class="theme-option theme-purple" data-theme="purple" style="background:#9c27b0"></div>
            <div class="theme-option theme-red" data-theme="red" style="background:#f44336"></div>
          </div>
        </div>

        <div id="adminControls" style="display:none; border-top: 1px solid var(--border); padding-top:15px; margin-top: 15px;">
          <div style="font-weight:700; margin-bottom:12px;color:var(--brand)">Admin Panel üëë</div>

          <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
            <input id="adminTarget" class="input" placeholder="UID or 5-digit ID" style="flex:1;padding:.6rem" />
            <button id="adminLookupBtn" class="btn ghost">Lookup</button>
          </div>

          <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
            <button id="adminVerifyBtn" class="btn" style="flex:1">Verify</button>
            <button id="adminUnverifyBtn" class="btn ghost" style="flex:1">Unverify</button>
          </div>

          <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
            <button id="adminBanBtn" class="btn ghost" style="flex:1">Ban</button>
            <button id="adminUnbanBtn" class="btn ghost" style="flex:1">Unban</button>
          </div>

          <div style="margin-bottom:12px">
            <input id="adminChatId" class="input" placeholder="Chat ID (room id)" style="margin-bottom:8px;padding:.6rem" />
            <input id="adminMsgKey" class="input" placeholder="Message Key to delete" style="padding:.6rem" />
            <div style="display:flex;gap:6px;margin-top:8px">
              <button id="adminDelMsgBtn" class="btn" style="flex:1">Delete Message</button>
            </div>
          </div>

          <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px;margin-bottom:12px;">
            <div style="font-weight:700;margin-bottom:8px">Global Announcement</div>
            <input id="adminAnnText" class="input" placeholder="Announcement text" style="padding:.6rem" />
            <div style="display:flex;gap:6px;margin-top:8px">
              <button id="adminAnnSet" class="btn" style="flex:1">Set</button>
              <button id="adminAnnClear" class="btn ghost" style="flex:1">Clear</button>
            </div>
          </div>

          <div>
            <button id="adminRefreshUsers" class="btn ghost" style="width:100%;margin-bottom:8px">Refresh Users</button>
            <div id="adminUsersList" style="max-height:220px;overflow:auto;margin-top:8px"></div>
          </div>
        </div>
      </div>

      <!-- ADD FRIENDS + REQUESTS PANELS -->
      <div class="card" style="margin-bottom:.8rem">
        <strong style="display:block;margin-bottom:.8rem">Add friends</strong>
        <div style="display:flex;gap:.5rem;margin-top:.5rem;flex-wrap:wrap">
          <input id="addByShort" class="input" placeholder="Enter 5-digit ID" style="flex:1;min-width:150px" />
          <button id="addFriendBtn" class="btn">Add</button>
        </div>
        <div id="friendRequestMsg" style="color:var(--muted);margin-top:.6rem;text-align:center"></div>
      </div>

      <div class="card" style="margin-bottom:.8rem">
        <strong style="display:block;margin-bottom:.8rem">Friend Requests</strong>
        <div style="display:flex;gap:1rem;margin-top:.5rem;flex-wrap:wrap">
          <div style="flex:1;min-width:200px">
            <div style="font-weight:700;margin-bottom:.6rem;color:var(--brand)">Incoming</div>
            <div id="incomingReqs" class="list"></div>
          </div>
          <div style="flex:1;min-width:200px">
            <div style="font-weight:700;margin-bottom:.6rem;color:var(--brand)">Outgoing</div>
            <div id="outgoingReqs" class="list"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem">
          <strong>Friends</strong>
          <div id="myShort" style="color:var(--muted);font-size:.9rem"></div>
        </div>
        <div id="friendsList" class="list" style="margin-top:.6rem;max-height:280px;overflow:auto"></div>
      </div>

      <div class="card" style="margin-top:.8rem">
        <strong style="display:block;margin-bottom:.8rem">Communities</strong>
        <div id="communitiesList" class="list"></div>
      </div>
    </div>

    <div style="width:420px;min-width:300px">
      <div class="card" id="chatCard">
        <div style="display:flex;align-items:center;gap:.6rem;position:relative;margin-bottom:1rem">
          <button id="chatBackBtn" class="btn ghost" style="display:none;position:absolute;left:0;">‚Üê Back</button>
          <img id="chatAvatar" class="avatar" src="" alt="" style="margin-left:30px">
          <div style="flex:1">
            <div id="chatTitle" style="font-weight:800;font-size:1.1rem">No chat selected</div>
            <div id="chatPresence" style="color:var(--muted);font-size:.85rem">‚Äî</div>
          </div>
          <div style="display:flex;gap:4px">
            <button id="audioCallBtn" class="btn ghost" title="Audio call (planned)">üé§</button>
            <button id="videoCallBtn" class="btn ghost" title="Video call (planned)">üìπ</button>
          </div>
        </div>

        <!-- Enhanced Search container -->
        <div class="search-container">
          <input id="messageSearch" class="input" placeholder="üîç Search messages..." style="margin-bottom:0" />
          <div id="searchResults" class="search-results"></div>
        </div>

        <div id="messages" style="margin-top:.6rem;max-height:360px;overflow:auto;background:#071022;padding:.8rem;border-radius:var(--radius);position:relative">
          <!-- Messages will be inserted here -->
        </div>

        <div style="display:flex;gap:.5rem;margin-top:.8rem;flex-wrap:wrap">
          <input id="msgInput" class="input" placeholder="Type a message..." style="flex:1;min-width:200px" autocomplete="off" />
          <input id="fileInput" type="file" accept="image/*,audio/*,video/*,.pdf,.doc,.docx,.txt" style="display:none" />
          <button id="attachBtn" class="btn ghost" title="Attach file">üìé</button>
          <button id="sendBtn" class="btn">Send</button>
        </div>
        <div id="typingIndicator" style="color:var(--muted);margin-top:.6rem;display:none;font-style:italic">
          <span class="typing-dots">
            <span></span><span></span><span></span>
          </span>
          Someone is typing...
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Calls Page -->
<div id="calls-page" class="page">
  <div class="card">
    <strong style="display:block;margin-bottom:1rem">Recent Calls</strong>
    <div id="callHistory" class="list"></div>
  </div>
  
  <!-- Enhanced Call history items -->
  <div id="callsList">
    <!-- Sample call items -->
    <div class="call-item">
      <img src="https://api.dicebear.com/8.x/thumbs/svg?seed=user1" class="call-avatar" alt="User 1">
      <div class="call-details">
        <div class="call-name">John Doe</div>
        <div class="call-info">
          <span>Yesterday 14:30</span>
          <span class="call-status call-outgoing">Outgoing</span>
        </div>
      </div>
      <div style="font-size:1.2rem">üìû</div>
    </div>
    
    <div class="call-item">
      <img src="https://api.dicebear.com/8.x/thumbs/svg?seed=user2" class="call-avatar" alt="User 2">
      <div class="call-details">
        <div class="call-name">Jane Smith</div>
        <div class="call-info">
          <span>Today 09:15</span>
          <span class="call-status call-incoming">Incoming</span>
        </div>
      </div>
      <div style="font-size:1.2rem">üìû</div>
    </div>
    
    <div class="call-item">
      <img src="https://api.dicebear.com/8.x/thumbs/svg?seed=user3" class="call-avatar" alt="User 3">
      <div class="call-details">
        <div class="call-name">Alex Johnson</div>
        <div class="call-info">
          <span>Today 11:42</span>
          <span class="call-status call-missed">Missed</span>
        </div>
      </div>
      <div style="font-size:1.2rem">üìû</div>
    </div>
  </div>
</div>

<!-- Games Page -->
<div id="games-page" class="page">
  <div class="card">
    <strong style="display:block;margin-bottom:.8rem">In-Chat Games</strong>
    <p style="color:var(--muted);margin:0">Play games with your friends directly in the chat!</p>
  </div>
  
  <!-- Enhanced Tic Tac Toe Game -->
  <div class="game-container">
    <div class="game-title">Tic Tac Toe</div>
    <p style="color:var(--muted);margin-bottom:1rem">Challenge a friend to a game of Tic Tac Toe</p>
    
    <div class="tic-tac-toe">
      <div class="ttt-cell" data-index="0"></div>
      <div class="ttt-cell" data-index="1"></div>
      <div class="ttt-cell" data-index="2"></div>
      <div class="ttt-cell" data-index="3"></div>
      <div class="ttt-cell" data-index="4"></div>
      <div class="ttt-cell" data-index="5"></div>
      <div class="ttt-cell" data-index="6"></div>
      <div class="ttt-cell" data-index="7"></div>
      <div class="ttt-cell" data-index="8"></div>
    </div>
    
    <div id="gameStatus" style="margin:1rem 0;font-weight:600;color:var(--brand)">Your turn (X)</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="startTicTacToe" style="flex:1">Start Game with Friend</button>
      <button class="btn ghost" id="resetTicTacToe" style="flex:1">Reset Game</button>
    </div>
  </div>
  
  <!-- Word Game -->
  <div class="game-container">
    <div class="game-title">Word Challenge</div>
    <p style="color:var(--muted);margin-bottom:1rem">Test your vocabulary with friends</p>
    <div id="wordGame">
      <p style="margin:.5rem 0">Current word: <span id="currentWord" style="font-weight:600;color:var(--brand)">_____</span></p>
      <input type="text" class="input" id="wordInput" placeholder="Enter a word">
      <button class="btn" id="submitWord" style="width:100%;margin-top:8px">Submit Word</button>
      <p id="wordScore" style="margin-top:8px;font-weight:600">Score: 0</p>
    </div>
  </div>
  
  <!-- Trivia Game -->
  <div class="game-container">
    <div class="game-title">Quick Trivia</div>
    <p style="color:var(--muted);margin-bottom:1rem">Answer trivia questions with friends</p>
    <div id="triviaGame">
      <p id="triviaQuestion" style="margin-bottom:1rem;font-style:italic">Question will appear here</p>
      <div id="triviaOptions" style="display:grid;gap:8px;grid-template-columns:1fr 1fr">
        <button class="btn ghost">Option 1</button>
        <button class="btn ghost">Option 2</button>
        <button class="btn ghost">Option 3</button>
        <button class="btn ghost">Option 4</button>
      </div>
      <p id="triviaScore" style="margin-top:1rem;font-weight:600">Score: 0/0</p>
    </div>
    <button class="btn" id="startTrivia" style="width:100%;margin-top:8px">Start Trivia</button>
  </div>
</div>

<!-- Settings Page -->
<div id="settings-page" class="page">
  <div class="card">
    <strong style="display:block;margin-bottom:1rem">Account Settings</strong>
    
    <div class="settings-item">
      <div>Notifications</div>
      <label class="switch">
        <input type="checkbox" checked>
        <span class="slider"></span>
      </label>
    </div>
    
    <div class="settings-item">
      <div>Message Preview</div>
      <label class="switch">
        <input type="checkbox" checked>
        <span class="slider"></span>
      </label>
    </div>
    
    <div class="settings-item">
      <div>Read Receipts</div>
      <label class="switch">
        <input type="checkbox" checked>
        <span class="slider"></span>
      </label>
    </div>
  </div>
  
  <div class="card">
    <strong style="display:block;margin-bottom:1rem">Privacy & Security</strong>
    
    <div class="settings-item">
      <div>Last Seen</div>
      <select class="input" style="width:auto;padding:.5rem .8rem">
        <option>Everyone</option>
        <option>My Contacts</option>
        <option>Nobody</option>
      </select>
    </div>
    
    <div class="settings-item">
      <div>Profile Photo</div>
      <select class="input" style="width:auto;padding:.5rem .8rem">
        <option>Everyone</option>
        <option>My Contacts</option>
        <option>Nobody</option>
      </select>
    </div>
    
    <div class="settings-item">
      <div>Two-Step Verification</div>
      <button class="btn ghost">Enable</button>
    </div>
  </div>
  
  <div class="card">
    <strong style="display:block;margin-bottom:1rem">Chat Settings</strong>
    
    <div class="settings-item">
      <div>Chat Background</div>
      <button class="btn ghost">Change</button>
    </div>
    
    <div class="settings-item">
      <div>Font Size</div>
      <select class="input" style="width:auto;padding:.5rem .8rem">
        <option>Small</option>
        <option selected>Medium</option>
        <option>Large</option>
      </select>
    </div>
    
    <div class="settings-item">
      <div>Enter Key Sends</div>
      <label class="switch">
        <input type="checkbox">
        <span class="slider"></span>
      </label>
    </div>
  </div>
  
  <div class="card">
    <strong style="display:block;margin-bottom:1rem">Storage & Data</strong>
    
    <div class="settings-item">
      <div>Network Usage</div>
      <div>1.2 GB</div>
    </div>
    
    <div class="settings-item">
      <div>Storage Usage</div>
      <div>2.5 GB</div>
    </div>
    
    <div class="settings-item">
      <div>Auto-Download Media</div>
      <button class="btn ghost">Configure</button>
    </div>
  </div>
  
  <div class="card">
    <strong style="display:block;margin-bottom:1rem">About</strong>
    
    <div class="settings-item">
      <div>Version</div>
      <div>2.1.0</div>
    </div>
    
    <div class="settings-item">
      <div>Privacy Policy</div>
      <button class="btn ghost">View</button>
    </div>
    
    <div class="settings-item">
      <div>Terms of Service</div>
      <button class="btn ghost">View</button>
    </div>
  </div>
</div>
</section>
</main>
</div>

<!-- Enhanced Toast area -->
<div id="toasts" style="position:fixed;left:50%;transform:translateX(-50%);bottom:100px;z-index:9999"></div>

<!-- Enhanced Context menu -->
<div id="contextMenu" class="context-menu hidden"></div>

<!-- Scroll to bottom button -->
<button id="scrollToBottom" class="scroll-to-bottom hidden" title="Scroll to bottom">‚Üì</button>

<!-- COMPLETE FIREBASE + ENHANCED LOGIC -->
<script type="module">
/* ========================== CONFIG ========================== */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';
import { getDatabase, ref, set, push, onValue, get, update, remove } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js';
import { getStorage, ref as sref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js';

const firebaseConfig = {
  apiKey: "AIzaSyDEOHYkQnyaeDbdVGisC2B2H02kxNfp3F8",
  authDomain: "meaww-chat-4f6bd.firebaseapp.com",
  databaseURL: "https://meaww-chat-4f6bd-default-rtdb.firebaseio.com",
  projectId: "meaww-chat-4f6bd",
  storageBucket: "meaww-chat-4f6bd.appspot.com",
  messagingSenderId: "162714330727",
  appId: "1:162714330727:dd1ce1da5806c0316c2",
  measurementId: "G-L7Y3NV8L88"
};

const adminEmail = "flashdc4178@gmail.com";

/* ========================== INIT ========================== */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const storage = getStorage(app);

/* ========================== HELPERS ========================== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

// Enhanced toast function
function toast(msg, t = 3000, type = 'info') {
  const d = document.createElement('div');
  d.className = 'toast';
  d.style.background = type === 'error' ? 'var(--danger)' : 
                      type === 'success' ? 'var(--success)' : 'var(--elev)';
  d.textContent = msg;
  $('#toasts').appendChild(d);
  setTimeout(() => {
    d.style.animation = 'toastSlide 0.3s ease-out reverse';
    setTimeout(() => d.remove(), 300);
  }, t);
}

function defaultAvatar(seed){
  return `https://api.dicebear.com/8.x/thumbs/svg?seed=${(seed||'quick').slice(0,8)}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
}

function timeAgo(ts){
  if(!ts) return '‚Äî';
  const d = Math.floor((Date.now()-ts)/1000);
  if(d<60) return d+'s';
  if(d<3600) return Math.floor(d/60)+'m';
  if(d<86400) return Math.floor(d/3600)+'h';
  return Math.floor(d/86400)+'d';
}

function typingRef(chatId, uid){
  return ref(db, `typing/${chatId}/${uid}`);
}

function pairKey(a,b){ return [a,b].sort().join('_'); }

/* ========================== VARIABLES ========================== */
let isAdminUser = false;
let me = null;
let currentChat = null;
let unsubMessages = null;
let typingTimer = null;
let pendingFile = null;
let lastSendAt = 0;
const SEND_COOLDOWN_MS = 1200;

// NEW: Available emojis for reactions
const EMOJIS = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üò°', 'üéâ', 'üî•'];

// NEW: Game state
let ticTacToeGame = {
  board: ['', '', '', '', '', '', '', '', ''],
  currentPlayer: 'X',
  gameActive: false,
  playerSymbol: 'X'
};

/* ========================== AUTH UI HANDLERS ========================== */
$('#loginBtn').onclick = async () => {
  try {
    await signInWithEmailAndPassword(auth, $('#loginEmail').value, $('#loginPass').value);
    $('#authMsg').textContent = '';
    toast('Welcome back!', 2000, 'success');
  } catch (e) { 
    $('#authMsg').textContent = e.message;
    toast('Login failed: ' + e.message, 3000, 'error');
  }
};

$('#registerBtn').onclick = async () => {
  try {
    const email = $('#loginEmail').value.trim();
    const pass = $('#loginPass').value;
    if(!email||!pass){ 
      $('#authMsg').textContent='Enter email & password'; 
      toast('Please enter email and password', 3000, 'error');
      return; 
    }
    if(pass.length < 6){ 
      $('#authMsg').textContent='Password must be at least 6 characters'; 
      toast('Password must be at least 6 characters', 3000, 'error');
      return; 
    }
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    const uid = cred.user.uid;
    const short = String(10000 + Math.floor(Math.random()*90000));
    await set(ref(db, 'users/' + uid), {
      uid,
      email,
      name: cred.user.displayName || email.split('@')[0],
      avatar: defaultAvatar(uid),
      shortId: short,
      createdAt: Date.now(),
      online: true,
      lastSeen: Date.now(),
      status: 'online'
    });
    await set(ref(db, 'shortIds/' + short), { uid });
    toast('Registration successful! Check profile to edit', 3000, 'success');
  } catch (e){ 
    $('#authMsg').textContent = e.message;
    toast('Registration failed: ' + e.message, 3000, 'error');
  }
};

$('#googleBtn').onclick = async () => {
  try {
    const prov = new GoogleAuthProvider();
    const cred = await signInWithPopup(auth, prov);
    const uid = cred.user.uid;
    const uref = ref(db, 'users/' + uid);
    const s = await get(uref);
    if(!s.exists()){
      const short = String(10000 + Math.floor(Math.random()*90000));
      await set(uref, {
        uid,
        email: cred.user.email,
        name: cred.user.displayName || cred.user.email,
        avatar: cred.user.photoURL || defaultAvatar(uid),
        shortId: short,
        createdAt: Date.now(),
        online: true,
        lastSeen: Date.now(),
        status: 'online'
      });
      await set(ref(db, 'shortIds/' + short), { uid });
    }
    toast('Signed in with Google!', 2000, 'success');
  } catch (e){ 
    $('#authMsg').textContent = e.message;
    toast('Google sign-in failed: ' + e.message, 3000, 'error');
  }
};

/* ========================== ADMIN UI + ACTIONS ========================== */
async function injectAdminPanel(){
  if(!isAdminUser) return;
  
  $('#adminLookupBtn').onclick = async () => {
    const v = $('#adminTarget').value.trim();
    if(!v){ toast('Enter UID or 5-digit ID', 3000, 'error'); return; }
    let uid = v;
    if(v.length === 5){
      const s = await get(ref(db, 'shortIds/' + v));
      if(!s.exists()){ toast('No such shortId', 3000, 'error'); return; }
      uid = s.val().uid;
    }
    const u = await get(ref(db, 'users/' + uid));
    if(!u.exists()){ toast('User not found', 3000, 'error'); return; }
    const data = u.val();
    toast('Found: ' + (data.name || data.email || uid), 3000, 'success');
  };

  $('#adminVerifyBtn').onclick = async () => {
    const v = $('#adminTarget').value.trim(); if(!v){ toast('Enter UID or 5-digit ID', 3000, 'error'); return; }
    let uid = v;
    if(v.length===5){
      const s = await get(ref(db,'shortIds/'+v));
      if(!s.exists()){ toast('No such shortId', 3000, 'error'); return; }
      uid = s.val().uid;
    }
    await update(ref(db, 'users/' + uid), { verified: true });
    toast('User verified', 2000, 'success');
    await refreshAdminUsers();
  };
  
  $('#adminUnverifyBtn').onclick = async ()=> {
    const v = $('#adminTarget').value.trim(); if(!v) return toast('Enter UID or 5-digit ID', 3000, 'error');
    let uid=v; if(v.length===5){ const s=await get(ref(db,'shortIds/'+v)); if(!s.exists()){ toast('No shortId', 3000, 'error'); return; } uid=s.val().uid; }
    await update(ref(db,'users/'+uid), { verified: false });
    toast('User unverified', 2000, 'success'); 
    await refreshAdminUsers();
  };
  
  $('#adminBanBtn').onclick = async () => {
    const v = $('#adminTarget').value.trim(); if(!v) return toast('Enter UID or 5-digit ID', 3000, 'error'); 
    let uid=v; if(v.length===5){ const s=await get(ref(db,'shortIds/'+v)); if(!s.exists()){ toast('No shortId', 3000, 'error'); return; } uid=s.val().uid; }
    await set(ref(db,'banned/'+uid), true); 
    toast('User banned', 2000, 'success'); 
    await refreshAdminUsers();
  };
  
  $('#adminUnbanBtn').onclick = async () => {
    const v = $('#adminTarget').value.trim(); if(!v) return toast('Enter UID or 5-digit ID', 3000, 'error'); 
    let uid=v; if(v.length===5){ const s=await get(ref(db,'shortIds/'+v)); if(!s.exists()){ toast('No shortId', 3000, 'error'); return; } uid=s.val().uid; }
    await remove(ref(db,'banned/'+uid)); 
    toast('User unbanned', 2000, 'success'); 
    await refreshAdminUsers();
  };
  
  $('#adminDelMsgBtn').onclick = async () => {
    const chatId = $('#adminChatId').value.trim(); 
    const msgKey = $('#adminMsgKey').value.trim();
    if(!chatId || !msgKey){ toast('Enter chat id and message key', 3000, 'error'); return; }
    await remove(ref(db, `chats/${chatId}/messages/${msgKey}`));
    await remove(ref(db, `communityMessages/${chatId}/${msgKey}`));
    toast('Message removed (if existed)', 2000, 'success');
  };
  
  $('#adminRefreshUsers').onclick = refreshAdminUsers;

  $('#adminAnnSet').onclick = async ()=>{
    const t = $('#adminAnnText').value.trim();
    await set(ref(db, 'announcements/global'), { text: t, ts: Date.now(), by: me.uid });
    toast('Announcement set', 2000, 'success');
  };
  
  $('#adminAnnClear').onclick = async ()=>{
    await remove(ref(db, 'announcements/global'));
    toast('Announcement cleared', 2000, 'success');
  };

  await refreshAdminUsers();
}

async function refreshAdminUsers(){
  const wrap = $('#adminUsersList'); wrap.innerHTML = '';
  const s = await get(ref(db, 'users'));
  if(!s.exists()){ wrap.textContent = 'No users yet'; return; }
  const users = s.val();
  for(const uid in users){
    const u = users[uid];
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `
      <img src="${u.avatar||defaultAvatar(uid)}" class="avatar" />
      <div style="flex:1">
        <div style="font-weight:700">${u.name || u.email || uid}</div>
        <div style="color:var(--muted);font-size:.85rem">${u.email||''} - ${u.shortId||''} - ${u.verified? '‚úÖ verified':''}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="btn ghost" data-uid="${uid}" data-action="verify">Verify</button>
        <button class="btn ghost" data-uid="${uid}" data-action="ban">Ban</button>
      </div>
    `;
    wrap.appendChild(div);
  }
  wrap.querySelectorAll('button[data-action]').forEach(b=>{
    b.onclick = async ()=>{
      const uid = b.dataset.uid; const action = b.dataset.action;
      if(action==='verify'){ await update(ref(db,'users/'+uid), { verified: true }); toast('Verified', 2000, 'success'); }
      if(action==='ban'){ await set(ref(db,'banned/'+uid), true); toast('Banned', 2000, 'success'); }
      await refreshAdminUsers();
    };
  });
}

/* ========================== BAN CHECK ========================== */
async function isBanned(uid){
  const s = await get(ref(db, 'banned/' + uid));
  return s.exists();
}

/* ========================== APP CORE ========================== */
function roomIdFor(a,b){ return [a,b].sort().join('_'); }

async function getUnreadCount(chatId){
  const readsSnap = await get(ref(db, `reads/${chatId}`));
  if(!readsSnap.exists()) return 0;
  const reads = readsSnap.val();
  let count = 0;
  for(const mk in reads){
    if(!reads[mk] || !reads[mk][me.uid]) count++;
  }
  return count;
}

async function refreshFriends(){
  if(!me) return;
  const wrap = $('#friendsList'); wrap.innerHTML = '';
  const s = await get(ref(db, 'friends/' + me.uid));
  const ids = s.exists()? Object.keys(s.val()): [];
  for(const fid of ids){
    const uSnap = await get(ref(db, 'users/' + fid));
    const u = uSnap.val(); if(!u) continue;
    const id = roomIdFor(me.uid, u.uid);
    const unread = await getUnreadCount(id);
    const it = document.createElement('div'); it.className = 'item';
    it.innerHTML = `<img class="avatar" src="${u.avatar||defaultAvatar(u.uid)}" />
      <div style="flex:1">
        <div style="font-weight:700;display:flex;justify-content:space-between;align-items:center">
          <span>${u.name||u.email}</span>
          ${unread>0? `<span style="background:#1b3d74;color:#dfefff;font-size:.75rem;padding:2px 8px;border-radius:999px">${unread}</span>`:''}
        </div>
        <div style="color:var(--muted);font-size:.85rem">
          <span class="status-indicator status-${u.status || (u.online ? 'online' : 'offline')}"></span>
          ${u.status === 'online' ? 'online' : u.status === 'away' ? 'away' : u.status === 'busy' ? 'busy' : 'last '+timeAgo(u.lastSeen)}
        </div>
      </div>`;
    it.onclick = ()=> openDM(u);
    wrap.appendChild(it);
  }
}

async function loadCommunities(){
  const wrap = $('#communitiesList'); wrap.innerHTML = '';
  const cs = await get(ref(db, 'communities'));
  if(!cs.exists()) return;
  const data = cs.val();
  for(const id in data){
    const c = data[id];
    const unread = await getUnreadCount(c.id);
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div style="flex:1">
        <div style="font-weight:700;display:flex;justify-content:space-between;align-items:center">
          <span>${c.name}</span>
          ${unread>0? `<span style="background:#1b3d74;color:#dfefff;font-size:.75rem;padding:2px 8px;border-radius:999px">${unread}</span>`:''}
        </div>
        <div style="color:var(--muted)">${c.id}</div></div>
      <button class="btn ghost">Open</button>`;
    it.querySelector('button').onclick = ()=> openGroup(c);
    wrap.appendChild(it);
  }
}

function openChatPanel(peer){
  currentChat = peer;
  $('#chatTitle').textContent = peer.name || peer.id || 'Chat';
  $('#chatAvatar').src = peer.avatar || defaultAvatar(peer.uid || peer.id);
  $('#messages').innerHTML = '';
}

const chatBackBtn = $('#chatBackBtn');
chatBackBtn.onclick = () => {
  document.getElementById('appUI').classList.remove('fullscreen-chat');
  chatBackBtn.style.display = 'none';
  currentChat = null;
  $('#chatTitle').textContent = 'No chat';
  $('#chatAvatar').src = '';
  $('#messages').innerHTML = '';
};

async function openDM(u){
  openChatPanel(u);
  document.getElementById('appUI').classList.add('fullscreen-chat');
  chatBackBtn.style.display = 'inline-block';
  const id = roomIdFor(me.uid, u.uid);
  subscribeMessages('chats/' + id + '/messages', id, 'dm', u);
}

async function openGroup(c){
  openChatPanel(c);
  document.getElementById('appUI').classList.remove('fullscreen-chat');
  chatBackBtn.style.display = 'none';
  subscribeMessages('communityMessages/' + c.id, c.id, 'group', c);
}

// NEW: Show reaction picker
function showReactionPicker(messageKey, chatId, buttonElement) {
  const picker = document.createElement('div');
  picker.className = 'reaction-picker';
  
  EMOJIS.forEach(emoji => {
    const emojiEl = document.createElement('div');
    emojiEl.className = 'reaction-emoji';
    emojiEl.textContent = emoji;
    emojiEl.onclick = () => {
      addReactionToMessage(messageKey, chatId, emoji);
      picker.remove();
    };
    picker.appendChild(emojiEl);
  });
  
  const rect = buttonElement.getBoundingClientRect();
  picker.style.top = (rect.top - 50) + 'px';
  picker.style.left = rect.left + 'px';
  
  document.body.appendChild(picker);
  
  // Close picker when clicking outside
  setTimeout(() => {
    const closePicker = (e) => {
      if (!picker.contains(e.target) && e.target !== buttonElement) {
        picker.remove();
        document.removeEventListener('click', closePicker);
      }
    };
    document.addEventListener('click', closePicker);
  }, 100);
}

// NEW: Add reaction to message
async function addReactionToMessage(messageKey, chatId, reaction) {
  const basePath = currentChat.uid 
    ? `chats/${chatId}/messages/${messageKey}/reactions/${reaction}/${me.uid}`
    : `communityMessages/${chatId}/messages/${messageKey}/reactions/${reaction}/${me.uid}`;
  
  // Toggle reaction
  const reactionRef = ref(db, basePath);
  const snap = await get(reactionRef);
  
  if (snap.exists()) {
    await remove(reactionRef);
  } else {
    await set(reactionRef, true);
  }
}

// NEW: Show context menu for messages
function showMessageContextMenu(e, message, messageKey, chatId) {
  e.preventDefault();
  
  const contextMenu = $('#contextMenu');
  contextMenu.innerHTML = '';
  contextMenu.classList.remove('hidden');
  
  contextMenu.style.left = e.pageX + 'px';
  contextMenu.style.top = e.pageY + 'px';
  
  // Add reaction option
  const reactOption = document.createElement('div');
  reactOption.className = 'context-menu-item';
  reactOption.textContent = 'Add Reaction';
  reactOption.onclick = () => {
    showReactionPicker(messageKey, chatId, reactOption);
    contextMenu.classList.add('hidden');
  };
  contextMenu.appendChild(reactOption);
  
  // Add reply option
  const replyOption = document.createElement('div');
  replyOption.className = 'context-menu-item';
  replyOption.textContent = 'Reply';
  replyOption.onclick = () => {
    $('#msgInput').value = `@${message.fromName} `;
    $('#msgInput').focus();
    contextMenu.classList.add('hidden');
  };
  contextMenu.appendChild(replyOption);
  
  // Add pin option for admins
  if (isAdminUser) {
    const pinOption = document.createElement('div');
    pinOption.className = 'context-menu-item';
    pinOption.textContent = message.pinned ? 'Unpin Message' : 'Pin Message';
    pinOption.onclick = async () => {
      const basePath = currentChat.uid 
        ? `chats/${chatId}/messages/${messageKey}`
        : `communityMessages/${chatId}/messages/${messageKey}`;
      
      await update(ref(db, basePath), { pinned: !message.pinned });
      contextMenu.classList.add('hidden');
    };
    contextMenu.appendChild(pinOption);
  }
  
  // Close menu when clicking outside
  setTimeout(() => {
    const closeMenu = (e) => {
      if (!contextMenu.contains(e.target)) {
        contextMenu.classList.add('hidden');
        document.removeEventListener('click', closeMenu);
      }
    };
    document.addEventListener('click', closeMenu);
  }, 100);
}

function subscribeMessages(path, chatId, kind, peer){
  if(unsubMessages) unsubMessages();
  const r = ref(db, path);
  onValue(r, async snap => {
    const data = snap.val() || {};
    $('#messages').innerHTML = '';
    const entries = Object.entries(data).sort((a,b)=>a[1].ts - b[1].ts);

    // NEW: Check for pinned messages
    let pinnedMessages = [];
    let regularMessages = [];

    for(const [key,m] of entries){
      if (m.pinned) {
        pinnedMessages.push([key, m]);
      } else {
        regularMessages.push([key, m]);
      }
    }

    // Display pinned messages first
    if (pinnedMessages.length > 0) {
      const pinnedHeader = document.createElement('div');
      pinnedHeader.textContent = 'üìå Pinned Messages';
      pinnedHeader.style.color = 'var(--muted)';
      pinnedHeader.style.marginBottom = '8px';
      $('#messages').appendChild(pinnedHeader);
      
      for(const [key,m] of pinnedMessages){
        renderMessage(key, m, chatId);
      }
      
      const divider = document.createElement('div');
      divider.style.borderTop = '1px solid var(--border)';
      divider.style.margin = '12px 0';
      $('#messages').appendChild(divider);
    }

    // Display regular messages
    for(const [key,m] of regularMessages){
      renderMessage(key, m, chatId);
    }

    $('#messages').scrollTop = $('#messages').scrollHeight;
  });

  // NEW: Typing observer
  const tRef = ref(db, `typing/${chatId}`);
  const offTyping = onValue(tRef, snap=>{
    const obj = snap.val() || {};
    const someoneElseTyping = Object.keys(obj).some(uid => uid !== me.uid && obj[uid] === true);
    $('#typingIndicator').style.display = someoneElseTyping ? 'block' : 'none';
  });

  unsubMessages = ()=>{
    offTyping();
  };
}

// Enhanced render message function
async function renderMessage(key, m, chatId) {
  const div = document.createElement('div'); 
  div.className = `message-item ${m.from === me.uid ? 'own' : 'other'}`;
  div.setAttribute('data-message-id', key);
  
  // Add new message animation
  setTimeout(() => {
    div.classList.add('new-message');
  }, 100);

  // Add pinned class if message is pinned
  if (m.pinned) {
    div.classList.add('pinned-message');
  }
  
  div.innerHTML = `
    <img class="avatar" src="${m.fromAvatar || defaultAvatar(m.from)}" />
    <div class="message-content">
      <div class="message-sender">
        ${m.pinned ? '<span class="pin-indicator">üìå</span>' : ''}
        ${m.fromName||''}
        ${m.editedAt?'<span style="color:var(--muted);font-size:.75rem"> - edited</span>':''}
      </div>
      <div class="message-text">${m.text||''}</div>
      ${m.replyTo ? '<div style="color:var(--muted);font-size:.85rem;border-left:2px solid var(--brand);padding-left:8px;margin:4px 0">‚Ü™Ô∏è ' + (m.replyToText || 'Replied to a message') + '</div>' : ''}
      <div class="message-time">${new Date(m.ts).toLocaleTimeString()}</div>
    </div>`;
  
  // Add image if exists
  if(m.imageURL){
    const imgContainer = document.createElement('div');
    imgContainer.className = 'file-preview';
    
    const img = document.createElement('img');
    img.src = m.imageURL;
    img.style.cursor = 'pointer';
    img.onclick = () => window.open(m.imageURL, '_blank');
    
    const fileInfo = document.createElement('div');
    fileInfo.className = 'file-info';
    fileInfo.textContent = 'Click to view full image';
    
    imgContainer.appendChild(img);
    imgContainer.appendChild(fileInfo);
    div.querySelector('.message-content').appendChild(imgContainer);
  }
  
  // Add audio player if audio exists
  if(m.audioURL){
    const audioContainer = document.createElement('div');
    audioContainer.className = 'voice-message';
    
    const playBtn = document.createElement('button');
    playBtn.className = 'voice-play-btn';
    playBtn.innerHTML = '‚ñ∂';
    
    const progress = document.createElement('div');
    progress.className = 'voice-progress';
    
    const progressBar = document.createElement('div');
    progressBar.className = 'voice-progress-bar';
    
    const duration = document.createElement('div');
    duration.className = 'voice-duration';
    duration.textContent = m.audioDuration ? formatDuration(m.audioDuration) : '0:00';
    
    progress.appendChild(progressBar);
    audioContainer.appendChild(playBtn);
    audioContainer.appendChild(progress);
    audioContainer.appendChild(duration);
    
    // Audio player functionality
    let audio = new Audio(m.audioURL);
    audio.addEventListener('loadedmetadata', () => {
      if (!m.audioDuration) {
        duration.textContent = formatDuration(audio.duration);
      }
    });
    
    audio.addEventListener('timeupdate', () => {
      const percent = (audio.currentTime / audio.duration) * 100;
      progressBar.style.width = percent + '%';
    });
    
    audio.addEventListener('ended', () => {
      playBtn.innerHTML = '‚ñ∂';
      progressBar.style.width = '0%';
      audio.currentTime = 0;
    });
    
    playBtn.onclick = () => {
      if (audio.paused) {
        audio.play();
        playBtn.innerHTML = '‚è∏';
      } else {
        audio.pause();
        playBtn.innerHTML = '‚ñ∂';
      }
    };
    
    div.querySelector('.message-content').appendChild(audioContainer);
  }
  
  // NEW: Add message reactions if they exist
  if (m.reactions) {
    const reactionContainer = document.createElement('div');
    reactionContainer.className = 'reaction-container';
    
    for (const [emoji, users] of Object.entries(m.reactions)) {
      const count = Object.keys(users || {}).length;
      if (count > 0) {
        const reactionBtn = document.createElement('div');
        reactionBtn.className = 'reaction';
        reactionBtn.innerHTML = `${emoji} ${count}`;
        reactionBtn.onclick = () => addReactionToMessage(key, chatId, emoji);
        reactionContainer.appendChild(reactionBtn);
      }
    }
    
    if (reactionContainer.children.length > 0) {
      div.querySelector('.message-content').appendChild(reactionContainer);
    }
  }
  
  // Add action buttons for user's own messages
  if(m.from === me.uid){
    const row = document.createElement('div');
    row.style.display='flex'; row.style.gap='6px'; row.style.marginTop='6px';
    
    const delBtn = document.createElement('button');
    delBtn.className = 'btn ghost'; delBtn.textContent = 'Delete';
    delBtn.onclick = async ()=>{
      const basePath = currentChat.uid ? `chats/${chatId}/messages/${key}` : `communityMessages/${chatId}/${key}`;
      await remove(ref(db, basePath));
      toast('Message deleted', 2000, 'success');
    };
    row.appendChild(delBtn);
    
    const EDIT_WINDOW_MS = 120000;
    if(Date.now() - m.ts <= EDIT_WINDOW_MS){
      const editBtn = document.createElement('button');
      editBtn.className = 'btn ghost'; editBtn.textContent = 'Edit';
      editBtn.onclick = async ()=>{
        const newText = prompt('Edit message:', m.text||'');
        if(newText===null) return;
        const basePath = currentChat.uid ? `chats/${chatId}/messages/${key}` : `communityMessages/${chatId}/${key}`;
        await update(ref(db, basePath), { text: newText, editedAt: Date.now() });
        toast('Message edited', 2000, 'success');
      };
      row.appendChild(editBtn);
      
      const reactBtn = document.createElement('button');
      reactBtn.className = 'btn ghost'; reactBtn.textContent = 'React';
      reactBtn.onclick = () => showReactionPicker(key, chatId, reactBtn);
      row.appendChild(reactBtn);
    }
    
    div.querySelector('.message-content').appendChild(row);
  }
  
  // Add context menu on right-click
  div.addEventListener('contextmenu', (e) => {
    showMessageContextMenu(e, m, key, chatId);
  });
  
  // read-by badge
  const readsSnap = await get(ref(db, `reads/${chatId}/${key}`));
  if(readsSnap.exists()){
    const readers = Object.keys(readsSnap.val() || {});
    if(readers.length){
      const readBadge = document.createElement('div');
      readBadge.style.color='var(--muted)'; readBadge.style.fontSize='.7rem'; readBadge.style.marginTop='4px';
      readBadge.textContent = `Read by ${readers.length}`;
      div.querySelector('.message-content').appendChild(readBadge);
    }
  }
  
  $('#messages').appendChild(div);
  
  // Mark as read if not sender
  if(m.from !== me.uid){
    await set(ref(db, `reads/${chatId}/${key}/${me.uid}`), true);
  }
}

// NEW: Format duration for audio messages
function formatDuration(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

$('#msgInput').addEventListener('input', async ()=>{
  if(!currentChat || !me) return;
  const chatId = currentChat.uid ? roomIdFor(me.uid, currentChat.uid) : currentChat.id;
  try{
    await set(typingRef(chatId, me.uid), true);
  }catch{}
  if(typingTimer) clearTimeout(typingTimer);
  typingTimer = setTimeout(async ()=>{
    try{ await remove(typingRef(chatId, me.uid)); }catch{}
  }, 1800);
});

$('#attachBtn').onclick = ()=> $('#fileInput').click();
$('#fileInput').onchange = (e)=> {
  pendingFile = e.target.files && e.target.files[0] ? e.target.files[0] : null;
  if(pendingFile) toast('File selected: '+pendingFile.name, 2000, 'success');
};

$('#sendBtn').onclick = async () => {
  const now = Date.now();
  if(now - lastSendAt < SEND_COOLDOWN_MS){ toast('Slow down a bit‚Ä¶', 2000, 'warning'); return; }
  lastSendAt = now;

  const text = $('#msgInput').value.trim();
  if(!currentChat || (!text && !pendingFile)) return;

  let imageURL = null;
  let audioURL = null;
  let audioDuration = null;
  const chatId = currentChat.uid ? roomIdFor(me.uid, currentChat.uid) : currentChat.id;

  if(pendingFile){
    try {
      // Check if it's an audio file
      if (pendingFile.type.startsWith('audio/')) {
        const filePath = `uploads/${me.uid}/${chatId}/audio/${Date.now()}_${pendingFile.name}`;
        const sr = sref(storage, filePath);
        await uploadBytes(sr, pendingFile);
        audioURL = await getDownloadURL(sr);
        
        // Get audio duration
        const audio = new Audio();
        audio.src = URL.createObjectURL(pendingFile);
        await new Promise(resolve => {
          audio.addEventListener('loadedmetadata', () => {
            audioDuration = audio.duration;
            resolve();
          });
        });
      } else {
        // Handle image or other files
        const filePath = `uploads/${me.uid}/${chatId}/${Date.now()}_${pendingFile.name}`;
        const sr = sref(storage, filePath);
        await uploadBytes(sr, pendingFile);
        imageURL = await getDownloadURL(sr);
      }
    } catch(e) {
      toast('Upload failed: ' + e.message, 3000, 'error');
      console.error(e);
    }
  }

  const payload = { 
    from: me.uid, 
    fromName: me.name, 
    fromAvatar: me.avatar,
    text: text || '', 
    ts: Date.now(), 
    imageURL: imageURL || null,
    audioURL: audioURL || null,
    audioDuration: audioDuration || null
  };
  const key = push(ref(db)).key;

  if(currentChat.uid){
    await set(ref(db, `chats/${chatId}/messages/${key}`), payload);
    await set(ref(db, `reads/${chatId}/${key}/${me.uid}`), true);
    try { await remove(typingRef(chatId, me.uid)); } catch(_) {}
  } else if(currentChat.id){
    await set(ref(db, `communityMessages/${chatId}/messages/${key}`), payload);
    await set(ref(db, `reads/${chatId}/${key}/${me.uid}`), true);
    try { await remove(typingRef(chatId, me.uid)); } catch(_) {}
  }

  $('#msgInput').value = '';
  if(pendingFile){ pendingFile = null; $('#fileInput').value=''; toast('Message sent!', 2000, 'success'); }
};

// NEW: Message search functionality
$('#messageSearch').addEventListener('input', async (e) => {
  const query = e.target.value.trim().toLowerCase();
  const resultsContainer = $('#searchResults');
  
  if (query.length < 2) {
    resultsContainer.style.display = 'none';
    return;
  }
  
  if (!currentChat) return;
  
  const chatId = currentChat.uid ? roomIdFor(me.uid, currentChat.uid) : currentChat.id;
  const path = currentChat.uid ? `chats/${chatId}/messages` : `communityMessages/${chatId}/messages`;
  
  const messagesSnap = await get(ref(db, path));
  if (!messagesSnap.exists()) {
    resultsContainer.style.display = 'none';
    return;
  }
  
  const messages = messagesSnap.val();
  resultsContainer.innerHTML = '';
  resultsContainer.style.display = 'block';
  
  let foundResults = false;
  
  for (const [key, message] of Object.entries(messages)) {
    if (message.text && message.text.toLowerCase().includes(query)) {
      foundResults = true;
      const resultItem = document.createElement('div');
      resultItem.className = 'search-result-item';
      resultItem.innerHTML = `
        <div style="font-weight:700">${message.fromName}</div>
        <div>${message.text}</div>
        <div style="color:var(--muted);font-size:.8rem">${new Date(message.ts).toLocaleString()}</div>
      `;
      
      resultItem.onclick = () => {
        // Scroll to message
        const messageElement = $(`[data-message-id="${key}"]`);
        if (messageElement) {
          messageElement.scrollIntoView({ behavior: 'smooth' });
          messageElement.style.backgroundColor = '#1b3d74';
          setTimeout(() => {
            messageElement.style.backgroundColor = '';
          }, 2000);
        }
        resultsContainer.style.display = 'none';
        $('#messageSearch').value = '';
      };
      
      resultsContainer.appendChild(resultItem);
    }
  }
  
  if (!foundResults) {
    resultsContainer.innerHTML = '<div class="search-result-item">No results found</div>';
  }
});

// Close search results when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('.search-container')) {
    $('#searchResults').style.display = 'none';
  }
});

/* ========================== FRIEND REQUESTS ========================== */
async function sendFriendRequestByShortId(shortId){
  $('#friendRequestMsg').textContent = '';
  if(!me) return toast('Sign in first', 3000, 'error');
  const v = (shortId||'').trim();
  if(v.length !== 5) { $('#friendRequestMsg').textContent = 'Enter a valid 5-digit ID'; toast('Enter a valid 5-digit ID', 3000, 'error'); return; }

  // Lookup target UID
  const shortSnap = await get(ref(db, 'shortIds/' + v));
  if(!shortSnap.exists()){ $('#friendRequestMsg').textContent = 'No user with that ID'; toast('No user with that ID', 3000, 'error'); return; }
  const targetUid = shortSnap.val().uid;

  if(targetUid === me.uid){ $('#friendRequestMsg').textContent = 'Cannot add yourself'; toast('Cannot add yourself', 3000, 'error'); return; }

  // Already friends?
  const already = await get(ref(db, `friends/${me.uid}/${targetUid}`));
  if(already.exists()){ $('#friendRequestMsg').textContent = 'Already friends'; toast('Already friends', 3000, 'info'); return; }

  // Pair guard
  const pk = pairKey(me.uid, targetUid);
  const pairSnap = await get(ref(db, `requestPairs/${pk}`));
  if(pairSnap.exists()){ $('#friendRequestMsg').textContent = 'Request already pending'; toast('Request already pending', 3000, 'info'); return; }

  // Compose target user display
  const targetUserSnap = await get(ref(db, 'users/' + targetUid));
  const targetUser = targetUserSnap.val() || {};
  const reqId = push(ref(db, 'friendRequests/_tmp')).key;
  const now = Date.now();

  // Write outgoing for me
  await set(ref(db, `friendRequests/${me.uid}/outgoing/${reqId}`), {
    toUid: targetUid,
    toName: targetUser.name || targetUser.email || targetUid,
    toAvatar: targetUser.avatar || '',
    ts: now
  });

  // Write incoming for target
  await set(ref(db, `friendRequests/${targetUid}/incoming/${reqId}`), {
    fromUid: me.uid,
    fromName: me.name || me.email || me.uid,
    fromAvatar: me.avatar || '',
    ts: now
  });

  // Mark pair as pending
  await set(ref(db, `requestPairs/${pk}`), true);

  $('#friendRequestMsg').textContent = 'Request sent';
  toast('Friend request sent!', 3000, 'success');
  await loadFriendRequests();
}

async function acceptFriendRequest(reqId, fromUid){
  if(!me) return;
  const pk = pairKey(me.uid, fromUid);

  // Add both sides as friends
  await set(ref(db, `friends/${me.uid}/${fromUid}`), true);
  await set(ref(db, `friends/${fromUid}/${me.uid}`), true);

  // Remove request entries
  await remove(ref(db, `friendRequests/${me.uid}/incoming/${reqId}`));
  await remove(ref(db, `friendRequests/${fromUid}/outgoing/${reqId}`));
  await remove(ref(db, `requestPairs/${pk}`));

  toast('Friend added!', 2000, 'success');
  await refreshFriends();
  await loadFriendRequests();
}

async function declineFriendRequest(reqId, fromUid){
  if(!me) return;
  const pk = pairKey(me.uid, fromUid);

  await remove(ref(db, `friendRequests/${me.uid}/incoming/${reqId}`));
  await remove(ref(db, `friendRequests/${fromUid}/outgoing/${reqId}`));
  await remove(ref(db, `requestPairs/${pk}`));

  toast('Request declined', 2000, 'info');
  await loadFriendRequests();
}

async function cancelFriendRequest(reqId, toUid){
  if(!me) return;
  const pk = pairKey(me.uid, toUid);

  await remove(ref(db, `friendRequests/${me.uid}/outgoing/${reqId}`));
  await remove(ref(db, `friendRequests/${toUid}/incoming/${reqId}`));
  await remove(ref(db, `requestPairs/${pk}`));

  toast('Request canceled', 2000, 'info');
  await loadFriendRequests();
}

async function loadFriendRequests(){
  if(!me) return;
  const incomingWrap = $('#incomingReqs');
  const outgoingWrap = $('#outgoingReqs');
  incomingWrap.innerHTML = '';
  outgoingWrap.innerHTML = '';

  const inSnap = await get(ref(db, `friendRequests/${me.uid}/incoming`));
  const outSnap = await get(ref(db, `friendRequests/${me.uid}/outgoing`));
  const incoming = inSnap.val() || {};
  const outgoing = outSnap.val() || {};

  // Incoming
  for(const reqId in incoming){
    const r = incoming[reqId];
    const it = document.createElement('div'); it.className = 'item';
    it.innerHTML = `
      <img class="avatar" src="${r.fromAvatar || defaultAvatar(r.fromUid)}" />
      <div style="flex:1">
        <div style="font-weight:700">${r.fromName || r.fromUid}</div>
        <div style="color:var(--muted);font-size:.85rem">${timeAgo(r.ts)} ago</div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn">Accept</button>
        <button class="btn ghost">Decline</button>
      </div>
    `;
    const [acceptBtn, declineBtn] = it.querySelectorAll('button');
    acceptBtn.onclick = ()=> acceptFriendRequest(reqId, r.fromUid);
    declineBtn.onclick = ()=> declineFriendRequest(reqId, r.fromUid);
    incomingWrap.appendChild(it);
  }

  // Outgoing
  for(const reqId in outgoing){
    const r = outgoing[reqId];
    const it = document.createElement('div'); it.className = 'item';
    it.innerHTML = `
      <img class="avatar" src="${r.toAvatar || defaultAvatar(r.toUid)}" />
      <div style="flex:1">
        <div style="font-weight:700">${r.toName || r.toUid}</div>
        <div style="color:var(--muted);font-size:.85rem">Pending - ${timeAgo(r.ts)} ago</div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn ghost">Cancel</button>
      </div>
    `;
    const cancelBtn = it.querySelector('button');
    cancelBtn.onclick = ()=> cancelFriendRequest(reqId, r.toUid);
    outgoingWrap.appendChild(it);
  }
}

/* ========================== PRESENCE ========================== */
async function setPresence(uid){
  await update(ref(db, 'users/' + uid), { online: true, lastSeen: Date.now() });
}

window.addEventListener('beforeunload', () => {
  if(me && me.uid){
    navigator.sendBeacon(
      `https://meaww-chat-4f6bd-default-rtdb.firebaseio.com/users/${me.uid}.json`,
      JSON.stringify({ online:false, lastSeen: Date.now() })
    );
  }
});

document.addEventListener('visibilitychange', async () => {
  if(!me) return;
  if(document.hidden) {
    await update(ref(db,'users/'+me.uid), { online:false, lastSeen: Date.now() });
  } else {
    await update(ref(db,'users/'+me.uid), { online:true, lastSeen: Date.now() });
  }
});

/* ========================== NEW: GAME FUNCTIONS ========================== */
function initializeTicTacToe() {
  const cells = $$('.ttt-cell');
  cells.forEach(cell => {
    cell.textContent = '';
    cell.classList.remove('x', 'o');
    cell.addEventListener('click', handleTicTacToeClick);
  });
  
  ticTacToeGame = {
    board: ['', '', '', '', '', '', '', '', ''],
    currentPlayer: 'X',
    gameActive: true,
    playerSymbol: 'X'
  };
  
  $('#gameStatus').textContent = 'Your turn (X)';
  toast('Tic Tac Toe game started!', 2000, 'success');
}

function handleTicTacToeClick(e) {
  const cell = e.target;
  const index = parseInt(cell.dataset.index);
  
  if (ticTacToeGame.board[index] !== '' || !ticTacToeGame.gameActive) {
    return;
  }
  
  // Make move
  ticTacToeGame.board[index] = ticTacToeGame.currentPlayer;
  cell.textContent = ticTacToeGame.currentPlayer;
  cell.classList.add(ticTacToeGame.currentPlayer.toLowerCase());
  
  // Check for win or draw
  if (checkWin()) {
    $('#gameStatus').textContent = `Player ${ticTacToeGame.currentPlayer} wins!`;
    ticTacToeGame.gameActive = false;
    toast(`Player ${ticTacToeGame.currentPlayer} wins!`, 3000, 'success');
    return;
  }
  
  if (checkDraw()) {
    $('#gameStatus').textContent = 'Game ended in a draw!';
    ticTacToeGame.gameActive = false;
    toast('Game ended in a draw!', 3000, 'info');
    return;
  }
  
  // Switch player
  ticTacToeGame.currentPlayer = ticTacToeGame.currentPlayer === 'X' ? 'O' : 'X';
  $('#gameStatus').textContent = `Player ${ticTacToeGame.currentPlayer}'s turn`;
}

function checkWin() {
  const winPatterns = [
    [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
    [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
    [0, 4, 8], [2, 4, 6]             // diagonals
  ];
  
  return winPatterns.some(pattern => {
    const [a, b, c] = pattern;
    return ticTacToeGame.board[a] !== '' && 
           ticTacToeGame.board[a] === ticTacToeGame.board[b] && 
           ticTacToeGame.board[a] === ticTacToeGame.board[c];
  });
}

function checkDraw() {
  return ticTacToeGame.board.every(cell => cell !== '');
}

/* ========================== NEW: NAVIGATION ========================== */
function setupNavigation() {
  const navItems = $$('.nav-item');
  const pages = $$('.page');
  
  navItems.forEach(item => {
    item.addEventListener('click', () => {
      const targetPage = item.dataset.page;
      
      // Update active nav item with animation
      navItems.forEach(nav => {
        nav.classList.remove('active');
        nav.style.transform = 'translateY(0)';
      });
      item.classList.add('active');
      
      // Show target page with fade animation, hide others
      pages.forEach(page => {
        if (page.id === targetPage) {
          page.style.display = 'block';
          setTimeout(() => page.classList.add('active'), 10);
        } else {
          page.classList.remove('active');
          setTimeout(() => page.style.display = 'none', 300);
        }
      });
    });
  });
}

// Scroll to bottom functionality
function setupScrollToBottom() {
  const messagesContainer = $('#messages');
  const scrollButton = $('#scrollToBottom');
  
  if (messagesContainer && scrollButton) {
    messagesContainer.addEventListener('scroll', () => {
      const isAtBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop <= messagesContainer.clientHeight + 100;
      scrollButton.classList.toggle('hidden', isAtBottom);
    });
    
    scrollButton.addEventListener('click', () => {
      messagesContainer.scrollTo({
        top: messagesContainer.scrollHeight,
        behavior: 'smooth'
      });
    });
  }
}

// Initialize enhanced features when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  setupScrollToBottom();
  
  // Add enter key to send message
  $('#msgInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      $('#sendBtn').click();
    }
  });
});

/* ========================== ON AUTH CHANGE ========================== */
onAuthStateChanged(auth, async (user) => {
  if(!user){
    $('#auth').classList.remove('hidden');
    $('#appUI').classList.add('hidden');
    isAdminUser = false;
    me = null;
    document.getElementById('profileAdminPanel').style.display = 'none';
    return;
  }

  const bannedSnap = await get(ref(db, 'banned/' + user.uid));
  if(bannedSnap.exists()){
    toast('Your account is banned. Signing out.', 4000, 'error');
    await signOut(auth);
    return;
  }

  const uref = ref(db, 'users/' + user.uid);
  const s = await get(uref);
  if(!s.exists()){
    const short = String(10000 + Math.floor(Math.random()*90000));
    await set(uref, {
      uid: user.uid,
      email: user.email,
      name: user.displayName || user.email.split('@')[0],
      avatar: user.photoURL || defaultAvatar(user.uid),
      shortId: short,
      createdAt: Date.now(),
      online: true,
      lastSeen: Date.now(),
      status: 'online'
    });
    await set(ref(db, 'shortIds/' + short), { uid: user.uid });
  } else {
    const data = s.val();
    const upd = { online: true, lastSeen: Date.now() };
    if(!data.avatar) upd.avatar = defaultAvatar(user.uid);
    if(!data.status) upd.status = 'online';
    await update(uref, upd);
  }

  me = (await get(uref)).val();

  $('#navAvatar').src = me.avatar || defaultAvatar(me.uid);
  $('#myShort').textContent = 'ID: ' + (me.shortId || '');
  $('#auth').classList.add('hidden');
  $('#appUI').classList.remove('hidden');

  // fill profile editor
  $('#profName').value = me.name || '';
  $('#profAvatarUrl').value = me.avatar || '';

  // NEW: Set status selector
  $$('.status-option').forEach(option => {
    if (option.dataset.status === me.status) {
      option.classList.add('active');
    } else {
      option.classList.remove('active');
    }
  });

  // NEW: Status selector event listeners
  $$('.status-option').forEach(option => {
    option.onclick = async () => {
      $$('.status-option').forEach(opt => opt.classList.remove('active'));
      option.classList.add('active');
      
      await update(ref(db, 'users/' + me.uid), { status: option.dataset.status });
      toast(`Status set to ${option.dataset.status}`, 2000, 'success');
    };
  });

  // NEW: Theme selector event listeners
  $$('.theme-option').forEach(option => {
    option.onclick = () => {
      $$('.theme-option').forEach(opt => opt.classList.remove('active'));
      option.classList.add('active');
      
      // Update CSS variables based on theme
      if (option.dataset.theme === 'green') {
        document.documentElement.style.setProperty('--brand', '#4caf50');
      } else if (option.dataset.theme === 'purple') {
        document.documentElement.style.setProperty('--brand', '#9c27b0');
      } else if (option.dataset.theme === 'red') {
        document.documentElement.style.setProperty('--brand', '#f44336');
      } else {
        document.documentElement.style.setProperty('--brand', '#4f8cff');
      }
      localStorage.setItem('chatTheme', option.dataset.theme);
      toast(`Theme changed to ${option.dataset.theme}`, 2000, 'success');
    };
  });

  // Load saved theme
  const savedTheme = localStorage.getItem('chatTheme');
  if (savedTheme) {
    const themeOption = $(`.theme-option[data-theme="${savedTheme}"]`);
    if (themeOption) {
      $$('.theme-option').forEach(opt => opt.classList.remove('active'));
      themeOption.classList.add('active');
      
      // Update CSS variables
      if (savedTheme === 'green') {
        document.documentElement.style.setProperty('--brand', '#4caf50');
      } else if (savedTheme === 'purple') {
        document.documentElement.style.setProperty('--brand', '#9c27b0');
      } else if (savedTheme === 'red') {
        document.documentElement.style.setProperty('--brand', '#f44336');
      } else {
        document.documentElement.style.setProperty('--brand', '#4f8cff');
      }
    }
  }

  // profile buttons wired as before...
  $('#saveProfileBtn').onclick = async ()=>{
    const name = $('#profName').value.trim() || me.email?.split('@')[0] || 'user';
    const avatar = $('#profAvatarUrl').value.trim() || me.avatar || defaultAvatar(me.uid);
    await update(ref(db, 'users/'+me.uid), { name, avatar });
    try { await updateProfile(auth.currentUser, { displayName: name, photoURL: avatar }); } catch(_) {}
    $('#navAvatar').src = avatar;
    toast('Profile updated successfully!', 2000, 'success');
    await refreshFriends();
  };

  $('#resetAvatarBtn').onclick = async ()=>{
    const avatar = defaultAvatar(me.uid);
    $('#profAvatarUrl').value = avatar;
    await update(ref(db, 'users/'+me.uid), { avatar });
    try { await updateProfile(auth.currentUser, { photoURL: avatar }); } catch(_) {}
    $('#navAvatar').src = avatar;
    toast('Avatar reset to default', 2000, 'success');
  };

  // Manage admin controls visibility
  if(user.email && user.email.toLowerCase() === adminEmail.toLowerCase()){
    isAdminUser = true;
    $('#adminControls').style.display = 'block';
    await injectAdminPanel();
    toast('Admin access granted!', 3000, 'success');
  } else {
    isAdminUser = false;
    $('#adminControls').style.display = 'none';
  }

  document.getElementById('profileAdminPanel').style.display = 'none';

  // refresh rest of app UI...
  await refreshFriends();
  await loadCommunities();

  // NEW: wire Add friend button + load requests and live updates
  $('#addFriendBtn').onclick = ()=> sendFriendRequestByShortId($('#addByShort').value);
  await loadFriendRequests();
  onValue(ref(db, `friendRequests/${me.uid}`), ()=> { loadFriendRequests(); });

  // NEW: Setup navigation
  setupNavigation();
  
  // NEW: Initialize games
  initializeTicTacToe();
  $('#startTicTacToe').onclick = initializeTicTacToe;
  $('#resetTicTacToe').onclick = initializeTicTacToe;

  // subscribe global announcement
  onValue(ref(db,'announcements/global'), snap=>{
    const b = $('#globalBanner');
    if(snap.exists()){
      b.textContent = snap.val().text || '';
      b.classList.remove('hidden');
    } else {
      b.classList.add('hidden');
      b.textContent = '';
    }
  });
});

/* ========================== PROFILE PANEL TOGGLE + LOGOUT ========================== */
$('#navAvatar').onclick = () => {
  const panel = document.getElementById('profileAdminPanel');
  if(panel.style.display === 'none' || panel.style.display === ''){
    panel.style.display = 'block';
  } else {
    panel.style.display = 'none';
  }
};

$('#logoutBtn').onclick = async () => {
  const ok = confirm('Are you sure you want to sign out?');
  if(ok) {
    await signOut(auth);
    toast('Signed out successfully', 2000, 'success');
  }
};

const darkModeToggle = document.getElementById('darkModeToggle');

function updateToggleButtonText() {
  darkModeToggle.textContent = document.body.classList.contains('theme-dim') ? 'Light Mode' : 'Dark Mode';
}

darkModeToggle.onclick = () => {
  document.body.classList.toggle('theme-dim');
  if (document.body.classList.contains('theme-dim')) {
    localStorage.setItem('darkMode', 'enabled');
    toast('Dark mode enabled', 2000, 'success');
  } else {
    localStorage.removeItem('darkMode');
    toast('Light mode enabled', 2000, 'success');
  }
  updateToggleButtonText();
};

if (localStorage.getItem('darkMode') === 'enabled') {
  document.body.classList.add('theme-dim');
}

updateToggleButtonText();

const msgInput = document.getElementById('msgInput');
const typingIndicator = document.getElementById('typingIndicator');

msgInput.addEventListener('input', () => {
  typingIndicator.style.display = 'block';
  clearTimeout(msgInput._typingTimeout);
  msgInput._typingTimeout = setTimeout(() => {
    typingIndicator.style.display = 'none';
  }, 1000);
});
</script>

</body>
</html>
