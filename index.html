<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QuickChat ‚Äî metoo Edition</title>
<style>
:root {
  --bg: #0b0f14;
  --elev: #111723;
  --border: #1b2435;
  --text: #e6eefc;
  --muted: #98a7c0;
  --brand: #4f8cff;
  --success: #4caf50;
  --warning: #ff9800;
  --danger: #f44336;
  --transition: all 0.3s ease;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  --radius: 12px;
}

* {
  box-sizing: border-box;
  transition: var(--transition);
}

body.theme-high { --bg:#05070b; --elev:#0a1120; --border:#172135; --text:#eaf2ff; --muted:#9fb1cc; --brand:#4f8cff }
body.theme-dim { --bg:#0b0f14; --elev:#111723; --border:#1b2435; --text:#e6eefc; --muted:#98a7c0; --brand:#4f8cff }
body.theme-light {
  --bg: #f5f7fa;
  --elev: #ffffff;
  --border: #e1e5ee;
  --text: #2d3748;
  --muted: #718096;
  --brand: #4f8cff;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

html, body {
  height: 100%;
  margin: 0;
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  overflow: auto;
}

.app {
  display: flex;
  flex-direction: column;
  height: 100%;
  min-height: 100vh;
}

header {
  display: flex;
  align-items: center;
  gap: .6rem;
  padding: .7rem 1rem;
  background: linear-gradient(135deg, var(--elev) 0%, #0e1420 100%);
  border-bottom: 1px solid var(--border);
  box-shadow: var(--shadow);
  position: relative;
  z-index: 100;
}

body.theme-light header {
  background: linear-gradient(135deg, var(--elev) 0%, #f0f4ff 100%);
}

.title {
  font-weight: 800;
  font-size: 1.4rem;
  background: linear-gradient(45deg, var(--brand), #6aa1ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: titleGlow 3s ease-in-out infinite alternate;
}

@keyframes titleGlow {
  from { filter: brightness(1); }
  to { filter: brightness(1.2); }
}

.card {
  background: var(--elev);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1rem;
  box-shadow: var(--shadow);
  animation: fadeInUp 0.5s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.hidden {
  display: none !important;
}

.input {
  width: 100%;
  padding: .8rem;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #0b1220;
  color: var(--text);
  margin: .4rem 0;
  font-size: 0.95rem;
  transition: all 0.3s ease;
}

body.theme-light .input {
  background: #ffffff;
}

.input:focus {
  outline: none;
  border-color: var(--brand);
  box-shadow: 0 0 0 2px rgba(79, 140, 255, 0.2);
  transform: translateY(-1px);
}

.btn {
  background: linear-gradient(135deg, var(--brand), #3a7cff);
  border: none;
  color: #fff;
  padding: .7rem 1.2rem;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

.btn:hover::before {
  left: 100%;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(79, 140, 255, 0.4);
}

.btn.ghost {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
}

.btn.ghost:hover {
  background: var(--border);
  transform: translateY(-1px);
}

.list {
  display: flex;
  flex-direction: column;
  gap: .5rem;
  margin-top: .5rem;
}

.item {
  display: flex;
  align-items: center;
  gap: .5rem;
  padding: .8rem;
  border-radius: 10px;
  background: #0b1424;
  border: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.3s ease;
  animation: slideInLeft 0.4s ease-out;
}

body.theme-light .item {
  background: #f8fafc;
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.item:hover {
  background: #0c1a30;
  border-color: var(--brand);
  transform: translateX(5px);
}

body.theme-light .item:hover {
  background: #edf2f7;
}

.avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--border);
  transition: all 0.3s ease;
}

.avatar:hover {
  border-color: var(--brand);
  transform: scale(1.1);
}

#messages {
  margin-top: .6rem;
  max-height: 360px;
  overflow: auto;
  background: #071022;
  padding: .8rem;
  border-radius: var(--radius);
  scroll-behavior: smooth;
  flex: 1;
  min-height: 200px;
}

body.theme-light #messages {
  background: #f0f4ff;
}

#messages::-webkit-scrollbar {
  width: 6px;
}

#messages::-webkit-scrollbar-track {
  background: transparent;
}

#messages::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 3px;
}

#messages::-webkit-scrollbar-thumb:hover {
  background: var(--brand);
}

.message-item {
  display: flex;
  align-items: flex-start;
  gap: .8rem;
  padding: .8rem;
  border-radius: var(--radius);
  margin-bottom: .5rem;
  animation: messageSlide 0.3s ease-out;
  position: relative;
}

@keyframes messageSlide {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-item.own {
  background: linear-gradient(135deg, #08263f, #0a2d4a);
  margin-left: 2rem;
}

body.theme-light .message-item.own {
  background: linear-gradient(135deg, #e3f2fd, #bbdefb);
}

.message-item.other {
  background: #071328;
  margin-right: 2rem;
}

body.theme-light .message-item.other {
  background: #ffffff;
}

.message-content {
  flex: 1;
}

.message-sender {
  font-weight: 700;
  margin-bottom: .3rem;
  color: var(--brand);
}

.message-text {
  margin: .3rem 0;
  line-height: 1.4;
}

.message-time {
  color: var(--muted);
  font-size: .75rem;
  margin-top: .3rem;
}

.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  background: var(--elev);
  border-top: 1px solid var(--border);
  z-index: 1000;
  backdrop-filter: blur(10px);
  padding: 0.5rem;
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 8px;
  cursor: pointer;
  color: var(--muted);
  font-size: 0.8rem;
  transition: all 0.3s ease;
  border-radius: var(--radius);
  position: relative;
}

.nav-item.active {
  color: var(--brand);
  transform: translateY(-5px);
}

.nav-item.active::after {
  content: '';
  position: absolute;
  bottom: -8px;
  width: 4px;
  height: 4px;
  background: var(--brand);
  border-radius: 50%;
}

.nav-icon {
  font-size: 1.3rem;
  margin-bottom: 4px;
  transition: all 0.3s ease;
}

.nav-item.active .nav-icon {
  transform: scale(1.2);
}

.page {
  display: none;
  padding-bottom: 80px;
  animation: pageFade 0.4s ease-out;
  overflow-y: auto;
  max-height: calc(100vh - 120px);
}

@keyframes pageFade {
  from {
    opacity: 0;
    transform: translateX(20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.page.active {
  display: block;
}

main {
  flex: 1;
  overflow: auto;
  padding: 0.8rem;
  min-height: calc(100vh - 120px);
}

.settings-section {
  margin-bottom: 1.5rem;
  animation: fadeInUp 0.5s ease-out;
}

.settings-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  border-bottom: 1px solid var(--border);
  transition: all 0.3s ease;
}

.settings-item:hover {
  background: #0c1a30;
  border-radius: var(--radius);
}

body.theme-light .settings-item:hover {
  background: #f7fafc;
}

.settings-item:last-child {
  border-bottom: none;
}

.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: var(--border);
  transition: .4s;
  border-radius: 24px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: var(--brand);
}

input:checked + .slider:before {
  transform: translateX(26px);
}

#toasts {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 100px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
}

.toast {
  padding: 12px 20px;
  background: var(--elev);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  box-shadow: var(--shadow);
  animation: toastSlide 0.3s ease-out;
  backdrop-filter: blur(10px);
}

@keyframes toastSlide {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.status-indicator {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 8px;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

.status-online {
  background: var(--success);
  box-shadow: 0 0 10px var(--success);
}

.status-offline {
  background: var(--muted);
}

.status-away {
  background: var(--warning);
  box-shadow: 0 0 10px var(--warning);
}

.status-busy {
  background: var(--danger);
  box-shadow: 0 0 10px var(--danger);
}

.theme-selector {
  display: flex;
  gap: 12px;
  margin-top: 12px;
}

.theme-option {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  border: 3px solid transparent;
  transition: all 0.3s ease;
  position: relative;
}

.theme-option.active {
  border-color: var(--text);
  transform: scale(1.1);
}

.theme-option::after {
  content: '‚úì';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-weight: bold;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.theme-option.active::after {
  opacity: 1;
}

.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid var(--border);
  border-radius: 50%;
  border-top-color: var(--brand);
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.context-menu {
  position: absolute;
  background: var(--elev);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 8px 0;
  z-index: 1000;
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  animation: contextMenuSlide 0.2s ease-out;
}

@keyframes contextMenuSlide {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.context-menu-item {
  padding: 10px 16px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.context-menu-item:hover {
  background: var(--brand);
  color: white;
}

.search-container {
  position: relative;
  margin-bottom: 1rem;
}

.search-results {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--elev);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  max-height: 200px;
  overflow-y: auto;
  z-index: 100;
  display: none;
  box-shadow: var(--shadow);
}

.search-result-item {
  padding: 10px 12px;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  transition: all 0.2s ease;
}

.search-result-item:hover {
  background: var(--brand);
  color: white;
}

.file-preview {
  max-width: 250px;
  margin-top: 8px;
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow);
  animation: fadeInUp 0.4s ease-out;
}

.file-preview img {
  width: 100%;
  height: auto;
  transition: transform 0.3s ease;
}

.file-preview img:hover {
  transform: scale(1.05);
}

.file-info {
  background: rgba(0,0,0,0.8);
  padding: 8px 12px;
  font-size: 0.8rem;
  color: white;
}

.voice-message {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 8px;
  padding: 8px 12px;
  background: rgba(79, 140, 255, 0.1);
  border-radius: var(--radius);
}

.voice-play-btn {
  background: var(--brand);
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.voice-play-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(79, 140, 255, 0.4);
}

.voice-progress {
  flex: 1;
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  position: relative;
  overflow: hidden;
}

.voice-progress-bar {
  position: absolute;
  height: 100%;
  background: linear-gradient(90deg, var(--brand), #6aa1ff);
  border-radius: 3px;
  width: 0%;
  transition: width 0.1s ease;
}

.voice-duration {
  font-size: 0.8rem;
  color: var(--muted);
  min-width: 40px;
}

.reaction-container {
  display: flex;
  gap: 6px;
  margin-top: 8px;
  flex-wrap: wrap;
}

.reaction {
  background: var(--elev);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 4px 8px;
  font-size: 0.8rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  transition: all 0.3s ease;
}

.reaction:hover {
  background: var(--brand);
  transform: scale(1.1);
}

.reaction-picker {
  position: absolute;
  background: var(--elev);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 6px;
  z-index: 100;
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  animation: fadeInUp 0.3s ease-out;
}

.reaction-emoji {
  cursor: pointer;
  padding: 6px;
  border-radius: 6px;
  font-size: 1.3rem;
  transition: all 0.2s ease;
  text-align: center;
}

.reaction-emoji:hover {
  background: var(--brand);
  transform: scale(1.2);
}

.pinned-message {
  border-left: 4px solid var(--brand);
  background: linear-gradient(135deg, #0c1a30, #0f2040) !important;
  animation: pulseGlow 2s infinite;
}

body.theme-light .pinned-message {
  background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
}

@keyframes pulseGlow {
  0% { box-shadow: 0 0 5px rgba(79, 140, 255, 0.3); }
  50% { box-shadow: 0 0 15px rgba(79, 140, 255, 0.6); }
  100% { box-shadow: 0 0 5px rgba(79, 140, 255, 0.3); }
}

.pin-indicator {
  color: var(--brand);
  font-size: 0.9rem;
  margin-right: 6px;
  animation: bounce 2s infinite;
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
  40% { transform: translateY(-5px); }
  60% { transform: translateY(-3px); }
}

/* NEW FRIEND REQUEST FEATURES */
.friend-request-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background: var(--danger);
  color: white;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  font-size: 0.7rem;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: pulse 1.5s infinite;
}

.friend-suggestions {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border);
}

.suggestion-item {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  padding: 0.8rem;
  border-radius: var(--radius);
  background: #0b1424;
  margin-bottom: 0.5rem;
  transition: all 0.3s ease;
}

body.theme-light .suggestion-item {
  background: #f8fafc;
}

.suggestion-item:hover {
  background: #0c1a30;
  transform: translateX(5px);
}

body.theme-light .suggestion-item:hover {
  background: #edf2f7;
}

.suggestion-actions {
  display: flex;
  gap: 0.5rem;
  margin-left: auto;
}

.friends-stats {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

.stat-card {
  flex: 1;
  min-width: 120px;
  background: linear-gradient(135deg, var(--elev), #0c1a30);
  padding: 1rem;
  border-radius: var(--radius);
  text-align: center;
  border: 1px solid var(--border);
}

body.theme-light .stat-card {
  background: linear-gradient(135deg, var(--elev), #f0f4ff);
}

.stat-number {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--brand);
  margin-bottom: 0.3rem;
}

.stat-label {
  font-size: 0.8rem;
  color: var(--muted);
}

/* ENHANCED ADMIN FEATURES */
.admin-dashboard {
  background: linear-gradient(135deg, #1a1f2e, #0f1420);
  border: 1px solid var(--brand);
  border-radius: var(--radius);
  padding: 1rem;
  margin-bottom: 1rem;
}

body.theme-light .admin-dashboard {
  background: linear-gradient(135deg, #f0f4ff, #e6eeff);
}

.admin-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin-bottom: 1rem;
}

.admin-stat {
  background: var(--elev);
  padding: 1rem;
  border-radius: var(--radius);
  text-align: center;
  border: 1px solid var(--border);
}

.admin-stat-number {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--brand);
  margin-bottom: 0.5rem;
}

.admin-stat-label {
  font-size: 0.9rem;
  color: var(--muted);
}

.quick-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-bottom: 1rem;
}

.admin-log {
  max-height: 200px;
  overflow-y: auto;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 0.8rem;
  font-size: 0.85rem;
}

body.theme-light .admin-log {
  background: #ffffff;
}

.log-entry {
  padding: 0.5rem;
  border-bottom: 1px solid var(--border);
  color: var(--muted);
}

.log-entry:last-child {
  border-bottom: none;
}

.user-management {
  margin-top: 1rem;
}

.user-filters {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

.filter-btn {
  padding: 0.5rem 1rem;
  border: 1px solid var(--border);
  background: var(--elev);
  color: var(--text);
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.3s ease;
}

.filter-btn.active {
  background: var(--brand);
  border-color: var(--brand);
}

.filter-btn:hover {
  background: var(--border);
}

.bulk-actions {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

/* NOTIFICATION SYSTEM */
.notification-bell {
  position: relative;
  cursor: pointer;
}

.notification-dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  background: var(--elev);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  width: 300px;
  max-height: 400px;
  overflow-y: auto;
  z-index: 1000;
  box-shadow: var(--shadow);
  display: none;
}

.notification-header {
  padding: 1rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.notification-list {
  max-height: 300px;
  overflow-y: auto;
}

.notification-item {
  padding: 0.8rem;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.3s ease;
}

.notification-item:hover {
  background: var(--border);
}

.notification-item.unread {
  background: rgba(79, 140, 255, 0.1);
}

.notification-content {
  font-size: 0.9rem;
  margin-bottom: 0.3rem;
}

.notification-time {
  font-size: 0.75rem;
  color: var(--muted);
}

/* FRIEND ACTIVITY FEED */
.activity-feed {
  margin-top: 1rem;
}

.activity-item {
  display: flex;
  align-items: center;
  gap: 0.8rem;
  padding: 0.8rem;
  border-radius: var(--radius);
  background: #0b1424;
  margin-bottom: 0.5rem;
  border-left: 3px solid var(--brand);
}

body.theme-light .activity-item {
  background: #f8fafc;
}

.activity-avatar {
  width: 32px;
  height: 32px;
}

.activity-content {
  flex: 1;
  font-size: 0.9rem;
}

.activity-time {
  font-size: 0.75rem;
  color: var(--muted);
}

/* NEW ENHANCEMENTS */

/* Enhanced Message Status */
.message-status {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-top: 4px;
  font-size: 0.7rem;
  color: var(--muted);
}

/* Enhanced File Upload */
.file-upload-area {
  border: 2px dashed var(--border);
  border-radius: var(--radius);
  padding: 2rem;
  text-align: center;
  margin: 1rem 0;
  cursor: pointer;
  transition: all 0.3s ease;
}

.file-upload-area:hover {
  border-color: var(--brand);
  background: rgba(79, 140, 255, 0.05);
}

.file-upload-area.dragover {
  border-color: var(--brand);
  background: rgba(79, 140, 255, 0.1);
}

/* Enhanced Mobile Responsiveness */
.mobile-header {
  display: none;
  align-items: center;
  justify-content: space-between;
  padding: 1rem;
  background: var(--elev);
  border-bottom: 1px solid var(--border);
}

.mobile-menu-btn {
  background: none;
  border: none;
  color: var(--text);
  font-size: 1.5rem;
  cursor: pointer;
}

/* Enhanced Chat Bubbles */
.chat-bubble {
  max-width: 80%;
  padding: 12px 16px;
  border-radius: 18px;
  margin: 4px 0;
  position: relative;
  word-wrap: break-word;
}

.chat-bubble.own {
  background: linear-gradient(135deg, var(--brand), #3a7cff);
  color: white;
  margin-left: auto;
  border-bottom-right-radius: 4px;
}

.chat-bubble.other {
  background: var(--elev);
  border: 1px solid var(--border);
  margin-right: auto;
  border-bottom-left-radius: 4px;
}

.chat-bubble .timestamp {
  font-size: 0.7rem;
  opacity: 0.7;
  margin-top: 4px;
  text-align: right;
}

/* Enhanced User Profile */
.profile-header {
  text-align: center;
  padding: 2rem 1rem;
  background: linear-gradient(135deg, var(--elev), #0c1a30);
  border-radius: var(--radius);
  margin-bottom: 1rem;
}

body.theme-light .profile-header {
  background: linear-gradient(135deg, var(--elev), #f0f4ff);
}

.profile-avatar {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  border: 4px solid var(--brand);
  margin: 0 auto 1rem;
}

.profile-name {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.profile-status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 20px;
  background: var(--elev);
  border: 1px solid var(--border);
  font-size: 0.9rem;
}

/* Enhanced Loading States */
.skeleton {
  background: linear-gradient(90deg, var(--border) 25%, var(--elev) 50%, var(--border) 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
  border-radius: 4px;
}

@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.skeleton-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
}

.skeleton-text {
  height: 12px;
  margin: 4px 0;
}

.skeleton-text.short {
  width: 60%;
}

.skeleton-text.medium {
  width: 80%;
}

/* Enhanced Scrollbar */
.enhanced-scrollbar::-webkit-scrollbar {
  width: 8px;
}

.enhanced-scrollbar::-webkit-scrollbar-track {
  background: var(--bg);
  border-radius: 4px;
}

.enhanced-scrollbar::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 4px;
}

.enhanced-scrollbar::-webkit-scrollbar-thumb:hover {
  background: var(--brand);
}

/* Enhanced Animations */
.fade-in {
  animation: fadeIn 0.3s ease-out;
}

.slide-up {
  animation: slideUp 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* Enhanced Button Variants */
.btn.outline {
  background: transparent;
  border: 2px solid var(--brand);
  color: var(--brand);
}

.btn.outline:hover {
  background: var(--brand);
  color: white;
}

.btn.danger {
  background: var(--danger);
}

.btn.danger:hover {
  background: #d32f2f;
  transform: translateY(-2px);
}

.btn.success {
  background: var(--success);
}

.btn.success:hover {
  background: #388e3c;
  transform: translateY(-2px);
}

/* Enhanced Form Elements */
.form-group {
  margin-bottom: 1rem;
}

.form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: var(--text);
}

.form-hint {
  font-size: 0.8rem;
  color: var(--muted);
  margin-top: 0.25rem;
}

/* NEW: Disappearing Messages Styles */
.disappearing-message {
  position: relative;
  border: 1px dashed var(--warning);
  background: rgba(255, 152, 0, 0.05) !important;
}

.disappearing-message .message-timer {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-top: 4px;
  font-size: 0.7rem;
  color: var(--warning);
}

.disappearing-message .timer-icon {
  font-size: 0.8rem;
}

.disappearing-message.expiring {
  animation: pulseWarning 1s infinite;
}

@keyframes pulseWarning {
  0% { border-color: var(--warning); }
  50% { border-color: var(--danger); }
  100% { border-color: var(--warning); }
}

/* NEW: Forgot Password Styles */
.forgot-password-container {
  text-align: center;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border);
}

.forgot-password-link {
  color: var(--brand);
  cursor: pointer;
  text-decoration: underline;
  font-size: 0.9rem;
}

.forgot-password-link:hover {
  color: #6aa1ff;
}

.password-reset-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  backdrop-filter: blur(5px);
}

.password-reset-content {
  background: var(--elev);
  border-radius: var(--radius);
  padding: 2rem;
  width: 90%;
  max-width: 400px;
  box-shadow: var(--shadow);
  animation: fadeInUp 0.3s ease-out;
}

.password-reset-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
}

/* NEW: Password Reset Request Styles */
.password-reset-request {
  background: rgba(255, 152, 0, 0.1);
  border: 1px solid var(--warning);
  border-radius: var(--radius);
  padding: 1rem;
  margin-bottom: 1rem;
}

.password-reset-request .request-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.8rem;
}

.password-reset-request .user-details {
  display: flex;
  align-items: center;
  gap: 0.8rem;
}

.password-reset-request .request-actions {
  display: flex;
  gap: 0.5rem;
}

/* Enhanced Media Queries */
@media (max-width: 768px) {
  .app {
    font-size: 14px;
  }
  
  header {
    padding: 0.5rem;
  }
  
  .title {
    font-size: 1.2rem;
  }
  
  .card {
    padding: 0.8rem;
    margin-bottom: 0.8rem;
  }
  
  .bottom-nav {
    padding: 0.3rem;
  }
  
  .nav-icon {
    font-size: 1.1rem;
  }
  
  .page {
    padding-bottom: 70px;
  }
  
  .admin-stats {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .friends-stats {
    flex-direction: column;
  }
  
  .notification-dropdown {
    width: 280px;
    right: -50px;
  }
  
  .mobile-header {
    display: flex;
  }
  
  .desktop-only {
    display: none !important;
  }
  
  .chat-bubble {
    max-width: 90%;
  }
  
  .message-item.own {
    margin-left: 1rem;
  }
  
  .message-item.other {
    margin-right: 1rem;
  }
  
  #chats-page > div {
    flex-direction: column;
  }
  
  #chats-page > div > div {
    width: 100% !important;
  }
}

@media (max-width: 480px) {
  .app {
    font-size: 13px;
  }
  
  .card {
    padding: 0.6rem;
  }
  
  .btn {
    padding: 0.6rem 1rem;
    font-size: 0.8rem;
  }
  
  .input {
    padding: 0.6rem;
  }
  
  .profile-avatar {
    width: 80px;
    height: 80px;
  }
  
  .notification-dropdown {
    width: 250px;
    right: -80px;
  }
}

#darkModeToggle {
  position: relative;
  overflow: hidden;
}

@keyframes newMessage {
  0% {
    background: rgba(79, 140, 255, 0.3);
  }
  100% {
    background: transparent;
  }
}

.new-message {
  animation: newMessage 2s ease-out;
}

.typing-dots {
  display: inline-block;
}

.typing-dots span {
  display: inline-block;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--brand);
  margin: 0 2px;
  animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}

.scroll-to-bottom {
  position: absolute;
  bottom: 80px;
  right: 20px;
  background: var(--brand);
  color: white;
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: all 0.3s ease;
  z-index: 99;
}

.scroll-to-bottom:hover {
  transform: scale(1.1) translateY(-5px);
  box-shadow: 0 6px 20px rgba(79, 140, 255, 0.4);
}

.status-option {
  padding: 6px 12px;
  border-radius: 16px;
  font-size: 0.8rem;
  cursor: pointer;
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 6px;
}

.status-option.active {
  background: var(--brand);
  border-color: var(--brand);
}

#chats-page {
  display: flex;
  flex-direction: column;
  height: 100%;
  min-height: calc(100vh - 120px);
}

#chats-page > div {
  display: flex;
  gap: 1rem;
  align-items: flex-start;
  flex-wrap: wrap;
  flex: 1;
  min-height: 0;
}

#friendsList, #communitiesList, #adminUsersList {
  max-height: 280px;
  overflow-y: auto;
  overflow-x: hidden;
}

#incomingReqs, #outgoingReqs {
  max-height: 200px;
  overflow-y: auto;
}

.fullscreen-chat#appUI > div { display:flex; flex-direction:column; } 
.fullscreen-chat#appUI > div > div:first-child { display:none; }
.fullscreen-chat#appUI > div > div:last-child { width:100% !important; }

/* DISCORD-STYLE FEATURES */

/* Discord-like Sidebar */
.discord-sidebar {
  width: 72px;
  background: var(--elev);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 12px 0;
  gap: 8px;
  position: fixed;
  left: 0;
  top: 0;
  bottom: 0;
  z-index: 90;
}

.discord-server-icon {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--brand);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 8px;
}

.discord-server-icon:hover {
  border-radius: 16px;
  background: var(--brand);
}

.discord-server-icon.active {
  border-radius: 16px;
  background: var(--brand);
}

.discord-channel-sidebar {
  width: 240px;
  background: var(--elev);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  position: fixed;
  left: 72px;
  top: 0;
  bottom: 0;
  z-index: 89;
  overflow-y: auto;
}

.discord-server-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  font-weight: 700;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.discord-channel-category {
  padding: 8px 16px;
  color: var(--muted);
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.discord-channel-item {
  padding: 6px 16px;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  border-radius: 4px;
  margin: 0 8px;
  transition: all 0.2s ease;
}

.discord-channel-item:hover {
  background: rgba(79, 140, 255, 0.1);
}

.discord-channel-item.active {
  background: rgba(79, 140, 255, 0.2);
}

.discord-channel-icon {
  font-size: 1rem;
}

.discord-channel-name {
  flex: 1;
}

.discord-member-sidebar {
  width: 240px;
  background: var(--elev);
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  position: fixed;
  right: 0;
  top: 0;
  bottom: 0;
  z-index: 89;
  overflow-y: auto;
}

.discord-member-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  font-weight: 700;
  font-size: 1.1rem;
}

.discord-member-item {
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s ease;
}

.discord-member-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
}

.discord-member-name {
  flex: 1;
  font-size: 0.9rem;
}

.discord-member-status {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.discord-member-status.online {
  background: var(--success);
}

.discord-member-status.idle {
  background: var(--warning);
}

.discord-member-status.dnd {
  background: var(--danger);
}

.discord-member-status.offline {
  background: var(--muted);
}

/* Discord-like Message Styling */
.discord-message {
  display: flex;
  padding: 4px 16px;
  transition: all 0.2s ease;
}

.discord-message:hover {
  background: rgba(79, 140, 255, 0.05);
}

.discord-message-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin-right: 16px;
  flex-shrink: 0;
}

.discord-message-content {
  flex: 1;
}

.discord-message-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
}

.discord-message-author {
  font-weight: 600;
  color: var(--text);
}

.discord-message-timestamp {
  font-size: 0.75rem;
  color: var(--muted);
}

.discord-message-text {
  line-height: 1.4;
  word-wrap: break-word;
}

.discord-message-reactions {
  display: flex;
  gap: 8px;
  margin-top: 8px;
  flex-wrap: wrap;
}

.discord-reaction {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  background: var(--elev);
  border: 1px solid var(--border);
  border-radius: 12px;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.discord-reaction:hover {
  background: rgba(79, 140, 255, 0.1);
  border-color: var(--brand);
}

.discord-reaction.own {
  background: rgba(79, 140, 255, 0.2);
  border-color: var(--brand);
}

/* Discord-like Input Area */
.discord-input-area {
  background: var(--elev);
  border-top: 1px solid var(--border);
  padding: 16px;
  position: fixed;
  bottom: 0;
  left: 312px;
  right: 240px;
  z-index: 88;
}

.discord-input-container {
  display: flex;
  align-items: center;
  background: var(--bg);
  border-radius: 8px;
  border: 1px solid var(--border);
  padding: 8px 16px;
}

.discord-input {
  flex: 1;
  background: transparent;
  border: none;
  color: var(--text);
  font-size: 0.95rem;
  padding: 8px 0;
  outline: none;
}

.discord-input-buttons {
  display: flex;
  gap: 8px;
}

.discord-input-button {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  font-size: 1.2rem;
  padding: 4px;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.discord-input-button:hover {
  color: var(--text);
  background: rgba(79, 140, 255, 0.1);
}

/* Discord-like Roles and Permissions */
.discord-role-tag {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  margin-left: 8px;
}

.discord-role-admin {
  background: #f44336;
  color: white;
}

.discord-role-moderator {
  background: #ff9800;
  color: white;
}

.discord-role-member {
  background: #4caf50;
  color: white;
}

/* Discord-like Voice Channels */
.discord-voice-channel {
  color: #4caf50;
}

.discord-voice-users {
  padding: 8px 16px;
  border-top: 1px solid var(--border);
}

.discord-voice-user {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 0;
}

.discord-voice-indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #4caf50;
  animation: pulse 2s infinite;
}

/* Discord-like Threads */
.discord-thread-indicator {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-top: 8px;
  font-size: 0.8rem;
  color: var(--muted);
  cursor: pointer;
}

.discord-thread-indicator:hover {
  color: var(--brand);
}

/* Discord-like User Popout */
.discord-user-popout {
  position: absolute;
  background: var(--elev);
  border: 1px solid var(--border);
  border-radius: 8px;
  width: 300px;
  z-index: 1000;
  box-shadow: var(--shadow);
  animation: fadeInUp 0.2s ease-out;
}

.discord-user-popout-header {
  background: var(--brand);
  padding: 16px;
  border-radius: 8px 8px 0 0;
  color: white;
  display: flex;
  align-items: center;
  gap: 12px;
}

.discord-user-popout-avatar {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: 4px solid rgba(255, 255, 255, 0.2);
}

.discord-user-popout-name {
  font-weight: 700;
  font-size: 1.2rem;
}

.discord-user-popout-body {
  padding: 16px;
}

.discord-user-popout-section {
  margin-bottom: 16px;
}

.discord-user-popout-section-title {
  font-size: 0.8rem;
  color: var(--muted);
  margin-bottom: 8px;
  text-transform: uppercase;
  font-weight: 600;
}

.discord-user-popout-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

/* Discord-like Nitro Features */
.discord-nitro-badge {
  background: linear-gradient(45deg, #ff73fa, #8b46ff);
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.7rem;
  font-weight: 700;
  margin-left: 8px;
}

.discord-boost-badge {
  background: linear-gradient(45deg, #ff73fa, #8b46ff);
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.7rem;
  margin-left: 4px;
}

/* Discord-like Server Boost */
.discord-boost-level {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: rgba(255, 115, 250, 0.1);
  border-top: 1px solid var(--border);
}

.discord-boost-level-icon {
  color: #ff73fa;
  font-size: 1.2rem;
}

.discord-boost-level-text {
  flex: 1;
  font-size: 0.9rem;
}

.discord-boost-level-number {
  font-weight: 700;
  color: #ff73fa;
}

/* Discord-like Emoji Picker */
.discord-emoji-picker {
  position: absolute;
  bottom: 60px;
  right: 240px;
  width: 350px;
  height: 400px;
  background: var(--elev);
  border: 1px solid var(--border);
  border-radius: 8px;
  box-shadow: var(--shadow);
  z-index: 1000;
  display: none;
  flex-direction: column;
}

.discord-emoji-picker.active {
  display: flex;
}

.discord-emoji-picker-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 8px;
}

.discord-emoji-picker-tab {
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.discord-emoji-picker-tab.active {
  background: var(--brand);
  color: white;
}

.discord-emoji-picker-search {
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
}

.discord-emoji-picker-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 8px;
}

.discord-emoji-item {
  font-size: 1.5rem;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  text-align: center;
  transition: all 0.2s ease;
}

.discord-emoji-item:hover {
  background: var(--brand);
  transform: scale(1.2);
}

/* Discord-like Stage Channels */
.discord-stage-channel {
  color: #ff9800;
}

.discord-stage-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: rgba(255, 152, 0, 0.1);
  border-top: 1px solid var(--border);
}

.discord-stage-icon {
  color: #ff9800;
  font-size: 1.2rem;
}

.discord-stage-text {
  flex: 1;
  font-size: 0.9rem;
}

.discord-stage-button {
  background: #ff9800;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: 600;
}

/* Responsive adjustments for Discord features */
@media (max-width: 1200px) {
  .discord-channel-sidebar,
  .discord-member-sidebar {
    display: none;
  }
  
  .discord-input-area {
    left: 72px;
    right: 0;
  }
}

@media (max-width: 768px) {
  .discord-sidebar {
    display: none;
  }
  
  .discord-input-area {
    left: 0;
  }
}
</style>
</head>
<body>
<div class="app" id="app">
<!-- Discord-style Sidebar -->
<div class="discord-sidebar">
  <div class="discord-server-icon active">QC</div>
  <div class="discord-server-icon">F</div>
  <div class="discord-server-icon">G</div>
  <div class="discord-server-icon">+</div>
</div>

<!-- Discord-style Channel Sidebar -->
<div class="discord-channel-sidebar">
  <div class="discord-server-header">
    <span>QuickChat Server</span>
    <button class="discord-input-button">üîî</button>
  </div>
  
  <div class="discord-channel-category">
    <span>TEXT CHANNELS</span>
    <button class="discord-input-button">+</button>
  </div>
  
  <div class="discord-channel-item active">
    <span class="discord-channel-icon">#</span>
    <span class="discord-channel-name">general</span>
  </div>
  
  <div class="discord-channel-item">
    <span class="discord-channel-icon">#</span>
    <span class="discord-channel-name">help</span>
  </div>
  
  <div class="discord-channel-item">
    <span class="discord-channel-icon">#</span>
    <span class="discord-channel-name">off-topic</span>
  </div>
  
  <div class="discord-channel-category">
    <span>VOICE CHANNELS</span>
    <button class="discord-input-button">+</button>
  </div>
  
  <div class="discord-channel-item discord-voice-channel">
    <span class="discord-channel-icon">üîä</span>
    <span class="discord-channel-name">General Voice</span>
  </div>
  
  <div class="discord-channel-item discord-voice-channel">
    <span class="discord-channel-icon">üîä</span>
    <span class="discord-channel-name">Gaming</span>
  </div>
  
  <div class="discord-boost-level">
    <span class="discord-boost-level-icon">üöÄ</span>
    <span class="discord-boost-level-text">Server Boost</span>
    <span class="discord-boost-level-number">Level 1</span>
  </div>
</div>

<!-- Discord-style Member Sidebar -->
<div class="discord-member-sidebar">
  <div class="discord-member-header">ONLINE ‚Äî 3</div>
  
  <div class="discord-member-item">
    <img class="discord-member-avatar" src="" alt="User" />
    <span class="discord-member-name">You</span>
    <div class="discord-member-status online"></div>
  </div>
  
  <div class="discord-member-item">
    <img class="discord-member-avatar" src="" alt="User" />
    <span class="discord-member-name">John Doe</span>
    <span class="discord-role-tag discord-role-admin">ADMIN</span>
    <div class="discord-member-status online"></div>
  </div>
  
  <div class="discord-member-item">
    <img class="discord-member-avatar" src="" alt="User" />
    <span class="discord-member-name">Jane Smith</span>
    <span class="discord-role-tag discord-role-moderator">MOD</span>
    <div class="discord-member-status idle"></div>
  </div>
  
  <div class="discord-member-header">OFFLINE ‚Äî 5</div>
  
  <div class="discord-member-item">
    <img class="discord-member-avatar" src="" alt="User" />
    <span class="discord-member-name">Bob Johnson</span>
    <div class="discord-member-status offline"></div>
  </div>
</div>

<!-- Discord-style Input Area -->
<div class="discord-input-area">
  <div class="discord-input-container">
    <button class="discord-input-button">‚ûï</button>
    <input type="text" class="discord-input" placeholder="Message #general" />
    <div class="discord-input-buttons">
      <button class="discord-input-button" id="discordEmojiButton">üòÄ</button>
      <button class="discord-input-button">üéÅ</button>
      <button class="discord-input-button">üñºÔ∏è</button>
    </div>
  </div>
</div>

<!-- Discord Emoji Picker -->
<div class="discord-emoji-picker" id="discordEmojiPicker">
  <div class="discord-emoji-picker-header">
    <div class="discord-emoji-picker-tab active">üòÄ</div>
    <div class="discord-emoji-picker-tab">üöÄ</div>
    <div class="discord-emoji-picker-tab">üéâ</div>
  </div>
  <div class="discord-emoji-picker-search">
    <input type="text" class="input" placeholder="Search emojis..." />
  </div>
  <div class="discord-emoji-picker-body">
    <!-- Emojis will be populated by JavaScript -->
  </div>
</div>

<header>
<div class="title">QuickChat</div>
<div style="flex:1"></div>
<div style="display:flex;align-items:center;gap:0.5rem">
<!-- Notification Bell -->
<div class="notification-bell" id="notificationBell" style="position:relative;cursor:pointer">
  <div class="nav-icon">üîî</div>
  <div id="notificationBadge" class="friend-request-badge hidden">0</div>
  <div id="notificationDropdown" class="notification-dropdown hidden">
    <div class="notification-header">
      <strong>Notifications</strong>
      <button class="btn ghost" id="clearNotifications" style="padding:0.3rem 0.6rem">Clear All</button>
    </div>
    <div id="notificationList" class="notification-list"></div>
  </div>
</div>

<img id="navAvatar" class="avatar" src="" alt="me" style="width:36px;height:36px;border:1px solid var(--border);cursor:pointer" title="Toggle Profile Menu"/>
<button id="darkModeToggle" class="btn ghost" title="Toggle Dark Mode" style="padding:0.3rem 0.6rem;">Light Mode</button>
<button id="logoutBtn" class="btn ghost" title="Logout" style="padding:0.3rem 0.6rem;margin-left:8px;">Logout</button>
</div>
</header>

<div id="globalBanner" class="hidden" style="background:#0c2140;border-bottom:1px solid var(--border);padding:.5rem;text-align:center;color:#dfefff"></div>

<main>
<section id="auth" class="card" style="max-width:720px;margin:2rem auto;animation:fadeInUp 0.6s ease-out">
<h3 style="text-align:center;margin-bottom:1.5rem;color:var(--brand)">Sign in / Register</h3>
<input id="loginEmail" class="input" placeholder="Email" type="email" />
<input id="loginPass" class="input" placeholder="Password" type="password" />
<div style="display:flex;gap:.5rem;margin-top:1rem;flex-wrap:wrap">
<button id="loginBtn" class="btn" style="flex:1">Log in</button>
<button id="registerBtn" class="btn ghost" style="flex:1">Register</button>
<button id="googleBtn" class="btn ghost" style="flex:1">Sign in with Google</button>
</div>
<div class="forgot-password-container">
  <span class="forgot-password-link" id="forgotPasswordLink">Forgot your password?</span>
</div>
<div id="authMsg" style="color:var(--muted);margin-top:.8rem;text-align:center;min-height:20px"></div>
</section>

<section id="appUI" class="hidden" style="max-width:1100px;margin:16px auto 80px">
<div class="bottom-nav">
  <div class="nav-item active" data-page="chats-page">
    <div class="nav-icon">üí¨</div>
    <div>Chats</div>
  </div>
  <div class="nav-item" data-page="settings-page">
    <div class="nav-icon">‚öôÔ∏è</div>
    <div>Settings</div>
  </div>
</div>

<div id="chats-page" class="page active">
  <div style="display:flex;gap:1rem;align-items:flex-start;flex-wrap:wrap">
    <div style="flex:1;min-width:300px">
      <!-- Profile & Admin Panel -->
      <div id="profileAdminPanel" class="card" style="margin-bottom:.8rem; display:none;">
        <strong style="display:block;margin-bottom:1rem;color:var(--brand)">My Profile</strong>
        <input id="profName" class="input" placeholder="Display name" />
        <input id="profAvatarUrl" class="input" placeholder="Avatar URL (optional)" />

        <div class="status-selector" style="margin:1rem 0">
          <strong style="display:block;margin-bottom:8px">Status</strong>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <div class="status-option active" data-status="online">
              <span class="status-indicator status-online"></span>Online
            </div>
            <div class="status-option" data-status="away">
              <span class="status-indicator status-away"></span>Away
            </div>
            <div class="status-option" data-status="busy">
              <span class="status-indicator status-busy"></span>Busy
            </div>
          </div>
        </div>

        <div style="display:flex;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap">
          <button id="saveProfileBtn" class="btn" style="flex:1">Save Profile</button>
          <button id="resetAvatarBtn" class="btn ghost" style="flex:1">Reset Avatar</button>
        </div>

        <div style="margin-bottom: 1rem;">
          <strong style="display:block;margin-bottom:8px">Chat Theme</strong>
          <div class="theme-selector">
            <div class="theme-option theme-blue active" data-theme="blue" style="background:#4f8cff"></div>
            <div class="theme-option theme-green" data-theme="green" style="background:#4caf50"></div>
            <div class="theme-option theme-purple" data-theme="purple" style="background:#9c27b0"></div>
            <div class="theme-option theme-red" data-theme="red" style="background:#f44336"></div>
          </div>
        </div>

        <!-- Enhanced Admin Panel -->
        <div id="adminControls" style="display:none; border-top: 1px solid var(--border); padding-top:15px; margin-top: 15px;">
          <div style="font-weight:700; margin-bottom:12px;color:var(--brand)">Admin Panel üëë</div>

          <!-- Admin Dashboard -->
          <div class="admin-dashboard">
            <div class="admin-stats">
              <div class="admin-stat">
                <div id="totalUsers" class="admin-stat-number">0</div>
                <div class="admin-stat-label">Total Users</div>
              </div>
              <div class="admin-stat">
                <div id="onlineUsers" class="admin-stat-number">0</div>
                <div class="admin-stat-label">Online Now</div>
              </div>
              <div class="admin-stat">
                <div id="totalMessages" class="admin-stat-number">0</div>
                <div class="admin-stat-label">Messages</div>
              </div>
              <div class="admin-stat">
                <div id="bannedUsers" class="admin-stat-number">0</div>
                <div class="admin-stat-label">Banned</div>
              </div>
            </div>

            <div class="quick-actions">
              <button id="adminRefreshStats" class="btn ghost">Refresh Stats</button>
              <button id="adminExportData" class="btn ghost">Export Data</button>
              <button id="adminSystemCheck" class="btn ghost">System Check</button>
            </div>

            <div class="admin-log">
              <strong style="display:block;margin-bottom:8px">Admin Log</strong>
              <div id="adminLogEntries"></div>
            </div>
          </div>

          <!-- User Management -->
          <div class="user-management">
            <strong style="display:block;margin-bottom:12px">User Management</strong>
            
            <div class="user-filters">
              <button class="filter-btn active" data-filter="all">All Users</button>
              <button class="filter-btn" data-filter="online">Online</button>
              <button class="filter-btn" data-filter="verified">Verified</button>
              <button class="filter-btn" data-filter="banned">Banned</button>
            </div>

            <div class="bulk-actions">
              <input id="adminTarget" class="input" placeholder="UID or 5-digit ID" style="flex:1;padding:.6rem" />
              <button id="adminLookupBtn" class="btn ghost">Lookup</button>
            </div>

            <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
              <button id="adminVerifyBtn" class="btn" style="flex:1">Verify</button>
              <button id="adminUnverifyBtn" class="btn ghost" style="flex:1">Unverify</button>
              <button id="adminBanBtn" class="btn ghost" style="flex:1">Ban</button>
              <button id="adminUnbanBtn" class="btn ghost" style="flex:1">Unban</button>
            </div>

            <div style="margin-bottom:12px">
              <input id="adminChatId" class="input" placeholder="Chat ID (room id)" style="margin-bottom:8px;padding:.6rem" />
              <input id="adminMsgKey" class="input" placeholder="Message Key to delete" style="padding:.6rem" />
              <div style="display:flex;gap:6px;margin-top:8px">
                <button id="adminDelMsgBtn" class="btn" style="flex:1">Delete Message</button>
                <button id="adminClearChat" class="btn ghost" style="flex:1">Clear Chat</button>
              </div>
            </div>

            <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px;margin-bottom:12px;">
              <div style="font-weight:700;margin-bottom:8px">Global Announcement</div>
              <input id="adminAnnText" class="input" placeholder="Announcement text" style="padding:.6rem" />
              <div style="display:flex;gap:6px;margin-top:8px">
                <button id="adminAnnSet" class="btn" style="flex:1">Set</button>
                <button id="adminAnnClear" class="btn ghost" style="flex:1">Clear</button>
              </div>
            </div>

            <!-- NEW: Password Reset Requests Section -->
            <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px">
              <div style="font-weight:700;margin-bottom:8px">Password Reset Requests</div>
              <div id="passwordResetRequests" class="admin-log" style="max-height:150px">
                <!-- Password reset requests will appear here -->
              </div>
            </div>

            <div>
              <button id="adminRefreshUsers" class="btn ghost" style="width:100%;margin-bottom:8px">Refresh Users</button>
              <div id="adminUsersList" style="max-height:220px;overflow:auto;margin-top:8px"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Enhanced Friend System -->
      <div class="card" style="margin-bottom:.8rem">
        <strong style="display:block;margin-bottom:.8rem">Add friends</strong>
        <div style="display:flex;gap:.5rem;margin-top:.5rem;flex-wrap:wrap">
          <input id="addByShort" class="input" placeholder="Enter 5-digit ID" style="flex:1;min-width:150px" />
          <button id="addFriendBtn" class="btn">Add</button>
          <button id="findFriendsBtn" class="btn ghost">Find Friends</button>
        </div>
        <div id="friendRequestMsg" style="color:var(--muted);margin-top:.6rem;text-align:center"></div>
      </div>

      <!-- Friends Statistics -->
      <div class="card" style="margin-bottom:.8rem">
        <div class="friends-stats">
          <div class="stat-card">
            <div id="totalFriends" class="stat-number">0</div>
            <div class="stat-label">Friends</div>
          </div>
          <div class="stat-card">
            <div id="pendingRequests" class="stat-number">0</div>
            <div class="stat-label">Pending</div>
          </div>
          <div class="stat-card">
            <div id="onlineFriends" class="stat-number">0</div>
            <div class="stat-label">Online</div>
          </div>
        </div>
      </div>

      <!-- Friend Requests Section -->
      <div class="card" style="margin-bottom:.8rem">
        <strong style="display:block;margin-bottom:.8rem">Friend Requests</strong>
        <div style="display:flex;gap:1rem;margin-top:.5rem;flex-wrap:wrap">
          <div style="flex:1;min-width:200px">
            <div style="font-weight:700;margin-bottom:.6rem;color:var(--brand)">Incoming</div>
            <div id="incomingReqs" class="list"></div>
          </div>
          <div style="flex:1;min-width:200px">
            <div style="font-weight:700;margin-bottom:.6rem;color:var(--brand)">Outgoing</div>
            <div id="outgoingReqs" class="list"></div>
          </div>
        </div>
      </div>

      <!-- Friend Suggestions -->
      <div class="card" style="margin-bottom:.8rem">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem">
          <strong>Friend Suggestions</strong>
          <button id="refreshSuggestions" class="btn ghost" style="padding:0.3rem 0.6rem">Refresh</button>
        </div>
        <div id="friendSuggestions" class="friend-suggestions"></div>
      </div>

      <!-- Friends List -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem">
          <strong>Friends</strong>
          <div id="myShort" style="color:var(--muted);font-size:.9rem"></div>
        </div>
        <div id="friendsList" class="list" style="margin-top:.6rem;max-height:280px;overflow:auto"></div>
      </div>

      <!-- Friend Activity Feed -->
      <div class="card" style="margin-top:.8rem">
        <strong style="display:block;margin-bottom:.8rem">Friend Activity</strong>
        <div id="activityFeed" class="activity-feed"></div>
      </div>

      <div class="card" style="margin-top:.8rem">
        <strong style="display:block;margin-bottom:.8rem">Communities</strong>
        <div id="communitiesList" class="list"></div>
      </div>
    </div>

    <!-- Chat Area -->
    <div style="width:420px;min-width:300px">
      <div class="card" id="chatCard">
        <div style="display:flex;align-items:center;gap:.6rem;position:relative;margin-bottom:1rem">
          <button id="chatBackBtn" class="btn ghost" style="display:none;position:absolute;left:0;">‚Üê Back</button>
          <img id="chatAvatar" class="avatar" src="" alt="" style="margin-left:30px">
          <div style="flex:1">
            <div id="chatTitle" style="font-weight:800;font-size:1.1rem">No chat selected</div>
            <div id="chatPresence" style="color:var(--muted);font-size:.85rem">‚Äî</div>
          </div>
          <div style="display:flex;gap:4px">
            <button id="audioCallBtn" class="btn ghost" title="Audio call (planned)">üé§</button>
            <button id="videoCallBtn" class="btn ghost" title="Video call (planned)">üìπ</button>
            <!-- NEW: Disappearing Messages Toggle -->
            <button id="disappearingToggle" class="btn ghost" title="Toggle disappearing messages">‚è±Ô∏è</button>
          </div>
        </div>

        <div class="search-container">
          <input id="messageSearch" class="input" placeholder="üîç Search messages..." style="margin-bottom:0" />
          <div id="searchResults" class="search-results"></div>
        </div>

        <div id="messages" style="margin-top:.6rem;max-height:360px;overflow:auto;background:#071022;padding:.8rem;border-radius:var(--radius);position:relative">
        </div>

        <div style="display:flex;gap:.5rem;margin-top:.8rem;flex-wrap:wrap">
          <input id="msgInput" class="input" placeholder="Type a message..." style="flex:1;min-width:200px" autocomplete="off" />
          <input id="fileInput" type="file" accept="image/*,audio/*,video/*,.pdf,.doc,.docx,.txt" style="display:none" />
          <button id="attachBtn" class="btn ghost" title="Attach file">üìé</button>
          <button id="sendBtn" class="btn">Send</button>
        </div>
        <div id="typingIndicator" style="color:var(--muted);margin-top:.6rem;display:none;font-style:italic">
          <span class="typing-dots">
            <span></span><span></span><span></span>
          </span>
          Someone is typing...
        </div>
      </div>
    </div>
  </div>
</div>

<div id="settings-page" class="page">
  <div class="card">
    <strong style="display:block;margin-bottom:1rem">Account Settings</strong>
    
    <div class="settings-item">
      <div>Notifications</div>
      <label class="switch">
        <input type="checkbox" checked>
        <span class="slider"></span>
      </label>
    </div>
    
    <div class="settings-item">
      <div>Message Preview</div>
      <label class="switch">
        <input type="checkbox" checked>
        <span class="slider"></span>
      </label>
    </div>
    
    <div class="settings-item">
      <div>Read Receipts</div>
      <label class="switch">
        <input type="checkbox" checked>
        <span class="slider"></span>
      </label>
    </div>
    
    <!-- NEW: Disappearing Messages Settings -->
    <div class="settings-item">
      <div>Disappearing Messages</div>
      <select id="disappearingTimeout" class="input" style="width:auto;padding:.5rem .8rem">
        <option value="0">Off</option>
        <option value="30000">30 seconds</option>
        <option value="60000">1 minute</option>
        <option value="300000">5 minutes</option>
        <option value="3600000">1 hour</option>
        <option value="86400000">24 hours</option>
      </select>
    </div>
  </div>
  
  <div class="card">
    <strong style="display:block;margin-bottom:1rem">Privacy & Security</strong>
    
    <div class="settings-item">
      <div>Last Seen</div>
      <select class="input" style="width:auto;padding:.5rem .8rem">
        <option>Everyone</option>
        <option>My Contacts</option>
        <option>Nobody</option>
      </select>
    </div>
    
    <div class="settings-item">
      <div>Profile Photo</div>
      <select class="input" style="width:auto;padding:.5rem .8rem">
        <option>Everyone</option>
        <option>My Contacts</option>
        <option>Nobody</option>
      </select>
    </div>
    
    <div class="settings-item">
      <div>Two-Step Verification</div>
      <button class="btn ghost">Enable</button>
    </div>
  </div>
  
  <div class="card">
    <strong style="display:block;margin-bottom:1rem">Chat Settings</strong>
    
    <div class="settings-item">
      <div>Chat Background</div>
      <button class="btn ghost">Change</button>
    </div>
    
    <div class="settings-item">
      <div>Font Size</div>
      <select class="input" style="width:auto;padding:.5rem .8rem">
        <option>Small</option>
        <option selected>Medium</option>
        <option>Large</option>
      </select>
    </div>
    
    <div class="settings-item">
      <div>Enter Key Sends</div>
      <label class="switch">
        <input type="checkbox">
        <span class="slider"></span>
      </label>
    </div>
  </div>
  
  <div class="card">
    <strong style="display:block;margin-bottom:1rem">Storage & Data</strong>
    
    <div class="settings-item">
      <div>Network Usage</div>
      <div>1.2 GB</div>
    </div>
    
    <div class="settings-item">
      <div>Storage Usage</div>
      <div>2.5 GB</div>
    </div>
    
    <div class="settings-item">
      <div>Auto-Download Media</div>
      <button class="btn ghost">Configure</button>
    </div>
  </div>
  
  <div class="card">
    <strong style="display:block;margin-bottom:1rem">About</strong>
    
    <div class="settings-item">
      <div>Version</div>
      <div>2.1.0</div>
    </div>
    
    <div class="settings-item">
      <div>Privacy Policy</div>
      <button class="btn ghost">View</button>
    </div>
    
    <div class="settings-item">
      <div>Terms of Service</div>
      <button class="btn ghost">View</button>
    </div>
  </div>
</div>
</section>
</main>
</div>

<div id="toasts" style="position:fixed;left:50%;transform:translateX(-50%);bottom:100px;z-index:9999"></div>

<div id="contextMenu" class="context-menu hidden"></div>

<!-- NEW: Password Reset Modal -->
<div id="passwordResetModal" class="password-reset-modal hidden">
  <div class="password-reset-content">
    <h3 style="text-align:center;margin-bottom:1.5rem;color:var(--brand)">Reset Password</h3>
    <input id="resetEmail" class="input" placeholder="Enter your email" type="email" />
    <div class="password-reset-actions">
      <button id="cancelReset" class="btn ghost" style="flex:1">Cancel</button>
      <button id="submitReset" class="btn" style="flex:1">Send Reset Link</button>
    </div>
    <div id="resetMsg" style="color:var(--muted);margin-top:.8rem;text-align:center;min-height:20px"></div>
  </div>
</div>

<button id="scrollToBottom" class="scroll-to-bottom hidden" title="Scroll to bottom">‚Üì</button>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, updateProfile, sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';
import { getDatabase, ref, set, push, onValue, get, update, remove } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js';
import { getStorage, ref as sref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js';

const firebaseConfig = {
  apiKey: "AIzaSyDEOHYkQnyaeDbdVGisC2B2H02kxNfp3F8",
  authDomain: "meaww-chat-4f6bd.firebaseapp.com",
  databaseURL: "https://meaww-chat-4f6bd-default-rtdb.firebaseio.com",
  projectId: "meaww-chat-4f6bd",
  storageBucket: "meaww-chat-4f6bd.appspot.com",
  messagingSenderId: "162714330727",
  appId: "1:162714330727:dd1ce1da5806c0316c2",
  measurementId: "G-L7Y3NV8L88"
};

const adminEmail = "flashdc4178@gmail.com";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const storage = getStorage(app);

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

function toast(msg, t = 3000, type = 'info') {
  const d = document.createElement('div');
  d.className = 'toast';
  d.style.background = type === 'error' ? 'var(--danger)' : 
                      type === 'success' ? 'var(--success)' : 
                      type === 'warning' ? 'var(--warning)' : 'var(--elev)';
  d.textContent = msg;
  $('#toasts').appendChild(d);
  setTimeout(() => {
    d.style.animation = 'toastSlide 0.3s ease-out reverse';
    setTimeout(() => d.remove(), 300);
  }, t);
}

function defaultAvatar(seed){
  return `https://api.dicebear.com/8.x/thumbs/svg?seed=${(seed||'quick').slice(0,8)}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
}

function timeAgo(ts){
  if(!ts) return '‚Äî';
  const d = Math.floor((Date.now()-ts)/1000);
  if(d<60) return d+'s';
  if(d<3600) return Math.floor(d/60)+'m';
  if(d<86400) return Math.floor(d/3600)+'h';
  return Math.floor(d/86400)+'d';
}

function typingRef(chatId, uid){
  return ref(db, `typing/${chatId}/${uid}`);
}

function pairKey(a,b){ return [a,b].sort().join('_'); }

let isAdminUser = false;
let me = null;
let currentChat = null;
let unsubMessages = null;
let typingTimer = null;
let pendingFile = null;
let lastSendAt = 0;
const SEND_COOLDOWN_MS = 1200;

const EMOJIS = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üò°', 'üéâ', 'üî•'];

// NEW: Disappearing messages state
let disappearingMessagesEnabled = false;
let disappearingTimeout = 0; // in milliseconds

// Enhanced Friend Request Features
let notificationCount = 0;

function updateNotificationBadge() {
  const badge = $('#notificationBadge');
  if (notificationCount > 0) {
    badge.textContent = notificationCount > 99 ? '99+' : notificationCount;
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
}

function addNotification(message, type = 'info') {
  const notification = {
    id: Date.now().toString(),
    message,
    type,
    timestamp: Date.now(),
    read: false
  };
  
  if (me && me.uid) {
    set(ref(db, `notifications/${me.uid}/${notification.id}`), notification);
  }
  
  notificationCount++;
  updateNotificationBadge();
  
  toast(message, 3000, type);
}

async function loadNotifications() {
  if (!me || !me.uid) return;
  
  const notificationsRef = ref(db, `notifications/${me.uid}`);
  onValue(notificationsRef, (snapshot) => {
    const notifications = snapshot.val() || {};
    const notificationList = $('#notificationList');
    notificationList.innerHTML = '';
    
    notificationCount = 0;
    
    Object.entries(notifications)
      .sort(([,a], [,b]) => b.timestamp - a.timestamp)
      .forEach(([id, notification]) => {
        if (!notification.read) notificationCount++;
        
        const item = document.createElement('div');
        item.className = `notification-item ${notification.read ? '' : 'unread'}`;
        item.innerHTML = `
          <div class="notification-content">${notification.message}</div>
          <div class="notification-time">${timeAgo(notification.timestamp)} ago</div>
        `;
        
        item.onclick = async () => {
          await set(ref(db, `notifications/${me.uid}/${id}/read`), true);
          item.classList.remove('unread');
        };
        
        notificationList.appendChild(item);
      });
    
    updateNotificationBadge();
  });
}

// Friend Suggestions
async function loadFriendSuggestions() {
  if (!me || !me.uid) return;
  
  const suggestionsRef = ref(db, 'users');
  const friendsRef = ref(db, `friends/${me.uid}`);
  
  const [usersSnap, friendsSnap] = await Promise.all([
    get(suggestionsRef),
    get(friendsRef)
  ]);
  
  if (!usersSnap.exists()) return;
  
  const allUsers = usersSnap.val();
  const myFriends = friendsSnap.exists() ? Object.keys(friendsSnap.val()) : [];
  const myRequests = await getFriendRequests();
  
  const suggestions = Object.values(allUsers).filter(user => 
    user.uid !== me.uid && 
    !myFriends.includes(user.uid) &&
    !myRequests.outgoing.includes(user.uid) &&
    !myRequests.incoming.includes(user.uid)
  ).slice(0, 5);
  
  const container = $('#friendSuggestions');
  container.innerHTML = '';
  
  if (suggestions.length === 0) {
    container.innerHTML = '<div style="color:var(--muted);text-align:center;padding:1rem">No suggestions available</div>';
    return;
  }
  
  suggestions.forEach(user => {
    const item = document.createElement('div');
    item.className = 'suggestion-item';
    item.innerHTML = `
      <img class="avatar" src="${user.avatar || defaultAvatar(user.uid)}" />
      <div style="flex:1">
        <div style="font-weight:700">${user.name || user.email}</div>
        <div style="color:var(--muted);font-size:.85rem">
          <span class="status-indicator status-${user.status || (user.online ? 'online' : 'offline')}"></span>
          ${user.status || (user.online ? 'online' : 'offline')}
        </div>
      </div>
      <div class="suggestion-actions">
        <button class="btn" data-action="add">Add</button>
      </div>
    `;
    
    item.querySelector('button').onclick = () => {
      sendFriendRequestByShortId(user.shortId);
    };
    
    container.appendChild(item);
  });
}

// Enhanced Friend Statistics
async function updateFriendStats() {
  if (!me || !me.uid) return;
  
  const friendsRef = ref(db, `friends/${me.uid}`);
  const requestsRef = ref(db, `friendRequests/${me.uid}`);
  
  const [friendsSnap, requestsSnap] = await Promise.all([
    get(friendsRef),
    get(requestsRef)
  ]);
  
  const friends = friendsSnap.exists() ? Object.keys(friendsSnap.val()) : [];
  const requests = requestsSnap.exists() ? requestsSnap.val() : {};
  
  let onlineCount = 0;
  for (const friendId of friends) {
    const friendSnap = await get(ref(db, `users/${friendId}`));
    if (friendSnap.exists() && friendSnap.val().online) {
      onlineCount++;
    }
  }
  
  $('#totalFriends').textContent = friends.length;
  $('#onlineFriends').textContent = onlineCount;
  $('#pendingRequests').textContent = Object.keys(requests.incoming || {}).length;
}

// Friend Activity Feed
async function loadActivityFeed() {
  if (!me || !me.uid) return;
  
  const friendsRef = ref(db, `friends/${me.uid}`);
  const friendsSnap = await get(friendsRef);
  
  if (!friendsSnap.exists()) return;
  
  const friendIds = Object.keys(friendsSnap.val());
  const activities = [];
  
  for (const friendId of friendIds) {
    const userSnap = await get(ref(db, `users/${friendId}`));
    if (userSnap.exists()) {
      const user = userSnap.val();
      activities.push({
        type: 'status',
        user: user,
        message: `${user.name} is now ${user.status}`,
        timestamp: user.lastSeen || Date.now()
      });
    }
  }
  
  activities.sort((a, b) => b.timestamp - a.timestamp);
  
  const container = $('#activityFeed');
  container.innerHTML = '';
  
  activities.slice(0, 10).forEach(activity => {
    const item = document.createElement('div');
    item.className = 'activity-item';
    item.innerHTML = `
      <img class="avatar activity-avatar" src="${activity.user.avatar || defaultAvatar(activity.user.uid)}" />
      <div class="activity-content">
        <div>${activity.message}</div>
        <div class="activity-time">${timeAgo(activity.timestamp)} ago</div>
      </div>
    `;
    container.appendChild(item);
  });
}

// NEW: Forgot Password Functionality
function setupForgotPassword() {
  $('#forgotPasswordLink').onclick = () => {
    $('#passwordResetModal').classList.remove('hidden');
  };
  
  $('#cancelReset').onclick = () => {
    $('#passwordResetModal').classList.add('hidden');
    $('#resetMsg').textContent = '';
  };
  
  $('#submitReset').onclick = async () => {
    const email = $('#resetEmail').value.trim();
    if (!email) {
      $('#resetMsg').textContent = 'Please enter your email';
      return;
    }
    
    try {
      await sendPasswordResetEmail(auth, email);
      
      // Store password reset request for admin
      if (isAdminUser) {
        const requestId = push(ref(db, 'passwordResetRequests')).key;
        await set(ref(db, `passwordResetRequests/${requestId}`), {
          email,
          timestamp: Date.now(),
          status: 'pending'
        });
      }
      
      $('#resetMsg').textContent = 'Password reset email sent!';
      toast('Password reset email sent! Check your inbox.', 5000, 'success');
      
      setTimeout(() => {
        $('#passwordResetModal').classList.add('hidden');
        $('#resetMsg').textContent = '';
      }, 3000);
    } catch (error) {
      $('#resetMsg').textContent = error.message;
      toast('Failed to send reset email: ' + error.message, 5000, 'error');
    }
  };
}

// NEW: Load password reset requests for admin
async function loadPasswordResetRequests() {
  if (!isAdminUser) return;
  
  const requestsRef = ref(db, 'passwordResetRequests');
  onValue(requestsRef, (snapshot) => {
    const requests = snapshot.val() || {};
    const container = $('#passwordResetRequests');
    container.innerHTML = '';
    
    Object.entries(requests)
      .sort(([,a], [,b]) => b.timestamp - a.timestamp)
      .forEach(([id, request]) => {
        if (request.status === 'pending') {
          const requestEl = document.createElement('div');
          requestEl.className = 'password-reset-request';
          requestEl.innerHTML = `
            <div class="request-info">
              <div class="user-details">
                <div>
                  <strong>${request.email}</strong>
                  <div style="color:var(--muted);font-size:.8rem">${timeAgo(request.timestamp)} ago</div>
                </div>
              </div>
              <div class="request-actions">
                <button class="btn" data-action="approve" data-id="${id}">Approve</button>
                <button class="btn ghost" data-action="deny" data-id="${id}">Deny</button>
              </div>
            </div>
          `;
          
          container.appendChild(requestEl);
        }
      });
    
    // Add event listeners to buttons
    container.querySelectorAll('button[data-action="approve"]').forEach(btn => {
      btn.onclick = async () => {
        const requestId = btn.dataset.id;
        await update(ref(db, `passwordResetRequests/${requestId}`), { status: 'approved' });
        toast('Password reset request approved', 3000, 'success');
        addAdminLog('Password reset approved', `Email: ${requests[requestId].email}`);
      };
    });
    
    container.querySelectorAll('button[data-action="deny"]').forEach(btn => {
      btn.onclick = async () => {
        const requestId = btn.dataset.id;
        await update(ref(db, `passwordResetRequests/${requestId}`), { status: 'denied' });
        toast('Password reset request denied', 3000, 'info');
        addAdminLog('Password reset denied', `Email: ${requests[requestId].email}`);
      };
    });
  });
}

// NEW: Disappearing Messages Functions
function setupDisappearingMessages() {
  // Load user's disappearing messages setting
  if (me && me.uid) {
    const disappearingRef = ref(db, `users/${me.uid}/disappearingMessages`);
    onValue(disappearingRef, (snapshot) => {
      if (snapshot.exists()) {
        disappearingTimeout = snapshot.val().timeout || 0;
        disappearingMessagesEnabled = disappearingTimeout > 0;
        
        // Update UI
        $('#disappearingTimeout').value = disappearingTimeout;
        updateDisappearingToggle();
      }
    });
  }
  
  // Settings change handler
  $('#disappearingTimeout').onchange = async (e) => {
    const timeout = parseInt(e.target.value);
    disappearingTimeout = timeout;
    disappearingMessagesEnabled = timeout > 0;
    
    if (me && me.uid) {
      await update(ref(db, `users/${me.uid}/disappearingMessages`), {
        timeout,
        enabled: disappearingMessagesEnabled
      });
    }
    
    updateDisappearingToggle();
    toast(`Disappearing messages ${disappearingMessagesEnabled ? 'enabled' : 'disabled'}`, 3000, 'success');
  };
  
  // Chat toggle handler
  $('#disappearingToggle').onclick = () => {
    disappearingMessagesEnabled = !disappearingMessagesEnabled;
    
    if (me && me.uid) {
      update(ref(db, `users/${me.uid}/disappearingMessages`), {
        timeout: disappearingMessagesEnabled ? disappearingTimeout : 0,
        enabled: disappearingMessagesEnabled
      });
    }
    
    updateDisappearingToggle();
    toast(`Disappearing messages ${disappearingMessagesEnabled ? 'enabled' : 'disabled'} for this chat`, 3000, 'success');
  };
}

function updateDisappearingToggle() {
  const toggle = $('#disappearingToggle');
  if (disappearingMessagesEnabled) {
    toggle.style.background = 'var(--warning)';
    toggle.style.color = 'white';
    toggle.title = 'Disappearing messages: ON';
  } else {
    toggle.style.background = '';
    toggle.style.color = '';
    toggle.title = 'Disappearing messages: OFF';
  }
}

// NEW: Schedule message deletion for disappearing messages
function scheduleMessageDeletion(messageKey, chatId, timeout) {
  if (timeout <= 0) return;
  
  setTimeout(async () => {
    // Check if message still exists and hasn't been read by all recipients
    const basePath = currentChat.uid 
      ? `chats/${chatId}/messages/${messageKey}`
      : `communityMessages/${chatId}/messages/${messageKey}`;
    
    const messageSnap = await get(ref(db, basePath));
    if (messageSnap.exists()) {
      const message = messageSnap.val();
      
      // Check if all recipients have read the message
      const readsSnap = await get(ref(db, `reads/${chatId}/${messageKey}`));
      if (readsSnap.exists()) {
        const readers = Object.keys(readsSnap.val());
        
        // For DMs, check if both users have read it
        if (currentChat.uid) {
          const expectedReaders = [me.uid, currentChat.uid];
          const allRead = expectedReaders.every(uid => readers.includes(uid));
          
          if (allRead) {
            await remove(ref(db, basePath));
            toast('Message disappeared', 2000, 'info');
          }
        } else {
          // For groups, delete after timeout regardless of reads
          await remove(ref(db, basePath));
          toast('Message disappeared', 2000, 'info');
        }
      }
    }
  }, timeout);
}

// Enhanced Admin Features
async function updateAdminStats() {
  if (!isAdminUser) return;
  
  const usersRef = ref(db, 'users');
  const messagesRef = ref(db, 'chats');
  const bannedRef = ref(db, 'banned');
  
  const [usersSnap, messagesSnap, bannedSnap] = await Promise.all([
    get(usersRef),
    get(messagesRef),
    get(bannedRef)
  ]);
  
  const users = usersSnap.exists() ? usersSnap.val() : {};
  const messages = messagesSnap.exists() ? messagesSnap.val() : {};
  const banned = bannedSnap.exists() ? bannedSnap.val() : {};
  
  const onlineUsers = Object.values(users).filter(user => user.online).length;
  
  let totalMessages = 0;
  for (const chatId in messages) {
    const chatMessages = messages[chatId]?.messages;
    if (chatMessages) {
      totalMessages += Object.keys(chatMessages).length;
    }
  }
  
  $('#totalUsers').textContent = Object.keys(users).length;
  $('#onlineUsers').textContent = onlineUsers;
  $('#totalMessages').textContent = totalMessages;
  $('#bannedUsers').textContent = Object.keys(banned).length;
}

function addAdminLog(action, details = '') {
  if (!isAdminUser || !me) return;
  
  const logEntry = {
    action,
    details,
    admin: me.name || me.email,
    timestamp: Date.now()
  };
  
  const logRef = push(ref(db, 'adminLogs'));
  set(logRef, logEntry);
  
  const logContainer = $('#adminLogEntries');
  const logItem = document.createElement('div');
  logItem.className = 'log-entry';
  logItem.innerHTML = `
    <strong>${logEntry.admin}</strong>: ${action}
    ${details ? `<br><small>${details}</small>` : ''}
    <div style="color:var(--muted);font-size:0.7rem">${new Date(logEntry.timestamp).toLocaleTimeString()}</div>
  `;
  
  logContainer.insertBefore(logItem, logContainer.firstChild);
  
  if (logContainer.children.length > 10) {
    logContainer.removeChild(logContainer.lastChild);
  }
}

async function refreshAdminUsers(filter = 'all') {
  const wrap = $('#adminUsersList'); 
  wrap.innerHTML = '<div style="text-align:center;padding:1rem;color:var(--muted)">Loading users...</div>';
  
  const s = await get(ref(db, 'users'));
  if(!s.exists()){ 
    wrap.textContent = 'No users yet'; 
    return; 
  }
  
  const users = s.val();
  wrap.innerHTML = '';
  
  for(const uid in users){
    const u = users[uid];
    
    if (filter === 'online' && !u.online) continue;
    if (filter === 'verified' && !u.verified) continue;
    if (filter === 'banned') {
      const bannedSnap = await get(ref(db, `banned/${uid}`));
      if (!bannedSnap.exists()) continue;
    }
    
    const div = document.createElement('div'); 
    div.className='item';
    div.innerHTML = `
      <img src="${u.avatar||defaultAvatar(uid)}" class="avatar" />
      <div style="flex:1">
        <div style="font-weight:700">${u.name || u.email || uid}</div>
        <div style="color:var(--muted);font-size:.85rem">
          ${u.email||''} - ${u.shortId||''} 
          ${u.verified? ' ‚úÖ':''} 
          ${u.online? ' üü¢':''}
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="btn ghost" data-uid="${uid}" data-action="verify">${u.verified ? 'Unverify' : 'Verify'}</button>
        <button class="btn ghost" data-uid="${uid}" data-action="ban">Ban</button>
      </div>
    `;
    wrap.appendChild(div);
  }
  
  wrap.querySelectorAll('button[data-action]').forEach(b=>{
    b.onclick = async ()=>{
      const uid = b.dataset.uid; 
      const action = b.dataset.action;
      
      if(action==='verify'){
        const newVerified = !(await get(ref(db, `users/${uid}/verified`))).exists();
        await update(ref(db, `users/${uid}`), { verified: newVerified });
        addAdminLog(`User ${newVerified ? 'verified' : 'unverified'}`, `UID: ${uid}`);
        toast(`${newVerified ? 'Verified' : 'Unverified'} user`, 2000, 'success');
      }
      
      if(action==='ban'){
        await set(ref(db, `banned/${uid}`), true);
        addAdminLog('User banned', `UID: ${uid}`);
        toast('User banned', 2000, 'success');
      }
      
      await refreshAdminUsers(filter);
    };
  });
}

// Enhanced Friend Request System with Notifications
async function sendFriendRequestByShortId(shortId){
  $('#friendRequestMsg').textContent = '';
  if(!me) return toast('Sign in first', 3000, 'error');
  const v = (shortId||'').trim();
  if(v.length !== 5) { 
    $('#friendRequestMsg').textContent = 'Enter a valid 5-digit ID'; 
    toast('Enter a valid 5-digit ID', 3000, 'error'); 
    return; 
  }

  const shortSnap = await get(ref(db, 'shortIds/' + v));
  if(!shortSnap.exists()){ 
    $('#friendRequestMsg').textContent = 'No user with that ID'; 
    toast('No user with that ID', 3000, 'error'); 
    return; 
  }
  const targetUid = shortSnap.val().uid;

  if(targetUid === me.uid){ 
    $('#friendRequestMsg').textContent = 'Cannot add yourself'; 
    toast('Cannot add yourself', 3000, 'error'); 
    return; 
  }

  const already = await get(ref(db, `friends/${me.uid}/${targetUid}`));
  if(already.exists()){ 
    $('#friendRequestMsg').textContent = 'Already friends'; 
    toast('Already friends', 3000, 'info'); 
    return; 
  }

  const pk = pairKey(me.uid, targetUid);
  const pairSnap = await get(ref(db, `requestPairs/${pk}`));
  if(pairSnap.exists()){ 
    $('#friendRequestMsg').textContent = 'Request already pending'; 
    toast('Request already pending', 3000, 'info'); 
    return; 
  }

  const targetUserSnap = await get(ref(db, 'users/' + targetUid));
  const targetUser = targetUserSnap.val() || {};
  const reqId = push(ref(db, 'friendRequests/_tmp')).key;
  const now = Date.now();

  await set(ref(db, `friendRequests/${me.uid}/outgoing/${reqId}`), {
    toUid: targetUid,
    toName: targetUser.name || targetUser.email || targetUid,
    toAvatar: targetUser.avatar || '',
    ts: now
  });

  await set(ref(db, `friendRequests/${targetUid}/incoming/${reqId}`), {
    fromUid: me.uid,
    fromName: me.name || me.email || me.uid,
    fromAvatar: me.avatar || '',
    ts: now
  });

  await set(ref(db, `requestPairs/${pk}`), true);

  addNotification(`You have a new friend request from ${me.name || me.email}`, 'info');
  
  $('#friendRequestMsg').textContent = 'Request sent';
  toast('Friend request sent!', 3000, 'success');
  await loadFriendRequests();
  await updateFriendStats();
  await loadFriendSuggestions();
}

// Enhanced accept friend request with notifications
async function acceptFriendRequest(reqId, fromUid){
  if(!me) return;
  const pk = pairKey(me.uid, fromUid);

  await set(ref(db, `friends/${me.uid}/${fromUid}`), true);
  await set(ref(db, `friends/${fromUid}/${me.uid}`), true);

  await remove(ref(db, `friendRequests/${me.uid}/incoming/${reqId}`));
  await remove(ref(db, `friendRequests/${fromUid}/outgoing/${reqId}`));
  await remove(ref(db, `requestPairs/${pk}`));

  addNotification(`${me.name || me.email} accepted your friend request!`, 'success');
  
  toast('Friend added!', 2000, 'success');
  await refreshFriends();
  await loadFriendRequests();
  await updateFriendStats();
  await loadActivityFeed();
  await loadFriendSuggestions();
}

// Get friend requests for statistics
async function getFriendRequests() {
  if (!me || !me.uid) return { incoming: [], outgoing: [] };
  
  const requestsRef = ref(db, `friendRequests/${me.uid}`);
  const requestsSnap = await get(requestsRef);
  
  if (!requestsSnap.exists()) return { incoming: [], outgoing: [] };
  
  const requests = requestsSnap.val();
  return {
    incoming: Object.keys(requests.incoming || {}),
    outgoing: Object.keys(requests.outgoing || {})
  };
}

// Initialize enhanced features when user logs in
function initializeEnhancedFeatures() {
  loadNotifications();
  loadFriendSuggestions();
  updateFriendStats();
  loadActivityFeed();
  setupForgotPassword();
  setupDisappearingMessages();
  
  if (isAdminUser) {
    updateAdminStats();
    setInterval(updateAdminStats, 30000);
    loadPasswordResetRequests();
    addAdminLog('Admin panel accessed');
  }
  
  $('#notificationBell').onclick = (e) => {
    e.stopPropagation();
    const dropdown = $('#notificationDropdown');
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
  };
  
  $('#clearNotifications').onclick = async () => {
    if (!me || !me.uid) return;
    await remove(ref(db, `notifications/${me.uid}`));
    notificationCount = 0;
    updateNotificationBadge();
    toast('Notifications cleared', 2000, 'success');
  };
  
  document.addEventListener('click', () => {
    $('#notificationDropdown').style.display = 'none';
  });
  
  $('#findFriendsBtn').onclick = () => {
    loadFriendSuggestions();
    toast('Refreshing friend suggestions...', 2000, 'info');
  };
  
  $('#refreshSuggestions').onclick = () => {
    loadFriendSuggestions();
    toast('Refreshing suggestions...', 2000, 'info');
  };
  
  $$('.filter-btn').forEach(btn => {
    btn.onclick = () => {
      $$('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      refreshAdminUsers(btn.dataset.filter);
    };
  });
  
  $('#adminRefreshStats').onclick = updateAdminStats;
  $('#adminSystemCheck').onclick = () => {
    addAdminLog('System check performed');
    toast('System check completed', 2000, 'success');
  };
  
  $('#adminClearChat').onclick = async () => {
    const chatId = $('#adminChatId').value.trim();
    if (!chatId) {
      toast('Enter chat ID', 3000, 'error');
      return;
    }
    
    if (confirm('Are you sure you want to clear this entire chat?')) {
      await remove(ref(db, `chats/${chatId}/messages`));
      await remove(ref(db, `communityMessages/${chatId}/messages`));
      addAdminLog('Chat cleared', `Chat ID: ${chatId}`);
      toast('Chat cleared', 2000, 'success');
    }
  };
}

// Discord-style features initialization
function initializeDiscordFeatures() {
  // Discord emoji picker
  const emojiPicker = $('#discordEmojiPicker');
  const emojiButton = $('#discordEmojiButton');
  
  emojiButton.onclick = () => {
    emojiPicker.classList.toggle('active');
  };
  
  // Populate emoji picker
  const emojiBody = emojiPicker.querySelector('.discord-emoji-picker-body');
  const commonEmojis = ['üòÄ', 'üòÇ', 'ü•∞', 'üòé', 'ü§î', 'üò¥', 'üò≠', 'üò°', 'üëç', 'üëé', '‚ù§Ô∏è', 'üî•', 'üéâ', 'üôè', 'üíØ', 'ü§ù'];
  
  commonEmojis.forEach(emoji => {
    const emojiItem = document.createElement('div');
    emojiItem.className = 'discord-emoji-item';
    emojiItem.textContent = emoji;
    emojiItem.onclick = () => {
      const msgInput = $('#msgInput');
      msgInput.value += emoji;
      emojiPicker.classList.remove('active');
      msgInput.focus();
    };
    emojiBody.appendChild(emojiItem);
  });
  
  // Discord channel switching
  $$('.discord-channel-item').forEach(channel => {
    channel.onclick = () => {
      $$('.discord-channel-item').forEach(c => c.classList.remove('active'));
      channel.classList.add('active');
      
      const channelName = channel.querySelector('.discord-channel-name').textContent;
      toast(`Switched to #${channelName}`, 2000, 'success');
    };
  });
  
  // Discord server switching
  $$('.discord-server-icon').forEach(server => {
    server.onclick = () => {
      $$('.discord-server-icon').forEach(s => s.classList.remove('active'));
      server.classList.add('active');
      
      const serverName = server.textContent;
      toast(`Switched to ${serverName === 'QC' ? 'QuickChat' : serverName} server`, 2000, 'success');
    };
  });
  
  // Close emoji picker when clicking outside
  document.addEventListener('click', (e) => {
    if (!emojiPicker.contains(e.target) && e.target !== emojiButton) {
      emojiPicker.classList.remove('active');
    }
  });
}

// Existing functions from original code
$('#loginBtn').onclick = async () => {
  try {
    await signInWithEmailAndPassword(auth, $('#loginEmail').value, $('#loginPass').value);
    $('#authMsg').textContent = '';
    toast('Welcome back!', 2000, 'success');
  } catch (e) { 
    $('#authMsg').textContent = e.message;
    toast('Login failed: ' + e.message, 3000, 'error');
  }
};

$('#registerBtn').onclick = async () => {
  try {
    const email = $('#loginEmail').value.trim();
    const pass = $('#loginPass').value;
    if(!email||!pass){ 
      $('#authMsg').textContent='Enter email & password'; 
      toast('Please enter email and password', 3000, 'error');
      return; 
    }
    if(pass.length < 6){ 
      $('#authMsg').textContent='Password must be at least 6 characters'; 
      toast('Password must be at least 6 characters', 3000, 'error');
      return; 
    }
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    const uid = cred.user.uid;
    const short = String(10000 + Math.floor(Math.random()*90000));
    await set(ref(db, 'users/' + uid), {
      uid,
      email,
      name: cred.user.displayName || email.split('@')[0],
      avatar: defaultAvatar(uid),
      shortId: short,
      createdAt: Date.now(),
      online: true,
      lastSeen: Date.now(),
      status: 'online'
    });
    await set(ref(db, 'shortIds/' + short), { uid });
    toast('Registration successful! Check profile to edit', 3000, 'success');
  } catch (e){ 
    $('#authMsg').textContent = e.message;
    toast('Registration failed: ' + e.message, 3000, 'error');
  }
};

$('#googleBtn').onclick = async () => {
  try {
    const prov = new GoogleAuthProvider();
    const cred = await signInWithPopup(auth, prov);
    const uid = cred.user.uid;
    const uref = ref(db, 'users/' + uid);
    const s = await get(uref);
    if(!s.exists()){
      const short = String(10000 + Math.floor(Math.random()*90000));
      await set(uref, {
        uid,
        email: cred.user.email,
        name: cred.user.displayName || cred.user.email,
        avatar: cred.user.photoURL || defaultAvatar(uid),
        shortId: short,
        createdAt: Date.now(),
        online: true,
        lastSeen: Date.now(),
        status: 'online'
      });
      await set(ref(db, 'shortIds/' + short), { uid });
    }
    toast('Signed in with Google!', 2000, 'success');
  } catch (e){ 
    $('#authMsg').textContent = e.message;
    toast('Google sign-in failed: ' + e.message, 3000, 'error');
  }
};

async function injectAdminPanel(){
  if(!isAdminUser) return;
  
  $('#adminLookupBtn').onclick = async () => {
    const v = $('#adminTarget').value.trim();
    if(!v){ toast('Enter UID or 5-digit ID', 3000, 'error'); return; }
    let uid = v;
    if(v.length === 5){
      const s = await get(ref(db, 'shortIds/' + v));
      if(!s.exists()){ toast('No such shortId', 3000, 'error'); return; }
      uid = s.val().uid;
    }
    const u = await get(ref(db, 'users/' + uid));
    if(!u.exists()){ toast('User not found', 3000, 'error'); return; }
    const data = u.val();
    toast('Found: ' + (data.name || data.email || uid), 3000, 'success');
  };

  $('#adminVerifyBtn').onclick = async () => {
    const v = $('#adminTarget').value.trim(); if(!v){ toast('Enter UID or 5-digit ID', 3000, 'error'); return; }
    let uid = v;
    if(v.length===5){
      const s = await get(ref(db,'shortIds/'+v));
      if(!s.exists()){ toast('No such shortId', 3000, 'error'); return; }
      uid = s.val().uid;
    }
    await update(ref(db, 'users/' + uid), { verified: true });
    toast('User verified', 2000, 'success');
    await refreshAdminUsers();
  };
  
  $('#adminUnverifyBtn').onclick = async ()=> {
    const v = $('#adminTarget').value.trim(); if(!v) return toast('Enter UID or 5-digit ID', 3000, 'error');
    let uid=v; if(v.length===5){ const s=await get(ref(db,'shortIds/'+v)); if(!s.exists()){ toast('No shortId', 3000, 'error'); return; } uid=s.val().uid; }
    await update(ref(db,'users/'+uid), { verified: false });
    toast('User unverified', 2000, 'success'); 
    await refreshAdminUsers();
  };
  
  $('#adminBanBtn').onclick = async () => {
    const v = $('#adminTarget').value.trim(); if(!v) return toast('Enter UID or 5-digit ID', 3000, 'error'); 
    let uid=v; if(v.length===5){ const s=await get(ref(db,'shortIds/'+v)); if(!s.exists()){ toast('No shortId', 3000, 'error'); return; } uid=s.val().uid; }
    await set(ref(db,'banned/'+uid), true); 
    toast('User banned', 2000, 'success'); 
    await refreshAdminUsers();
  };
  
  $('#adminUnbanBtn').onclick = async () => {
    const v = $('#adminTarget').value.trim(); if(!v) return toast('Enter UID or 5-digit ID', 3000, 'error'); 
    let uid=v; if(v.length===5){ const s=await get(ref(db,'shortIds/'+v)); if(!s.exists()){ toast('No shortId', 3000, 'error'); return; } uid=s.val().uid; }
    await remove(ref(db,'banned/'+uid)); 
    toast('User unbanned', 2000, 'success'); 
    await refreshAdminUsers();
  };
  
  $('#adminDelMsgBtn').onclick = async () => {
    const chatId = $('#adminChatId').value.trim(); 
    const msgKey = $('#adminMsgKey').value.trim();
    if(!chatId || !msgKey){ toast('Enter chat id and message key', 3000, 'error'); return; }
    await remove(ref(db, `chats/${chatId}/messages/${msgKey}`));
    await remove(ref(db, `communityMessages/${chatId}/${msgKey}`));
    toast('Message removed (if existed)', 2000, 'success');
  };
  
  $('#adminRefreshUsers').onclick = refreshAdminUsers;

  $('#adminAnnSet').onclick = async ()=>{
    const t = $('#adminAnnText').value.trim();
    await set(ref(db, 'announcements/global'), { text: t, ts: Date.now(), by: me.uid });
    toast('Announcement set', 2000, 'success');
  };
  
  $('#adminAnnClear').onclick = async ()=>{
    await remove(ref(db, 'announcements/global'));
    toast('Announcement cleared', 2000, 'success');
  };

  await refreshAdminUsers();
}

async function isBanned(uid){
  const s = await get(ref(db, 'banned/' + uid));
  return s.exists();
}

function roomIdFor(a,b){ return [a,b].sort().join('_'); }

async function getUnreadCount(chatId){
  const readsSnap = await get(ref(db, `reads/${chatId}`));
  if(!readsSnap.exists()) return 0;
  const reads = readsSnap.val();
  let count = 0;
  for(const mk in reads){
    if(!reads[mk] || !reads[mk][me.uid]) count++;
  }
  return count;
}

async function refreshFriends(){
  if(!me) return;
  const wrap = $('#friendsList'); wrap.innerHTML = '';
  const s = await get(ref(db, 'friends/' + me.uid));
  const ids = s.exists()? Object.keys(s.val()): [];
  for(const fid of ids){
    const uSnap = await get(ref(db, 'users/' + fid));
    const u = uSnap.val(); if(!u) continue;
    const id = roomIdFor(me.uid, u.uid);
    const unread = await getUnreadCount(id);
    const it = document.createElement('div'); it.className = 'item';
    it.innerHTML = `<img class="avatar" src="${u.avatar||defaultAvatar(u.uid)}" />
      <div style="flex:1">
        <div style="font-weight:700;display:flex;justify-content:space-between;align-items:center">
          <span>${u.name||u.email}</span>
          ${unread>0? `<span style="background:#1b3d74;color:#dfefff;font-size:.75rem;padding:2px 8px;border-radius:999px">${unread}</span>`:''}
        </div>
        <div style="color:var(--muted);font-size:.85rem">
          <span class="status-indicator status-${u.status || (u.online ? 'online' : 'offline')}"></span>
          ${u.status === 'online' ? 'online' : u.status === 'away' ? 'away' : u.status === 'busy' ? 'busy' : 'last '+timeAgo(u.lastSeen)}
        </div>
      </div>`;
    it.onclick = ()=> openDM(u);
    wrap.appendChild(it);
  }
}

async function loadCommunities(){
  const wrap = $('#communitiesList'); wrap.innerHTML = '';
  const cs = await get(ref(db, 'communities'));
  if(!cs.exists()) return;
  const data = cs.val();
  for(const id in data){
    const c = data[id];
    const unread = await getUnreadCount(c.id);
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div style="flex:1">
        <div style="font-weight:700;display:flex;justify-content:space-between;align-items:center">
          <span>${c.name}</span>
          ${unread>0? `<span style="background:#1b3d74;color:#dfefff;font-size:.75rem;padding:2px 8px;border-radius:999px">${unread}</span>`:''}
        </div>
        <div style="color:var(--muted)">${c.id}</div></div>
      <button class="btn ghost">Open</button>`;
    it.querySelector('button').onclick = ()=> openGroup(c);
    wrap.appendChild(it);
  }
}

function openChatPanel(peer){
  currentChat = peer;
  $('#chatTitle').textContent = peer.name || peer.id || 'Chat';
  $('#chatAvatar').src = peer.avatar || defaultAvatar(peer.uid || peer.id);
  $('#messages').innerHTML = '';
}

const chatBackBtn = $('#chatBackBtn');
chatBackBtn.onclick = () => {
  document.getElementById('appUI').classList.remove('fullscreen-chat');
  chatBackBtn.style.display = 'none';
  currentChat = null;
  $('#chatTitle').textContent = 'No chat';
  $('#chatAvatar').src = '';
  $('#messages').innerHTML = '';
};

async function openDM(u){
  openChatPanel(u);
  document.getElementById('appUI').classList.add('fullscreen-chat');
  chatBackBtn.style.display = 'inline-block';
  const id = roomIdFor(me.uid, u.uid);
  subscribeMessages('chats/' + id + '/messages', id, 'dm', u);
}

async function openGroup(c){
  openChatPanel(c);
  document.getElementById('appUI').classList.remove('fullscreen-chat');
  chatBackBtn.style.display = 'none';
  subscribeMessages('communityMessages/' + c.id, c.id, 'group', c);
}

function showReactionPicker(messageKey, chatId, buttonElement) {
  const picker = document.createElement('div');
  picker.className = 'reaction-picker';
  
  EMOJIS.forEach(emoji => {
    const emojiEl = document.createElement('div');
    emojiEl.className = 'reaction-emoji';
    emojiEl.textContent = emoji;
    emojiEl.onclick = () => {
      addReactionToMessage(messageKey, chatId, emoji);
      picker.remove();
    };
    picker.appendChild(emojiEl);
  });
  
  const rect = buttonElement.getBoundingClientRect();
  picker.style.top = (rect.top - 50) + 'px';
  picker.style.left = rect.left + 'px';
  
  document.body.appendChild(picker);
  
  setTimeout(() => {
    const closePicker = (e) => {
      if (!picker.contains(e.target) && e.target !== buttonElement) {
        picker.remove();
        document.removeEventListener('click', closePicker);
      }
    };
    document.addEventListener('click', closePicker);
  }, 100);
}

async function addReactionToMessage(messageKey, chatId, reaction) {
  const basePath = currentChat.uid 
    ? `chats/${chatId}/messages/${messageKey}/reactions/${reaction}/${me.uid}`
    : `communityMessages/${chatId}/messages/${messageKey}/reactions/${reaction}/${me.uid}`;
  
  const reactionRef = ref(db, basePath);
  const snap = await get(reactionRef);
  
  if (snap.exists()) {
    await remove(reactionRef);
  } else {
    await set(reactionRef, true);
  }
}

function showMessageContextMenu(e, message, messageKey, chatId) {
  e.preventDefault();
  
  const contextMenu = $('#contextMenu');
  contextMenu.innerHTML = '';
  contextMenu.classList.remove('hidden');
  
  contextMenu.style.left = e.pageX + 'px';
  contextMenu.style.top = e.pageY + 'px';
  
  const reactOption = document.createElement('div');
  reactOption.className = 'context-menu-item';
  reactOption.textContent = 'Add Reaction';
  reactOption.onclick = () => {
    showReactionPicker(messageKey, chatId, reactOption);
    contextMenu.classList.add('hidden');
  };
  contextMenu.appendChild(reactOption);
  
  const replyOption = document.createElement('div');
  replyOption.className = 'context-menu-item';
  replyOption.textContent = 'Reply';
  replyOption.onclick = () => {
    $('#msgInput').value = `@${message.fromName} `;
    $('#msgInput').focus();
    contextMenu.classList.add('hidden');
  };
  contextMenu.appendChild(replyOption);
  
  if (isAdminUser) {
    const pinOption = document.createElement('div');
    pinOption.className = 'context-menu-item';
    pinOption.textContent = message.pinned ? 'Unpin Message' : 'Pin Message';
    pinOption.onclick = async () => {
      const basePath = currentChat.uid 
        ? `chats/${chatId}/messages/${messageKey}`
        : `communityMessages/${chatId}/messages/${messageKey}`;
      
      await update(ref(db, basePath), { pinned: !message.pinned });
      contextMenu.classList.add('hidden');
    };
    contextMenu.appendChild(pinOption);
  }
  
  setTimeout(() => {
    const closeMenu = (e) => {
      if (!contextMenu.contains(e.target)) {
        contextMenu.classList.add('hidden');
        document.removeEventListener('click', closeMenu);
      }
    };
    document.addEventListener('click', closeMenu);
  }, 100);
}

function subscribeMessages(path, chatId, kind, peer){
  if(unsubMessages) unsubMessages();
  const r = ref(db, path);
  onValue(r, async snap => {
    const data = snap.val() || {};
    $('#messages').innerHTML = '';
    const entries = Object.entries(data).sort((a,b)=>a[1].ts - b[1].ts);

    let pinnedMessages = [];
    let regularMessages = [];

    for(const [key,m] of entries){
      if (m.pinned) {
        pinnedMessages.push([key, m]);
      } else {
        regularMessages.push([key, m]);
      }
    }

    if (pinnedMessages.length > 0) {
      const pinnedHeader = document.createElement('div');
      pinnedHeader.textContent = 'üìå Pinned Messages';
      pinnedHeader.style.color = 'var(--muted)';
      pinnedHeader.style.marginBottom = '8px';
      $('#messages').appendChild(pinnedHeader);
      
      for(const [key,m] of pinnedMessages){
        renderMessage(key, m, chatId);
      }
      
      const divider = document.createElement('div');
      divider.style.borderTop = '1px solid var(--border)';
      divider.style.margin = '12px 0';
      $('#messages').appendChild(divider);
    }

    for(const [key,m] of regularMessages){
      renderMessage(key, m, chatId);
    }

    $('#messages').scrollTop = $('#messages').scrollHeight;
  });

  const tRef = ref(db, `typing/${chatId}`);
  const offTyping = onValue(tRef, snap=>{
    const obj = snap.val() || {};
    const someoneElseTyping = Object.keys(obj).some(uid => uid !== me.uid && obj[uid] === true);
    $('#typingIndicator').style.display = someoneElseTyping ? 'block' : 'none';
  });

  unsubMessages = ()=>{
    offTyping();
  };
}

async function renderMessage(key, m, chatId) {
  const div = document.createElement('div'); 
  div.className = `message-item ${m.from === me.uid ? 'own' : 'other'}`;
  div.setAttribute('data-message-id', key);
  
  // NEW: Add disappearing message styling if applicable
  if (m.disappearing && m.disappearingTimeout) {
    div.classList.add('disappearing-message');
    
    // Calculate remaining time
    const elapsed = Date.now() - m.ts;
    const remaining = m.disappearingTimeout - elapsed;
    
    if (remaining > 0) {
      const timerEl = document.createElement('div');
      timerEl.className = 'message-timer';
      
      // Show warning if less than 10 seconds remain
      if (remaining < 10000) {
        div.classList.add('expiring');
      }
      
      timerEl.innerHTML = `
        <span class="timer-icon">‚è±Ô∏è</span>
        <span>${Math.ceil(remaining / 1000)}s</span>
      `;
      
      // Add timer to message
      setTimeout(() => {
        if (div.parentNode) {
          const contentEl = div.querySelector('.message-content');
          if (contentEl && !contentEl.querySelector('.message-timer')) {
            contentEl.appendChild(timerEl);
          }
        }
      }, 100);
    }
  }
  
  setTimeout(() => {
    div.classList.add('new-message');
  }, 100);

  if (m.pinned) {
    div.classList.add('pinned-message');
  }
  
  div.innerHTML = `
    <img class="avatar" src="${m.fromAvatar || defaultAvatar(m.from)}" />
    <div class="message-content">
      <div class="message-sender">
        ${m.pinned ? '<span class="pin-indicator">üìå</span>' : ''}
        ${m.fromName||''}
        ${m.editedAt?'<span style="color:var(--muted);font-size:.75rem"> - edited</span>':''}
      </div>
      <div class="message-text">${m.text||''}</div>
      ${m.replyTo ? '<div style="color:var(--muted);font-size:.85rem;border-left:2px solid var(--brand);padding-left:8px;margin:4px 0">‚Ü™Ô∏è ' + (m.replyToText || 'Replied to a message') + '</div>' : ''}
      <div class="message-time">${new Date(m.ts).toLocaleTimeString()}</div>
    </div>`;
  
  if(m.imageURL){
    const imgContainer = document.createElement('div');
    imgContainer.className = 'file-preview';
    
    const img = document.createElement('img');
    img.src = m.imageURL;
    img.style.cursor = 'pointer';
    img.onclick = () => window.open(m.imageURL, '_blank');
    
    const fileInfo = document.createElement('div');
    fileInfo.className = 'file-info';
    fileInfo.textContent = 'Click to view full image';
    
    imgContainer.appendChild(img);
    imgContainer.appendChild(fileInfo);
    div.querySelector('.message-content').appendChild(imgContainer);
  }
  
  if(m.audioURL){
    const audioContainer = document.createElement('div');
    audioContainer.className = 'voice-message';
    
    const playBtn = document.createElement('button');
    playBtn.className = 'voice-play-btn';
    playBtn.innerHTML = '‚ñ∂';
    
    const progress = document.createElement('div');
    progress.className = 'voice-progress';
    
    const progressBar = document.createElement('div');
    progressBar.className = 'voice-progress-bar';
    
    const duration = document.createElement('div');
    duration.className = 'voice-duration';
    duration.textContent = m.audioDuration ? formatDuration(m.audioDuration) : '0:00';
    
    progress.appendChild(progressBar);
    audioContainer.appendChild(playBtn);
    audioContainer.appendChild(progress);
    audioContainer.appendChild(duration);
    
    let audio = new Audio(m.audioURL);
    audio.addEventListener('loadedmetadata', () => {
      if (!m.audioDuration) {
        duration.textContent = formatDuration(audio.duration);
      }
    });
    
    audio.addEventListener('timeupdate', () => {
      const percent = (audio.currentTime / audio.duration) * 100;
      progressBar.style.width = percent + '%';
    });
    
    audio.addEventListener('ended', () => {
      playBtn.innerHTML = '‚ñ∂';
      progressBar.style.width = '0%';
      audio.currentTime = 0;
    });
    
    playBtn.onclick = () => {
      if (audio.paused) {
        audio.play();
        playBtn.innerHTML = '‚è∏';
      } else {
        audio.pause();
        playBtn.innerHTML = '‚ñ∂';
      }
    };
    
    div.querySelector('.message-content').appendChild(audioContainer);
  }
  
  if (m.reactions) {
    const reactionContainer = document.createElement('div');
    reactionContainer.className = 'reaction-container';
    
    for (const [emoji, users] of Object.entries(m.reactions)) {
      const count = Object.keys(users || {}).length;
      if (count > 0) {
        const reactionBtn = document.createElement('div');
        reactionBtn.className = 'reaction';
        reactionBtn.innerHTML = `${emoji} ${count}`;
        reactionBtn.onclick = () => addReactionToMessage(key, chatId, emoji);
        reactionContainer.appendChild(reactionBtn);
      }
    }
    
    if (reactionContainer.children.length > 0) {
      div.querySelector('.message-content').appendChild(reactionContainer);
    }
  }
  
  if(m.from === me.uid){
    const row = document.createElement('div');
    row.style.display='flex'; row.style.gap='6px'; row.style.marginTop='6px';
    
    const delBtn = document.createElement('button');
    delBtn.className = 'btn ghost'; delBtn.textContent = 'Delete';
    delBtn.onclick = async ()=>{
      const basePath = currentChat.uid ? `chats/${chatId}/messages/${key}` : `communityMessages/${chatId}/${key}`;
      await remove(ref(db, basePath));
      toast('Message deleted', 2000, 'success');
    };
    row.appendChild(delBtn);
    
    const EDIT_WINDOW_MS = 120000;
    if(Date.now() - m.ts <= EDIT_WINDOW_MS){
      const editBtn = document.createElement('button');
      editBtn.className = 'btn ghost'; editBtn.textContent = 'Edit';
      editBtn.onclick = async ()=>{
        const newText = prompt('Edit message:', m.text||'');
        if(newText===null) return;
        const basePath = currentChat.uid ? `chats/${chatId}/messages/${key}` : `communityMessages/${chatId}/${key}`;
        await update(ref(db, basePath), { text: newText, editedAt: Date.now() });
        toast('Message edited', 2000, 'success');
      };
      row.appendChild(editBtn);
      
      const reactBtn = document.createElement('button');
      reactBtn.className = 'btn ghost'; reactBtn.textContent = 'React';
      reactBtn.onclick = () => showReactionPicker(key, chatId, reactBtn);
      row.appendChild(reactBtn);
    }
    
    div.querySelector('.message-content').appendChild(row);
  }
  
  div.addEventListener('contextmenu', (e) => {
    showMessageContextMenu(e, m, key, chatId);
  });
  
  const readsSnap = await get(ref(db, `reads/${chatId}/${key}`));
  if(readsSnap.exists()){
    const readers = Object.keys(readsSnap.val() || {});
    if(readers.length){
      const readBadge = document.createElement('div');
      readBadge.style.color='var(--muted)'; readBadge.style.fontSize='.7rem'; readBadge.style.marginTop='4px';
      readBadge.textContent = `Read by ${readers.length}`;
      div.querySelector('.message-content').appendChild(readBadge);
    }
  }
  
  $('#messages').appendChild(div);
  
  if(m.from !== me.uid){
    await set(ref(db, `reads/${chatId}/${key}/${me.uid}`), true);
  }
  
  // NEW: Schedule deletion for disappearing messages
  if (m.disappearing && m.disappearingTimeout) {
    scheduleMessageDeletion(key, chatId, m.disappearingTimeout);
  }
}

function formatDuration(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

$('#msgInput').addEventListener('input', async ()=>{
  if(!currentChat || !me) return;
  const chatId = currentChat.uid ? roomIdFor(me.uid, currentChat.uid) : currentChat.id;
  try{
    await set(typingRef(chatId, me.uid), true);
  }catch{}
  if(typingTimer) clearTimeout(typingTimer);
  typingTimer = setTimeout(async ()=>{
    try{ await remove(typingRef(chatId, me.uid)); }catch{}
  }, 1800);
});

$('#attachBtn').onclick = ()=> $('#fileInput').click();
$('#fileInput').onchange = (e)=> {
  pendingFile = e.target.files && e.target.files[0] ? e.target.files[0] : null;
  if(pendingFile) toast('File selected: '+pendingFile.name, 2000, 'success');
};

$('#sendBtn').onclick = async () => {
  const now = Date.now();
  if(now - lastSendAt < SEND_COOLDOWN_MS){ toast('Slow down a bit‚Ä¶', 2000, 'warning'); return; }
  lastSendAt = now;

  const text = $('#msgInput').value.trim();
  if(!currentChat || (!text && !pendingFile)) return;

  let imageURL = null;
  let audioURL = null;
  let audioDuration = null;
  const chatId = currentChat.uid ? roomIdFor(me.uid, currentChat.uid) : currentChat.id;

  if(pendingFile){
    try {
      if (pendingFile.type.startsWith('audio/')) {
        const filePath = `uploads/${me.uid}/${chatId}/audio/${Date.now()}_${pendingFile.name}`;
        const sr = sref(storage, filePath);
        await uploadBytes(sr, pendingFile);
        audioURL = await getDownloadURL(sr);
        
        const audio = new Audio();
        audio.src = URL.createObjectURL(pendingFile);
        await new Promise(resolve => {
          audio.addEventListener('loadedmetadata', () => {
            audioDuration = audio.duration;
            resolve();
          });
        });
      } else {
        const filePath = `uploads/${me.uid}/${chatId}/${Date.now()}_${pendingFile.name}`;
        const sr = sref(storage, filePath);
        await uploadBytes(sr, pendingFile);
        imageURL = await getDownloadURL(sr);
      }
    } catch(e) {
      toast('Upload failed: ' + e.message, 3000, 'error');
      console.error(e);
    }
  }

  const payload = { 
    from: me.uid, 
    fromName: me.name, 
    fromAvatar: me.avatar,
    text: text || '', 
    ts: Date.now(), 
    imageURL: imageURL || null,
    audioURL: audioURL || null,
    audioDuration: audioDuration || null
  };
  
  // NEW: Add disappearing message properties if enabled
  if (disappearingMessagesEnabled && disappearingTimeout > 0) {
    payload.disappearing = true;
    payload.disappearingTimeout = disappearingTimeout;
  }
  
  const key = push(ref(db)).key;

  if(currentChat.uid){
    await set(ref(db, `chats/${chatId}/messages/${key}`), payload);
    await set(ref(db, `reads/${chatId}/${key}/${me.uid}`), true);
    try { await remove(typingRef(chatId, me.uid)); } catch(_) {}
  } else if(currentChat.id){
    await set(ref(db, `communityMessages/${chatId}/messages/${key}`), payload);
    await set(ref(db, `reads/${chatId}/${key}/${me.uid}`), true);
    try { await remove(typingRef(chatId, me.uid)); } catch(_) {}
  }

  $('#msgInput').value = '';
  if(pendingFile){ pendingFile = null; $('#fileInput').value=''; toast('Message sent!', 2000, 'success'); }
};

$('#messageSearch').addEventListener('input', async (e) => {
  const query = e.target.value.trim().toLowerCase();
  const resultsContainer = $('#searchResults');
  
  if (query.length < 2) {
    resultsContainer.style.display = 'none';
    return;
  }
  
  if (!currentChat) return;
  
  const chatId = currentChat.uid ? roomIdFor(me.uid, currentChat.uid) : currentChat.id;
  const path = currentChat.uid ? `chats/${chatId}/messages` : `communityMessages/${chatId}/messages`;
  
  const messagesSnap = await get(ref(db, path));
  if (!messagesSnap.exists()) {
    resultsContainer.style.display = 'none';
    return;
  }
  
  const messages = messagesSnap.val();
  resultsContainer.innerHTML = '';
  resultsContainer.style.display = 'block';
  
  let foundResults = false;
  
  for (const [key, message] of Object.entries(messages)) {
    if (message.text && message.text.toLowerCase().includes(query)) {
      foundResults = true;
      const resultItem = document.createElement('div');
      resultItem.className = 'search-result-item';
      resultItem.innerHTML = `
        <div style="font-weight:700">${message.fromName}</div>
        <div>${message.text}</div>
        <div style="color:var(--muted);font-size:.8rem">${new Date(message.ts).toLocaleString()}</div>
      `;
      
      resultItem.onclick = () => {
        const messageElement = $(`[data-message-id="${key}"]`);
        if (messageElement) {
          messageElement.scrollIntoView({ behavior: 'smooth' });
          messageElement.style.backgroundColor = '#1b3d74';
          setTimeout(() => {
            messageElement.style.backgroundColor = '';
          }, 2000);
        }
        resultsContainer.style.display = 'none';
        $('#messageSearch').value = '';
      };
      
      resultsContainer.appendChild(resultItem);
    }
  }
  
  if (!foundResults) {
    resultsContainer.innerHTML = '<div class="search-result-item">No results found</div>';
  }
});

document.addEventListener('click', (e) => {
  if (!e.target.closest('.search-container')) {
    $('#searchResults').style.display = 'none';
  }
});

async function loadFriendRequests(){
  if(!me) return;
  const incomingWrap = $('#incomingReqs');
  const outgoingWrap = $('#outgoingReqs');
  incomingWrap.innerHTML = '';
  outgoingWrap.innerHTML = '';

  const inSnap = await get(ref(db, `friendRequests/${me.uid}/incoming`));
  const outSnap = await get(ref(db, `friendRequests/${me.uid}/outgoing`));
  const incoming = inSnap.val() || {};
  const outgoing = outSnap.val() || {};

  for(const reqId in incoming){
    const r = incoming[reqId];
    const it = document.createElement('div'); it.className = 'item';
    it.innerHTML = `
      <img class="avatar" src="${r.fromAvatar || defaultAvatar(r.fromUid)}" />
      <div style="flex:1">
        <div style="font-weight:700">${r.fromName || r.fromUid}</div>
        <div style="color:var(--muted);font-size:.85rem">${timeAgo(r.ts)} ago</div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn">Accept</button>
        <button class="btn ghost">Decline</button>
      </div>
    `;
    const [acceptBtn, declineBtn] = it.querySelectorAll('button');
    acceptBtn.onclick = ()=> acceptFriendRequest(reqId, r.fromUid);
    declineBtn.onclick = ()=> declineFriendRequest(reqId, r.fromUid);
    incomingWrap.appendChild(it);
  }

  for(const reqId in outgoing){
    const r = outgoing[reqId];
    const it = document.createElement('div'); it.className = 'item';
    it.innerHTML = `
      <img class="avatar" src="${r.toAvatar || defaultAvatar(r.toUid)}" />
      <div style="flex:1">
        <div style="font-weight:700">${r.toName || r.toUid}</div>
        <div style="color:var(--muted);font-size:.85rem">Pending - ${timeAgo(r.ts)} ago</div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn ghost">Cancel</button>
      </div>
    `;
    const cancelBtn = it.querySelector('button');
    cancelBtn.onclick = ()=> cancelFriendRequest(reqId, r.toUid);
    outgoingWrap.appendChild(it);
  }
}

async function declineFriendRequest(reqId, fromUid){
  if(!me) return;
  const pk = pairKey(me.uid, fromUid);

  await remove(ref(db, `friendRequests/${me.uid}/incoming/${reqId}`));
  await remove(ref(db, `friendRequests/${fromUid}/outgoing/${reqId}`));
  await remove(ref(db, `requestPairs/${pk}`));

  toast('Request declined', 2000, 'info');
  await loadFriendRequests();
  await updateFriendStats();
}

async function cancelFriendRequest(reqId, toUid){
  if(!me) return;
  const pk = pairKey(me.uid, toUid);

  await remove(ref(db, `friendRequests/${me.uid}/outgoing/${reqId}`));
  await remove(ref(db, `friendRequests/${toUid}/incoming/${reqId}`));
  await remove(ref(db, `requestPairs/${pk}`));

  toast('Request canceled', 2000, 'info');
  await loadFriendRequests();
  await updateFriendStats();
}

async function setPresence(uid){
  await update(ref(db, 'users/' + uid), { online: true, lastSeen: Date.now() });
}

window.addEventListener('beforeunload', () => {
  if(me && me.uid){
    navigator.sendBeacon(
      `https://meaww-chat-4f6bd-default-rtdb.firebaseio.com/users/${me.uid}.json`,
      JSON.stringify({ online:false, lastSeen: Date.now() })
    );
  }
});

document.addEventListener('visibilitychange', async () => {
  if(!me) return;
  if(document.hidden) {
    await update(ref(db,'users/'+me.uid), { online:false, lastSeen: Date.now() });
  } else {
    await update(ref(db,'users/'+me.uid), { online:true, lastSeen: Date.now() });
  }
});

function setupNavigation() {
  const navItems = $$('.nav-item');
  const pages = $$('.page');
  
  navItems.forEach(item => {
    item.addEventListener('click', () => {
      const targetPage = item.dataset.page;
      
      navItems.forEach(nav => {
        nav.classList.remove('active');
        nav.style.transform = 'translateY(0)';
      });
      item.classList.add('active');
      
      pages.forEach(page => {
        if (page.id === targetPage) {
          page.style.display = 'block';
          setTimeout(() => page.classList.add('active'), 10);
        } else {
          page.classList.remove('active');
          setTimeout(() => page.style.display = 'none', 300);
        }
      });
    });
  });
}

function setupScrollToBottom() {
  const messagesContainer = $('#messages');
  const scrollButton = $('#scrollToBottom');
  
  if (messagesContainer && scrollButton) {
    messagesContainer.addEventListener('scroll', () => {
      const isAtBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop <= messagesContainer.clientHeight + 100;
      scrollButton.classList.toggle('hidden', isAtBottom);
    });
    
    scrollButton.addEventListener('click', () => {
      messagesContainer.scrollTo({
        top: messagesContainer.scrollHeight,
        behavior: 'smooth'
      });
    });
  }
}

document.addEventListener('DOMContentLoaded', () => {
  setupScrollToBottom();
  
  $('#msgInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      $('#sendBtn').click();
    }
  });
});

onAuthStateChanged(auth, async (user) => {
  if(!user){
    $('#auth').classList.remove('hidden');
    $('#appUI').classList.add('hidden');
    isAdminUser = false;
    me = null;
    document.getElementById('profileAdminPanel').style.display = 'none';
    return;
  }

  const bannedSnap = await get(ref(db, 'banned/' + user.uid));
  if(bannedSnap.exists()){
    toast('Your account is banned. Signing out.', 4000, 'error');
    await signOut(auth);
    return;
  }

  const uref = ref(db, 'users/' + user.uid);
  const s = await get(uref);
  if(!s.exists()){
    const short = String(10000 + Math.floor(Math.random()*90000));
    await set(uref, {
      uid: user.uid,
      email: user.email,
      name: user.displayName || user.email.split('@')[0],
      avatar: user.photoURL || defaultAvatar(user.uid),
      shortId: short,
      createdAt: Date.now(),
      online: true,
      lastSeen: Date.now(),
      status: 'online'
    });
    await set(ref(db, 'shortIds/' + short), { uid: user.uid });
  } else {
    const data = s.val();
    const upd = { online: true, lastSeen: Date.now() };
    if(!data.avatar) upd.avatar = defaultAvatar(user.uid);
    if(!data.status) upd.status = 'online';
    await update(uref, upd);
  }

  me = (await get(uref)).val();

  $('#navAvatar').src = me.avatar || defaultAvatar(me.uid);
  $('#myShort').textContent = 'ID: ' + (me.shortId || '');
  $('#auth').classList.add('hidden');
  $('#appUI').classList.remove('hidden');

  $('#profName').value = me.name || '';
  $('#profAvatarUrl').value = me.avatar || '';

  $$('.status-option').forEach(option => {
    if (option.dataset.status === me.status) {
      option.classList.add('active');
    } else {
      option.classList.remove('active');
    }
  });

  $$('.status-option').forEach(option => {
    option.onclick = async () => {
      $$('.status-option').forEach(opt => opt.classList.remove('active'));
      option.classList.add('active');
      
      await update(ref(db, 'users/' + me.uid), { status: option.dataset.status });
      toast(`Status set to ${option.dataset.status}`, 2000, 'success');
    };
  });

  $$('.theme-option').forEach(option => {
    option.onclick = () => {
      $$('.theme-option').forEach(opt => opt.classList.remove('active'));
      option.classList.add('active');
      
      if (option.dataset.theme === 'green') {
        document.documentElement.style.setProperty('--brand', '#4caf50');
      } else if (option.dataset.theme === 'purple') {
        document.documentElement.style.setProperty('--brand', '#9c27b0');
      } else if (option.dataset.theme === 'red') {
        document.documentElement.style.setProperty('--brand', '#f44336');
      } else {
        document.documentElement.style.setProperty('--brand', '#4f8cff');
      }
      localStorage.setItem('chatTheme', option.dataset.theme);
      toast(`Theme changed to ${option.dataset.theme}`, 2000, 'success');
    };
  });

  const savedTheme = localStorage.getItem('chatTheme');
  if (savedTheme) {
    const themeOption = $(`.theme-option[data-theme="${savedTheme}"]`);
    if (themeOption) {
      $$('.theme-option').forEach(opt => opt.classList.remove('active'));
      themeOption.classList.add('active');
      
      if (savedTheme === 'green') {
        document.documentElement.style.setProperty('--brand', '#4caf50');
      } else if (savedTheme === 'purple') {
        document.documentElement.style.setProperty('--brand', '#9c27b0');
      } else if (savedTheme === 'red') {
        document.documentElement.style.setProperty('--brand', '#f44336');
      } else {
        document.documentElement.style.setProperty('--brand', '#4f8cff');
      }
    }
  }

  $('#saveProfileBtn').onclick = async ()=>{
    const name = $('#profName').value.trim() || me.email?.split('@')[0] || 'user';
    const avatar = $('#profAvatarUrl').value.trim() || me.avatar || defaultAvatar(me.uid);
    await update(ref(db, 'users/'+me.uid), { name, avatar });
    try { await updateProfile(auth.currentUser, { displayName: name, photoURL: avatar }); } catch(_) {}
    $('#navAvatar').src = avatar;
    toast('Profile updated successfully!', 2000, 'success');
    await refreshFriends();
  };

  $('#resetAvatarBtn').onclick = async ()=>{
    const avatar = defaultAvatar(me.uid);
    $('#profAvatarUrl').value = avatar;
    await update(ref(db, 'users/'+me.uid), { avatar });
    try { await updateProfile(auth.currentUser, { photoURL: avatar }); } catch(_) {}
    $('#navAvatar').src = avatar;
    toast('Avatar reset to default', 2000, 'success');
  };

  if(user.email && user.email.toLowerCase() === adminEmail.toLowerCase()){
    isAdminUser = true;
    $('#adminControls').style.display = 'block';
    await injectAdminPanel();
    toast('Admin access granted!', 3000, 'success');
  } else {
    isAdminUser = false;
    $('#adminControls').style.display = 'none';
  }

  document.getElementById('profileAdminPanel').style.display = 'none';

  await refreshFriends();
  await loadCommunities();

  $('#addFriendBtn').onclick = ()=> sendFriendRequestByShortId($('#addByShort').value);
  await loadFriendRequests();
  onValue(ref(db, `friendRequests/${me.uid}`), ()=> { loadFriendRequests(); });

  setupNavigation();

  onValue(ref(db,'announcements/global'), snap=>{
    const b = $('#globalBanner');
    if(snap.exists()){
      b.textContent = snap.val().text || '';
      b.classList.remove('hidden');
    } else {
      b.classList.add('hidden');
      b.textContent = '';
    }
  });

  // Initialize enhanced features
  if (user) {
    initializeEnhancedFeatures();
    initializeDiscordFeatures();
  }
});

$('#navAvatar').onclick = () => {
  const panel = document.getElementById('profileAdminPanel');
  if(panel.style.display === 'none' || panel.style.display === ''){
    panel.style.display = 'block';
  } else {
    panel.style.display = 'none';
  }
};

$('#logoutBtn').onclick = async () => {
  const ok = confirm('Are you sure you want to sign out?');
  if(ok) {
    await signOut(auth);
    toast('Signed out successfully', 2000, 'success');
  }
};

const darkModeToggle = document.getElementById('darkModeToggle');

function updateToggleButtonText() {
  if (document.body.classList.contains('theme-light')) {
    darkModeToggle.textContent = 'Dark Mode';
  } else {
    darkModeToggle.textContent = 'Light Mode';
  }
}

darkModeToggle.onclick = () => {
  if (document.body.classList.contains('theme-light')) {
    document.body.classList.remove('theme-light');
    localStorage.removeItem('lightMode');
    toast('Dark mode enabled', 2000, 'success');
  } else {
    document.body.classList.add('theme-light');
    localStorage.setItem('lightMode', 'enabled');
    toast('Light mode enabled', 2000, 'success');
  }
  updateToggleButtonText();
};

if (localStorage.getItem('lightMode') === 'enabled') {
  document.body.classList.add('theme-light');
}

updateToggleButtonText();

const msgInput = document.getElementById('msgInput');
const typingIndicator = document.getElementById('typingIndicator');

msgInput.addEventListener('input', () => {
  typingIndicator.style.display = 'block';
  clearTimeout(msgInput._typingTimeout);
  msgInput._typingTimeout = setTimeout(() => {
    typingIndicator.style.display = 'none';
  }, 1000);
});
</script>

</body>
</html>
