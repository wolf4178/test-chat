<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QuickChat — Admin Edition</title>
<style>
:root{--bg:#0b0f14;--elev:#111723;--border:#1b2435;--text:#e6eefc;--muted:#98a7c0;--brand:#4f8cff}
body.theme-high { --bg:#05070b; --elev:#0a1120; --border:#172135; --text:#eaf2ff; --muted:#9fb1cc; --brand:#4f8cff }
body.theme-dim { --bg:#0b0f14; --elev:#111723; --border:#1b2435; --text:#e6eefc; --muted:#98a7c0; --brand:#4f8cff }

html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
.app{display:flex;flex-direction:column;height:100%}
header{display:flex;align-items:center;gap:.6rem;padding:.7rem;background:linear-gradient(180deg,var(--elev),#0e1420);border-bottom:1px solid var(--border)}
.title{font-weight:800}
main{flex:1;overflow:auto;padding:0.8rem}
.card{background:#0e1420;border:1px solid var(--border);border-radius:12px;padding:.75rem}
.hidden{display:none}
.input{width:100%;padding:.6rem;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--text);margin:.4rem 0}
.btn{background:var(--brand);border:none;color:#fff;padding:.6rem .8rem;border-radius:10px;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--border)}
.list{display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem}
.item{display:flex;align-items:center;gap:.5rem;padding:.5rem;border-radius:10px;background:#0b1424;border:1px solid var(--border)}
.avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
.admin-floating{position:fixed;left:12px;top:72px;z-index:9999}
pre{white-space:pre-wrap;word-break:break-word}

/* Fullscreen chat mode */
.fullscreen-chat #appUI > div {
display: flex;
flex-direction: column;
}
.fullscreen-chat #appUI > div > div:first-child {
display: none; /* Hide sidebar */
}
.fullscreen-chat #appUI > div > div:last-child {
width: 100% !important; /* Expand chat */
}

/* Message Reactions */
.reaction-row {
  display: flex;
  gap: 6px;
  margin-top: 4px;
}
.reaction-row button {
  border-radius: 8px;
  border: 1px solid var(--border);
  transition: background 0.16s;
  padding: 2px 8px;
  font-size: 1.2em;
  background: transparent;
  color: var(--text);
  cursor: pointer;
}
.reaction-row button.active {
  background: #1b3d74;
}
</style>
</head>
<body>
<div class="app" id="app">
<header>
<div class="title">QuickChat</div>
<div style="flex:1"></div>
<div style="display:flex;align-items:center;gap:0.5rem">
<img id="navAvatar" class="avatar" src="" alt="me" style="width:36px;height:36px;border:1px solid var(--border);cursor:pointer" title="Toggle Profile Menu"/>
<button id="logoutBtn" class="btn ghost" title="Logout" style="padding:0.3rem 0.6rem;margin-left:8px;">Logout</button>
</div>
</header>

<div id="globalBanner" class="hidden" style="background:#0c2140;border-bottom:1px solid var(--border);padding:.5rem;text-align:center;color:#dfefff"></div>

<main>
<!-- AUTH CARD -->
<section id="auth" class="card" style="max-width:720px;margin:auto">
<h3>Sign in / Register</h3>
<input id="loginEmail" class="input" placeholder="Email" type="email" />
<input id="loginPass" class="input" placeholder="Password" type="password" />
<div style="display:flex;gap:.5rem;margin-top:.5rem">
<button id="loginBtn" class="btn">Log in</button>
<button id="registerBtn" class="btn ghost">Register</button>
<button id="googleBtn" class="btn ghost">Sign in with Google</button>
</div>
<div id="authMsg" style="color:var(--muted);margin-top:.5rem"></div>
</section>

<!-- APP PAGES -->
<section id="appUI" class="hidden" style="max-width:1100px;margin:16px auto 80px">
<div style="display:flex;gap:1rem;align-items:flex-start">
<div style="flex:1">

<!-- Profile and Admin Panel Container -->
<div id="profileAdminPanel" class="card" style="margin-bottom:.8rem; display:none;">
<strong>My Profile</strong>
<input id="profName" class="input" placeholder="Display name" />
<input id="profAvatarUrl" class="input" placeholder="Avatar URL (optional)" />
<div style="display:flex;gap:.5rem;margin-bottom:1rem;">
<button id="saveProfileBtn" class="btn">Save</button>
<button id="resetAvatarBtn" class="btn ghost">Reset Avatar</button>
</div>

<div id="adminControls" style="display:none; border-top: 1px solid var(--border); padding-top:10px; margin-top: 8px;">
<div style="font-weight:700; margin-bottom:8px;">Admin Panel 👑</div>

<div style="display:flex;gap:6px;margin-bottom:8px">
<input id="adminTarget" class="input" placeholder="UID or 5-digit ID" style="padding:.4rem" />
<button id="adminLookupBtn" class="btn ghost">Lookup</button>
</div>

<div style="display:flex;gap:6px;margin-bottom:8px">
<button id="adminVerifyBtn" class="btn">Verify</button>
<button id="adminUnverifyBtn" class="btn ghost">Unverify</button>
</div>

<div style="display:flex;gap:6px;margin-bottom:8px">
<button id="adminBanBtn" class="btn ghost">Ban</button>
<button id="adminUnbanBtn" class="btn ghost">Unban</button>
</div>

<div style="margin-bottom:8px">
<input id="adminChatId" class="input" placeholder="Chat ID (room id)" style="margin-bottom:6px;padding:.4rem" />
<input id="adminMsgKey" class="input" placeholder="Message Key to delete" style="padding:.4rem" />
<div style="display:flex;gap:6px;margin-top:6px">
<button id="adminDelMsgBtn" class="btn secondary">Delete Message</button>
</div>
</div>

<div style="margin-top:8px;border-top:1px solid var(--border);padding-top:8px;margin-bottom:8px;">
<div style="font-weight:700;margin-bottom:6px">Global Announcement</div>
<input id="adminAnnText" class="input" placeholder="Announcement text" style="padding:.4rem" />
<div style="display:flex;gap:6px;margin-top:6px">
<button id="adminAnnSet" class="btn">Set</button>
<button id="adminAnnClear" class="btn ghost">Clear</button>
</div>
</div>

<div>
<button id="adminRefreshUsers" class="btn ghost">Refresh Users</button>
<div id="adminUsersList" style="max-height:220px;overflow:auto;margin-top:8px"></div>
</div>
</div>
</div>

<!-- ADD FRIENDS + REQUESTS PANELS -->
<div class="card" style="margin-bottom:.8rem">
  <strong>Add friends</strong>
  <div style="display:flex;gap:.5rem;margin-top:.5rem">
    <input id="addByShort" class="input" placeholder="Enter 5-digit ID" style="flex:1" />
    <button id="addFriendBtn" class="btn">Add</button>
  </div>
  <div id="friendRequestMsg" style="color:var(--muted);margin-top:.4rem"></div>
</div>

<div class="card" style="margin-bottom:.8rem">
  <strong>Requests</strong>
  <div style="display:flex;gap:1rem;margin-top:.5rem">
    <div style="flex:1">
      <div style="font-weight:700;margin-bottom:.4rem">Incoming</div>
      <div id="incomingReqs" class="list"></div>
    </div>
    <div style="flex:1">
      <div style="font-weight:700;margin-bottom:.4rem">Outgoing</div>
      <div id="outgoingReqs" class="list"></div>
    </div>
  </div>
</div>

<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center">
<strong>Friends</strong>
<div id="myShort" style="color:var(--muted)"></div>
</div>
<div id="friendsList" class="list" style="margin-top:.6rem;max-height:280px;overflow:auto"></div>
</div>

<div class="card" style="margin-top:.8rem">
<strong>Communities</strong>
<div id="communitiesList" class="list"></div>
</div>
</div>

<div style="width:420px">
<div class="card" id="chatCard">
<div style="display:flex;align-items:center;gap:.6rem;position:relative">
<button id="chatBackBtn" class="btn ghost" style="display:none;position:absolute;left:0;">Back</button>
<img id="chatAvatar" class="avatar" src="" alt="" style="margin-left:30px">
<div style="flex:1">
<div id="chatTitle" style="font-weight:800">No chat</div>
<div id="chatPresence" style="color:var(--muted);font-size:.85rem">—</div>
</div>
<div>
<button id="audioCallBtn" class="btn ghost" title="Audio call (planned)">Audio</button>
<button id="videoCallBtn" class="btn ghost" title="Video call (planned)">Video</button>
</div>
</div>

<div id="messages" style="margin-top:.6rem;max-height:360px;overflow:auto;background:#071022;padding:.6rem;border-radius:8px"></div>

<div style="display:flex;gap:.5rem;margin-top:.6rem">
<input id="msgInput" class="input" placeholder="Message..." style="flex:1" autocomplete="off" />
<input id="fileInput" type="file" accept="image/*" style="display:none" />
<button id="attachBtn" class="btn ghost" title="Attach image">Attach</button>
<button id="sendBtn" class="btn">Send</button>
</div>
<div id="typingIndicator" style="color:var(--muted);margin-top:.4rem;display:none">Someone is typing…</div>
</div>
</div>
</div>

<div style="height:12px"></div>
<div class="card" id="callHistoryCard">
<strong>Call History</strong>
<div id="callHistory" class="list"></div>
</div>
</section>
</main>
</div>

<!-- Toast area -->
<div id="toasts" style="position:fixed;left:50%;transform:translateX(-50%);bottom:20px;z-index:9999"></div>

<!-- Firebase + logic -->
<script type="module">
/* ========================== CONFIG ========================== */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';
import { getDatabase, ref, set, push, onValue, get, update, remove } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js';
import { getStorage, ref as sref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js';

const firebaseConfig = {
apiKey: "AIzaSyDEOHYkQnyaeDbdVGisC2B2H02kxNfp3F8",
authDomain: "meaww-chat-4f6bd.firebaseapp.com",
databaseURL: "https://meaww-chat-4f6bd-default-rtdb.firebaseio.com",
projectId: "meaww-chat-4f6bd",
storageBucket: "meaww-chat-4f6bd.appspot.com",
messagingSenderId: "162714330727",
appId: "1:162714330727:dd1ce1da5806c0316c2",
measurementId: "G-L7Y3NV8L88"
};

const adminEmail = "flashdc4178@gmail.com";

/* ========================== INIT ========================== */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const storage = getStorage(app);

/* ========================== HELPERS ========================== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function toast(msg, t = 2500){
const d = document.createElement('div');
d.style.padding='8px 12px';
d.style.background='#0e2238';
d.style.border='1px solid #12233b';
d.style.borderRadius='10px';
d.style.color='#dfefff';
d.style.marginTop='6px';
d.textContent=msg;
$('#toasts').appendChild(d);
setTimeout(() => d.remove(), t);
}
function defaultAvatar(seed){
return `https://api.dicebear.com/8.x/thumbs/svg?seed=${(seed||'quick').slice(0,8)}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
}
function timeAgo(ts){
if(!ts) return '—';
const d = Math.floor((Date.now()-ts)/1000);
if(d<60) return d+'s';
if(d<3600) return Math.floor(d/60)+'m';
if(d<86400) return Math.floor(d/3600)+'h';
return Math.floor(d/86400)+'d';
}
function typingRef(chatId, uid){
return ref(db, `typing/${chatId}/${uid}`);
}
function pairKey(a,b){ return [a,b].sort().join('_'); }

/* ========================== MESSAGE REACTIONS ========================== */
const REACTION_EMOJIS = ['👍','❤️','😂','😮','😢','😡'];
function renderReactions(div, chatId, msgKey, reactions = {}) {
  // Remove previous
  let reactRow = div.querySelector('.reaction-row');
  if (reactRow) reactRow.remove();
  reactRow = document.createElement('div');
  reactRow.className = 'reaction-row';

  REACTION_EMOJIS.forEach(emoji => {
    const users = reactions[emoji] ? Object.keys(reactions[emoji]) : [];
    const count = users.length;
    const hasMe = reactions[emoji] && reactions[emoji][me?.uid];
    const btn = document.createElement('button');
    btn.className = 'btn ghost' + (hasMe ? ' active' : '');
    btn.innerHTML = `${emoji} ${count>0?count:''}`;
    btn.onclick = async () => {
      if (!me) return;
      const reactRef = ref(db, `reactions/${chatId}/${msgKey}/${emoji}/${me.uid}`);
      if (hasMe) {
        await remove(reactRef);
      } else {
        await set(reactRef, true);
      }
    };
    reactRow.appendChild(btn);
  });
  div.appendChild(reactRow);
}

/* ========================== VARIABLES ========================== */
let isAdminUser = false;
let me = null;
let currentChat = null;
let unsubMessages = null;
let reactionUnsubs = [];
let typingTimer = null;
let pendingFile = null;
let lastSendAt = 0;
const SEND_COOLDOWN_MS = 1200;

/* ========================== AUTH UI HANDLERS ========================== */
// ... [no changes, code omitted for brevity] ...

/* ========================== ADMIN UI + ACTIONS ========================== */
// ... [no changes, code omitted for brevity] ...

/* ========================== BAN CHECK ========================== */
// ... [no changes, code omitted for brevity] ...

/* ========================== APP CORE ========================== */
// ... [no changes up to subscribeMessages function] ...

function subscribeMessages(path, chatId, kind, peer){
if(unsubMessages) unsubMessages();
reactionUnsubs.forEach(fn => fn()); // remove previous reaction listeners
reactionUnsubs = [];

const r = ref(db, path);
onValue(r, async snap => {
const data = snap.val() || {};
$('#messages').innerHTML = '';
const entries = Object.entries(data).sort((a,b)=>a.ts - b.ts);
for(const [key,m] of entries){
const div = document.createElement('div'); div.className = 'item';
div.style.background = m.from===me?.uid? '#08263f':'#071328';
div.innerHTML = `<div style="flex:1"><div style="font-weight:700">${m.fromName||''}${m.editedAt?'<span style="color:var(--muted);font-size:.75rem"> -  edited</span>':''}</div><div>${m.text||''}</div><div style="color:var(--muted);font-size:.75rem">${new Date(m.ts).toLocaleTimeString()}</div></div>`;
const keyEl = document.createElement('div'); keyEl.style.color='var(--muted)'; keyEl.style.fontSize='.7rem'; keyEl.textContent = key;
div.appendChild(keyEl);

if(m.imageURL){
const img = document.createElement('img');
img.src = m.imageURL;
img.style.maxWidth = '100%';
img.style.borderRadius = '8px';
img.style.marginTop = '6px';
div.querySelector('div[style*="flex:1"]').appendChild(img);
}

if(m.from === me?.uid){
const row = document.createElement('div');
row.style.display='flex'; row.style.gap='6px'; row.style.marginTop='6px';

const delBtn = document.createElement('button');
delBtn.className = 'btn ghost'; delBtn.textContent = 'Delete';
delBtn.onclick = async ()=>{
const basePath = currentChat.uid ? `chats/${chatId}/messages/${key}` : `communityMessages/${chatId}/${key}`;
await remove(ref(db, basePath));
toast('Deleted');
};
row.appendChild(delBtn);

const EDIT_WINDOW_MS = 120000;
if(Date.now() - m.ts <= EDIT_WINDOW_MS){
const editBtn = document.createElement('button');
editBtn.className = 'btn ghost'; editBtn.textContent = 'Edit';
editBtn.onclick = async ()=>{
const newText = prompt('Edit message:', m.text||'');
if(newText===null) return;
const basePath = currentChat.uid ? `chats/${chatId}/messages/${key}` : `communityMessages/${chatId}/${key}`;
await update(ref(db, basePath), { text: newText, editedAt: Date.now() });
toast('Edited');
};
row.appendChild(editBtn);
}

div.appendChild(row);
}

// read-by badge
const readsSnap = await get(ref(db, `reads/${chatId}/${key}`));
if(readsSnap.exists()){
const readers = Object.keys(readsSnap.val() || {});
if(readers.length){
const readBadge = document.createElement('div');
readBadge.style.color='var(--muted)'; readBadge.style.fontSize='.7rem'; readBadge.style.marginTop='4px';
readBadge.textContent = `Read by ${readers.length}`;
div.appendChild(readBadge);
}
}
$('#messages').appendChild(div);
if(m.from !== me?.uid){
await set(ref(db, `reads/${chatId}/${key}/${me.uid}`), true);
}

// ========= REACTION SUBSCRIPTION =========
const reactRef = ref(db, `reactions/${chatId}/${key}`);
const offReact = onValue(reactRef, snap => {
  const reactions = snap.val() || {};
  renderReactions(div, chatId, key, reactions);
});
reactionUnsubs.push(() => offReact());
}
$('#messages').scrollTop = $('#messages').scrollHeight;
});

// typing observer (no change)
const tRef = ref(db, `typing/${chatId}`);
const offTyping = onValue(tRef, snap=>{
const obj = snap.val() || {};
const someoneElseTyping = Object.keys(obj).some(uid => uid !== me?.uid && obj[uid] === true);
$('#typingIndicator').style.display = someoneElseTyping ? 'block' : 'none';
});

unsubMessages = ()=>{
offTyping();
reactionUnsubs.forEach(fn => fn());
reactionUnsubs = [];
};
}

// ... [rest of your code - no changes] ...
// All other features continue to work as before.
</script>
</body>
</html>
