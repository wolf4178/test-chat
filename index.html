<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuickChat</title>
  <!-- Mobile-first, single-file app -->
  <style>
    :root{
      --bg:#0b0f14; --elev:#111723; --elev2:#0e1420; --brand:#4f8cff; --brand-2:#7aa2ff; --text:#e6eefc; --muted:#98a7c0; --danger:#ff5d6e; --success:#38d39f; --warn:#ffcc66;
      --border: #1b2435; --bubble:#182338; --bubble-me:#22406d; --overlay: rgba(5,10,20,.65)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .app{height:100%;display:flex;flex-direction:column}

    /* Generic */
    .hidden{display:none!important}
    .btn{display:inline-flex;align-items:center;gap:.5rem;background:var(--brand);color:#fff;border:none;border-radius:14px;padding:.75rem 1rem;font-weight:600;cursor:pointer;box-shadow:0 6px 18px rgba(79,140,255,.2)}
    .btn.secondary{background:#1b2a47;color:var(--text)}
    .btn.ghost{background:transparent;border:1px solid var(--border)}
    .btn.danger{background:var(--danger)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .icon{width:20px;height:20px;display:inline-block}
    .row{display:flex;align-items:center}
    .col{display:flex;flex-direction:column}
    .grow{flex:1}
    .card{background:var(--elev);border:1px solid var(--border);border-radius:18px}
    .input{width:100%;background:#0e1624;border:1px solid var(--border);border-radius:12px;color:var(--text);padding:.85rem 1rem}
    .input::placeholder{color:#7282a1}
    .list{display:flex;flex-direction:column;gap:.5rem}
    .divider{height:1px;background:var(--border);margin:.75rem 0}
    .tag{background:#1b2a47;border:1px solid var(--border);padding:.25rem .5rem;border-radius:999px;color:#b9c7e6;font-size:.8rem}

    /* Auth */
    #auth{margin:auto;max-width:520px;width:100%;padding:1.25rem}
    .auth-card{padding:1.25rem}
    .logo{font-weight:900;letter-spacing:.4px;font-size:1.5rem}
    .logo b{color:var(--brand)}
    .tabs{display:flex;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .tabs button{flex:1;background:transparent;color:var(--muted);padding:.75rem;border:none;cursor:pointer;font-weight:700}
    .tabs button.active{background:var(--bubble);color:var(--text)}

    /* Main layout */
    header{position:sticky;top:0;background:linear-gradient(180deg,var(--elev),var(--elev2));border-bottom:1px solid var(--border);padding:.75rem .9rem;z-index:5;display:flex;align-items:center;gap:.6rem}
    header .title{font-weight:800}
    header .search{flex:1}
    header .profile-btn{background:transparent;border:none;cursor:pointer}
    header img.avatar{width:34px;height:34px;border-radius:50%;border:1px solid var(--border);object-fit:cover}

    main{flex:1;overflow:auto}
    .page{padding:.75rem .9rem}

    /* Bottom nav */
    nav.bottom{position:sticky;bottom:0;background:var(--elev);border-top:1px solid var(--border);display:flex}
    nav.bottom button{flex:1;background:transparent;border:none;color:#99aacc;padding:.6rem 0 .65rem;font-weight:700}
    nav.bottom button.active{color:#fff}

    /* Lists */
    .item{display:flex;align-items:center;gap:.8rem;padding:.6rem;border-radius:14px;border:1px solid var(--border);background:var(--elev2)}
    .item:hover{background:#0e1420}
    .item img.avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
    .item .name{font-weight:700}
    .status-dot{width:9px;height:9px;border-radius:50%;background:#73809b;border:2px solid var(--elev);display:inline-block}
    .status-online{background:var(--success)}

    /* Chat view */
    .chat-panel{position:fixed;inset:0;display:flex;flex-direction:column;background:var(--elev);transform:translateX(100%);transition:.25s ease;z-index:6;border-left:1px solid var(--border)}
    .chat-panel.open{transform:translateX(0)}
    .messages{flex:1;overflow:auto;padding:0 .9rem}
    .msg{max-width:82%;margin:.4rem 0;padding:.6rem .75rem;border-radius:16px;border:1px solid var(--border)}
    .msg.me{margin-left:auto;background:var(--bubble-me)}
    .msg.them{margin-right:auto;background:var(--bubble)}
    .msg .meta{font-size:.72rem;color:#a5b3cf;margin-top:.25rem}
    .composer{display:flex;gap:.5rem;padding:.6rem;border-top:1px solid var(--border);background:var(--elev2)}
    .composer input{flex:1}

    /* Popups & overlay */
    .overlay{position:fixed;inset:0;background:var(--overlay);backdrop-filter:blur(2px);display:none;z-index:20}
    .overlay.show{display:block}
    .popup{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(92vw,520px);background:var(--elev);border:1px solid var(--border);border-radius:16px;z-index:21;padding:1rem;display:none}
    .popup.show{display:block}

    /* Toasts */
    .toasts{position:fixed;left:50%;bottom:80px;transform:translateX(-50%);display:flex;flex-direction:column;gap:.5rem;z-index:30}
    .toast{background:#10233c;color:#e6eefc;border:1px solid var(--border);border-radius:14px;padding:.6rem .8rem;box-shadow:0 8px 18px rgba(0,0,0,.25)}

    /* FAB */
    .fab{position:fixed;right:16px;bottom:76px;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--brand);color:#fff;border:none;box-shadow:0 8px 24px rgba(79,140,255,.35);z-index:4}

    /* Call UI */
    .call-full{position:fixed;inset:0;background:#000;z-index:40;display:none;flex-direction:column}
    .call-full.show{display:flex}
    .call-remote{flex:1;position:relative}
    video{background:#000;max-width:100%}
    #remoteVideo{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    #localVideo{position:absolute;right:12px;bottom:12px;width:30vw;max-width:200px;border-radius:12px;border:2px solid rgba(255,255,255,.35);cursor:grab}
    .call-controls{display:flex;gap:.6rem;justify-content:center;padding:1rem;background:linear-gradient(180deg,transparent,rgba(0,0,0,.5))}
    .ctrl{width:48px;height:48px;border-radius:999px;border:none;display:flex;align-items:center;justify-content:center}
    .ctrl.mute{background:#1b2a47;color:#fff}
    .ctrl.end{background:#ff4d5d;color:#fff}

    .incoming{position:fixed;inset:auto 0 0 0;background:var(--elev);border-top:1px solid var(--border);z-index:35;display:none;padding:1rem}
    .incoming.show{display:block}

    /* Settings */
    .settings img.avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}

    /* Desktop tweaks */
    @media(min-width:900px){
      .app{max-width:920px;margin:0 auto;border-left:1px solid var(--border);border-right:1px solid var(--border)}
      .fab{bottom:92px}
    }
  </style>
</head>
<body>
<div class="app" id="app">
  <!-- AUTH -->
  <section id="auth">
    <div class="card auth-card">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:.75rem">
        <div class="logo">Quick<b>Chat</b></div>
        <div class="tag">Realtime • Secure</div>
      </div>

      <div class="tabs" id="authTabs">
        <button data-tab="login" class="active">Log in</button>
        <button data-tab="register">Register</button>
      </div>

      <div id="loginPane" style="margin-top:1rem">
        <div class="col" style="gap:.6rem">
          <input id="loginEmail" class="input" placeholder="Email" type="email" autocomplete="email" />
          <input id="loginPass" class="input" placeholder="Password" type="password" autocomplete="current-password" />
          <button id="loginBtn" class="btn">Log in</button>
          <button id="googleBtn" class="btn secondary" type="button">Continue with Google</button>
        </div>
      </div>

      <div id="registerPane" class="hidden" style="margin-top:1rem">
        <div class="col" style="gap:.6rem">
          <input id="regName" class="input" placeholder="Display name" />
          <input id="regEmail" class="input" placeholder="Email" type="email" autocomplete="email" />
          <input id="regPass" class="input" placeholder="Password (min 6)" type="password" autocomplete="new-password" />
          <button id="registerBtn" class="btn">Create account</button>
        </div>
      </div>

      <div class="divider"></div>
      <div style="font-size:.85rem;color:var(--muted)">By continuing you agree to the Terms. This demo uses Firebase Auth, Realtime Database, and Storage.</div>
    </div>
  </section>

  <!-- MAIN -->
  <header class="hidden" id="mainHeader">
    <div class="title grow">QuickChat</div>
    <input id="search" class="input search" placeholder="Search"/>
    <button class="profile-btn" id="profileBtn" title="Profile"><img id="navAvatar" class="avatar" src="" alt="me"></button>
  </header>

  <main class="hidden" id="pages">
    <!-- HOME (friends) -->
    <section class="page" id="page-home">
      <div class="list" id="friendsList"></div>
      <div class="divider"></div>
      <div style="color:var(--muted);font-size:.9rem">Tip: Tap a friend to chat. Online status shows a green dot.</div>
    </section>

    <!-- REQUESTS -->
    <section class="page hidden" id="page-requests">
      <h3>Incoming Requests</h3>
      <div class="list" id="requestsList"></div>
    </section>

    <!-- COMMUNITY -->
    <section class="page hidden" id="page-community">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3>Public Communities</h3>
        <span class="tag" id="joinedCount">0 joined</span>
      </div>
      <div class="list" id="communitiesList"></div>
    </section>

    <!-- CALLS -->
    <section class="page hidden" id="page-calls">
      <h3>Call History</h3>
      <div class="list" id="callHistory"></div>
    </section>

    <!-- SETTINGS -->
    <section class="page hidden settings" id="page-settings">
      <div class="row" style="gap:1rem;align-items:center">
        <img id="settingsAvatar" class="avatar" src="" alt="avatar">
        <div class="col">
          <div id="settingsName" style="font-weight:800"></div>
          <div id="settingsEmail" style="color:var(--muted)"></div>
          <div>ID: <code id="settingsShort"></code></div>
        </div>
      </div>
      <div class="divider"></div>
      <button class="btn ghost" id="editProfileBtn">Edit Profile</button>
      <button class="btn danger" id="logoutBtn" style="margin-left:.5rem">Log out</button>
      <div class="divider"></div>
      <button class="btn secondary" id="shareQRBtn">Share profile (QR)</button>
    </section>
  </main>

  <nav class="bottom hidden" id="bottomNav">
    <button data-tab="home" class="active">Home</button>
    <button data-tab="requests">Requests</button>
    <button data-tab="community">Community</button>
    <button data-tab="calls">Calls</button>
    <button data-tab="settings">Settings</button>
  </nav>

  <button class="fab hidden" id="fab" title="Action">+</button>

  <!-- Sliding chat panel -->
  <section class="chat-panel" id="chatPanel">
    <header style="gap:.5rem">
      <button class="btn ghost" id="backFromChat">←</button>
      <img id="chatAvatar" class="avatar" src="" alt="avatar">
      <div class="col">
        <div id="chatTitle" class="title">Chat</div>
        <div id="chatPresence" style="font-size:.8rem;color:var(--muted)">offline</div>
      </div>
      <div class="grow"></div>
      <button class="btn secondary" id="audioCallBtn">Audio</button>
      <button class="btn" id="videoCallBtn">Video</button>
    </header>
    <div class="messages" id="messages"></div>
    <div class="composer">
      <input id="msgInput" class="input" placeholder="Message" />
      <button id="sendBtn" class="btn">Send</button>
    </div>
  </section>

  <!-- Overlays & popups -->
  <div class="overlay" id="overlay"></div>

  <div class="popup" id="profilePopup">
    <div class="row" style="gap:.75rem;align-items:center">
      <img id="popupAvatar" class="avatar" src="" alt="me">
      <div class="col grow">
        <div id="popupName" style="font-weight:800"></div>
        <div id="popupEmail" style="color:var(--muted)"></div>
        <div>Public ID: <code id="popupShort"></code></div>
      </div>
      <button class="btn ghost" id="popupClose">✕</button>
    </div>
    <div class="divider"></div>
    <div class="row" style="gap:.5rem">
      <button class="btn" id="editProfileBtn2">Edit Profile</button>
      <button class="btn secondary" id="addFriendBtn">Add Friend</button>
      <button class="btn danger" id="logoutBtn2">Log out</button>
    </div>
  </div>

  <div class="popup" id="editPopup">
    <h3>Edit profile</h3>
    <div class="col" style="gap:.6rem;margin-top:.5rem">
      <input id="editName" class="input" placeholder="Display name" />
      <input id="editAvatar" type="file" accept="image/*" class="input" />
      <button id="saveProfileBtn" class="btn">Save</button>
    </div>
  </div>

  <div class="popup" id="addFriendPopup">
    <h3>Add Friend</h3>
    <p style="color:var(--muted);margin:.4rem 0">Enter a 5-digit public ID.</p>
    <input id="friendIdInput" class="input" placeholder="e.g. 10437" inputmode="numeric" maxlength="5" />
    <div class="row" style="gap:.5rem;margin-top:.6rem">
      <button id="sendFriendReqBtn" class="btn">Send Request</button>
      <button id="closeAddFriend" class="btn ghost">Cancel</button>
    </div>
  </div>

  <div class="popup" id="qrPopup">
    <h3>Share your profile</h3>
    <div id="qrContainer" style="display:flex;justify-content:center;padding:1rem"></div>
    <div style="text-align:center;color:var(--muted)">Scan to add: <b id="qrIdText"></b></div>
  </div>

  <div class="incoming" id="incomingCall">
    <div class="row" style="gap:.6rem;align-items:center;justify-content:space-between">
      <div class="col">
        <div style="font-weight:800">Incoming <span id="incomingType">call</span></div>
        <div id="incomingFrom" style="color:var(--muted)"></div>
      </div>
      <div class="row" style="gap:.5rem">
        <button class="btn secondary" id="rejectCall">Reject</button>
        <button class="btn" id="acceptCall">Accept</button>
      </div>
    </div>
  </div>

  <div class="call-full" id="callUI">
    <div class="call-remote">
      <video id="remoteVideo" autoplay playsinline></video>
      <video id="localVideo" autoplay muted playsinline></video>
    </div>
    <div class="call-controls">
      <button id="toggleMic" class="ctrl mute" title="Mute/unmute">🎙️</button>
      <button id="toggleCam" class="ctrl mute" title="Toggle camera">📷</button>
      <button id="endCall" class="ctrl end" title="End">⛔</button>
    </div>
  </div>

  <div class="toasts" id="toasts"></div>
</div>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getDatabase, ref, set, push, onValue, get, child, update, serverTimestamp, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";
  import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDEOHYkQnyaeDbdVGisC2B2H02kxNfp3F8",
    authDomain: "meaww-chat-4f6bd.firebaseapp.com",
    databaseURL: "https://meaww-chat-4f6bd-default-rtdb.firebaseio.com",
    projectId: "meaww-chat-4f6bd",
    storageBucket: "meaww-chat-4f6bd.firebasestorage.app",
    messagingSenderId: "162714330727",
    appId: "1:162714330727:web:926dd1ce1da5806c0316c2",
    measurementId: "G-L7Y3NV8L88"
  };

  const appFB = initializeApp(firebaseConfig);
  const auth = getAuth(appFB);
  const db = getDatabase(appFB);
  const storage = getStorage(appFB);

  // ---------- Utilities ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const toast = (msg, timeout=2500)=>{
    const t = document.createElement('div'); t.className='toast'; t.textContent=msg; $('#toasts').appendChild(t);
    setTimeout(()=>t.remove(), timeout);
  };
  const show = el => el.classList.add('show');
  const hide = el => el.classList.remove('show');
  const openPopup = id=>{ $('#overlay').classList.add('show'); $(id).classList.add('show'); };
  const closePopups = ()=>{ $('#overlay').classList.remove('show'); $$('.popup').forEach(p=>p.classList.remove('show')); };
  $('#overlay').addEventListener('click', closePopups);

  const defaultAvatar = uid => `https://api.dicebear.com/8.x/thumbs/svg?seed=${uid?.slice(0,8)||'quick'}&backgroundColor=b6e3f4,c0aede,d1d4f9`;

  // Short ID generator (5-digit, unique check)
  async function generateShortId(){
    while(true){
      const id = (''+Math.floor(10000 + Math.random()*90000));
      const snap = await get(child(ref(db), 'shortIds/'+id));
      if(!snap.exists()) return id;
    }
  }

  function roomIdFor(u1,u2){ return [u1,u2].sort().join('_'); }

  // Presence
  function setupPresence(uid){
    const statusRef = ref(db, 'status/'+uid);
    const userRef = ref(db, 'users/'+uid);
    set(statusRef,{state:'online', last_changed: Date.now()});
    update(userRef,{online:true,lastSeen:Date.now()});
    onDisconnect(statusRef).set({state:'offline', last_changed: Date.now()});
    onDisconnect(userRef).update({online:false,lastSeen:Date.now()});
  }

  // ---------- Auth UI ----------
  const authTabs = $('#authTabs');
  authTabs.addEventListener('click', (e)=>{
    if(e.target.tagName!=='BUTTON') return;
    $$('#authTabs button').forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    const tab = e.target.dataset.tab;
    $('#loginPane').classList.toggle('hidden', tab!=='login');
    $('#registerPane').classList.toggle('hidden', tab!=='register');
  });

  $('#loginBtn').onclick=async()=>{
    try{ await signInWithEmailAndPassword(auth, $('#loginEmail').value, $('#loginPass').value); toast('Welcome back!'); }
    catch(e){ toast(e.message); }
  };

  $('#registerBtn').onclick=async()=>{
    const name = $('#regName').value.trim()||'QuickChatter';
    try{
      const cred = await createUserWithEmailAndPassword(auth, $('#regEmail').value, $('#regPass').value);
      const uid = cred.user.uid;
      const shortId = await generateShortId();
      const avatar = defaultAvatar(uid);
      await updateProfile(cred.user, { displayName: name, photoURL: avatar });
      await set(ref(db,'users/'+uid),{ uid, name, email:cred.user.email, avatar, shortId, createdAt: Date.now(), online:true, lastSeen: Date.now() });
      await set(ref(db,'shortIds/'+shortId), { uid });
      toast('Account created');
    }catch(e){ toast(e.message); }
  };

  $('#googleBtn').onclick=async()=>{
    try{
      const provider = new GoogleAuthProvider();
      provider.setCustomParameters({ prompt:'select_account' });
      const cred = await signInWithPopup(auth, provider);
      const uid = cred.user.uid;
      const uRef = ref(db,'users/'+uid);
      const s = await get(uRef);
      if(!s.exists()){
        const shortId = await generateShortId();
        const avatar = cred.user.photoURL || defaultAvatar(uid);
        await set(uRef,{ uid, name:cred.user.displayName||'QuickChatter', email:cred.user.email, avatar, shortId, createdAt: Date.now(), online:true, lastSeen: Date.now() });
        await set(ref(db,'shortIds/'+shortId), { uid });
      }
      toast('Signed in with Google');
    }catch(e){ toast(e.message); }
  };

  $('#logoutBtn').onclick=$('#logoutBtn2').onclick=async()=>{ await signOut(auth); };

  // ---------- Main state ----------
  let me=null; // current user object
  let currentChat=null; // {type:'dm'|'group', id, peer}
  let unsubMessages=null;

  function switchTab(tab){
    $$('#bottomNav button').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
    $$('#pages > .page').forEach(p=>p.classList.add('hidden'));
    $('#page-'+tab).classList.remove('hidden');
    // Contextual FAB
    const fab=$('#fab');
    fab.classList.remove('hidden');
    if(tab==='home'){ fab.textContent='+'; fab.title='Add Friend'; fab.onclick=()=>openPopup('#addFriendPopup'); }
    else if(tab==='community'){ fab.textContent='+'; fab.title='Create Community'; fab.onclick=createCommunityPrompt; }
    else{ fab.classList.add('hidden'); }
  }

  // Bottom nav events
  $('#bottomNav').addEventListener('click',(e)=>{ if(e.target.tagName==='BUTTON') switchTab(e.target.dataset.tab) });

  // Header profile
  $('#profileBtn').onclick=()=>{ if(!me) return; $('#popupAvatar').src=me.avatar; $('#popupName').textContent=me.name; $('#popupEmail').textContent=me.email; $('#popupShort').textContent=me.shortId; openPopup('#profilePopup'); };
  $('#popupClose').onclick=closePopups;

  // Edit profile
  const openEdit=()=>{ $('#editName').value=me?.name||''; openPopup('#editPopup'); };
  $('#editProfileBtn').onclick=$('#editProfileBtn2').onclick=openEdit;
  $('#saveProfileBtn').onclick=async()=>{
    try{
      const newName = $('#editName').value.trim()||me.name;
      let avatarURL = me.avatar;
      const file = $('#editAvatar').files[0];
      if(file){
        const path = `avatars/${me.uid}/${Date.now()}_${file.name}`;
        const res = await uploadBytes(sref(storage, path), file);
        avatarURL = await getDownloadURL(res.ref);
      }
      await update(ref(db,'users/'+me.uid),{ name:newName, avatar:avatarURL });
      if(auth.currentUser) await updateProfile(auth.currentUser,{ displayName:newName, photoURL:avatarURL });
      $('#navAvatar').src=avatarURL; $('#settingsAvatar').src=avatarURL; toast('Profile updated'); closePopups();
    }catch(e){ toast(e.message); }
  };

  // Add friend popup
  $('#addFriendBtn').onclick=()=>openPopup('#addFriendPopup');
  $('#closeAddFriend').onclick=closePopups;
  $('#sendFriendReqBtn').onclick=async()=>{
    try{
      const id = $('#friendIdInput').value.trim(); if(id.length!==5){ toast('Enter a 5-digit ID'); return; }
      const snap = await get(child(ref(db), 'shortIds/'+id));
      if(!snap.exists()){ toast('No user with that ID'); return; }
      const target = snap.val().uid; if(target===me.uid){ toast("That's you!"); return; }
      await set(ref(db, `friendRequests/${target}/${me.uid}`), { from:me.uid, ts: Date.now() });
      toast('Request sent'); closePopups();
    }catch(e){ toast(e.message); }
  };

  // QR share
  $('#shareQRBtn').onclick=()=>{ $('#qrContainer').innerHTML=''; $('#qrIdText').textContent=me.shortId; new QRCode(document.getElementById('qrContainer'), { text: me.shortId, width: 220, height: 220 }); openPopup('#qrPopup'); };

  // Friends list
  function renderFriendItem(u){
    const li = document.createElement('div'); li.className='item';
    li.innerHTML = `<img class="avatar" src="${u.avatar}" alt="${u.name}">
      <div class="col grow"><div class="name">${u.name}</div>
      <div style="color:var(--muted);font-size:.85rem">${u.online?'<span class="status-dot status-online"></span> online':'last seen '+timeAgo(u.lastSeen)}</div></div>`;
    li.onclick=()=>openDM(u);
    return li;
  }

  function timeAgo(ts){ if(!ts) return '—'; const d = Math.floor((Date.now()-ts)/1000); if(d<60) return d+"s ago"; if(d<3600) return Math.floor(d/60)+"m ago"; if(d<86400) return Math.floor(d/3600)+"h ago"; return Math.floor(d/86400)+"d ago"; }

  async function refreshFriends(){
    const list = $('#friendsList'); list.innerHTML='';
    const snap = await get(ref(db, 'friends/'+me.uid));
    const friends = snap.exists()? Object.keys(snap.val()): [];
    for(const fid of friends){
      const us = await get(ref(db,'users/'+fid)); if(us.exists()) list.appendChild(renderFriendItem(us.val()));
    }
  }

  // Requests list
  function listenRequests(){
    onValue(ref(db,'friendRequests/'+me.uid), async (snap)=>{
      const wrap = $('#requestsList'); wrap.innerHTML='';
      const data = snap.val()||{};
      for(const from in data){
        const us = await get(ref(db,'users/'+from)); if(!us.exists()) continue; const u=us.val();
        const it=document.createElement('div'); it.className='item';
        it.innerHTML=`<img class="avatar" src="${u.avatar}"><div class="col grow"><div class="name">${u.name}</div><div style="color:var(--muted)">${u.email}</div></div>`;
        const acc = document.createElement('button'); acc.className='btn'; acc.textContent='Accept';
        const rej = document.createElement('button'); rej.className='btn secondary'; rej.textContent='Reject';
        acc.onclick=async()=>{
          await set(ref(db,`friends/${me.uid}/${from}`),true);
          await set(ref(db,`friends/${from}/${me.uid}`),true);
          await remove(ref(db,`friendRequests/${me.uid}/${from}`));
          toast('Friend added'); refreshFriends();
        };
        rej.onclick=async()=>{ await remove(ref(db,`friendRequests/${me.uid}/${from}`)); toast('Request rejected'); };
        it.appendChild(acc); it.appendChild(rej); wrap.appendChild(it);
      }
    });
  }

  // Communities
  async function createCommunityPrompt(){
    const name = prompt('Community name'); if(!name) return;
    const id = push(ref(db,'communities')).key;
    await set(ref(db,'communities/'+id),{ id, name, owner: me.uid, createdAt: Date.now() });
    await set(ref(db,`communityMembers/${id}/${me.uid}`), true);
    toast('Community created'); loadCommunities();
  }
  function renderCommunityItem(c, joined){
    const it=document.createElement('div'); it.className='item';
    it.innerHTML=`<div class="col grow"><div class="name">${c.name}</div><div style=color:var(--muted);font-size:.85rem>id:${c.id.slice(-6)}</div></div>`;
    const btn=document.createElement('button'); btn.className='btn'; btn.textContent= joined?'Open':'Join';
    btn.onclick=async()=>{ if(!joined){ await set(ref(db,`communityMembers/${c.id}/${me.uid}`), true); toast('Joined'); loadCommunities(); } else { openGroup(c); } };
    it.appendChild(btn); return it;
  }
  async function loadCommunities(){
    const wrap=$('#communitiesList'); wrap.innerHTML='';
    const cs = await get(ref(db,'communities'));
    const myJoined=[];
    if(cs.exists()){
      const data=cs.val();
      for(const id in data){
        const c=data[id]; const joinedSnap=await get(ref(db,`communityMembers/${id}/${me.uid}`)); const joined=joinedSnap.exists();
        if(joined) myJoined.push(id);
        wrap.appendChild(renderCommunityItem(c, joined));
      }
    }
    $('#joinedCount').textContent = myJoined.length+" joined";
  }

  // --- Chat mechanics ---
  function openDM(user){
    currentChat={ type:'dm', id: roomIdFor(me.uid,user.uid), peer:user };
    $('#chatTitle').textContent = user.name; $('#chatAvatar').src=user.avatar; $('#chatPresence').textContent = user.online? 'online' : ('last seen '+timeAgo(user.lastSeen));
    openChatPanel(); listenMessages();
  }
  function openGroup(c){
    currentChat={ type:'group', id: c.id, peer: c };
    $('#chatTitle').textContent = c.name; $('#chatAvatar').src= defaultAvatar(c.id);
    $('#chatPresence').textContent = 'community'; openChatPanel(); listenMessages();
  }
  function openChatPanel(){ $('#chatPanel').classList.add('open'); $('#messages').innerHTML=''; $('#msgInput').value=''; }
  $('#backFromChat').onclick=()=>{ $('#chatPanel').classList.remove('open'); if(unsubMessages) unsubMessages(); };

  function listenMessages(){
    if(unsubMessages) unsubMessages();
    const path = currentChat.type==='dm' ? `chats/${currentChat.id}/messages` : `communityMessages/${currentChat.id}`;
    const r = ref(db, path);
    const h = onValue(r, s=>{
      const wrap=$('#messages'); wrap.innerHTML='';
      const data = s.val()||{}; const entries = Object.values(data).sort((a,b)=>a.ts-b.ts);
      for(const m of entries){
        const div=document.createElement('div'); div.className='msg '+(m.from===me.uid? 'me':'them');
        const name = currentChat.type==='group' && m.from!==me.uid ? `<div style="font-weight:700;margin-bottom:.2rem">${m.fromName||''}</div>`:'';
        div.innerHTML = `${name}${m.text?escapeHtml(m.text):''}<div class="meta">${new Date(m.ts).toLocaleTimeString()}</div>`;
        wrap.appendChild(div);
      }
      wrap.scrollTop = wrap.scrollHeight;
    });
    unsubMessages = ()=> h();
  }

  function escapeHtml(str){ return str.replace(/[&<>'"]/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;","\"":"&quot;"}[s])) }

  $('#sendBtn').onclick=async()=>{
    if(!currentChat) return; const text = $('#msgInput').value.trim(); if(!text) return;
    const payload = { from:me.uid, fromName: me.name, text, ts: Date.now() };
    const path = currentChat.type==='dm' ? `chats/${currentChat.id}/messages` : `communityMessages/${currentChat.id}`;
    await set(ref(db, path+'/'+push(ref(db)).key), payload);
    $('#msgInput').value='';
  };

  // --- Calls (WebRTC) ---
  let pc=null, localStream=null, remoteStream=null, callRef=null, callTimeout=null;

  async function startCall(type){
    if(!currentChat || currentChat.type!=='dm') return toast('Open a direct chat first');
    const peer = currentChat.peer;
    const id = push(ref(db,'calls')).key; callRef = ref(db,'calls/'+id);
    await set(callRef,{ id, caller:me.uid, callee:peer.uid, type, status:'ringing', createdAt: Date.now() });
    preparePC();
    localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video: type==='video' });
    localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
    $('#localVideo').srcObject = localStream; $('#localVideo').style.display = type==='video'?'block':'none';
    show($('#callUI'));
    const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
    await update(callRef,{ offer });
    // ICE
    pc.onicecandidate = e=>{ if(e.candidate) push(ref(db,`calls/${id}/candidates/${me.uid}`), e.candidate.toJSON()); };
    // Listen answer & candidates
    onValue(ref(db,`calls/${id}/answer`), s=>{ const ans=s.val(); if(ans && !pc.currentRemoteDescription){ pc.setRemoteDescription(ans); } });
    onValue(ref(db,`calls/${id}/candidates/${peer.uid}`), s=>{ const list=s.val(); if(list){ Object.values(list).forEach(c=> pc.addIceCandidate(c).catch(()=>{})); } });
    // timeout 30s
    clearTimeout(callTimeout); callTimeout=setTimeout(async()=>{ await update(callRef,{ status:'missed' }); endCall(); toast('No answer'); saveHistory(peer,'outgoing',type,'missed'); }, 30000);
  }

  function preparePC(){
    pc = new RTCPeerConnection({ iceServers:[{urls:['stun:stun.l.google.com:19302']}] });
    remoteStream = new MediaStream(); $('#remoteVideo').srcObject = remoteStream;
    pc.ontrack = e=> e.streams[0].getTracks().forEach(t=> remoteStream.addTrack(t));
  }

  async function receiveCall(call){
    callRef = ref(db,'calls/'+call.id); preparePC();
    const type = call.type; show($('#callUI'));
    localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video: type==='video' });
    localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));
    $('#localVideo').srcObject = localStream; $('#localVideo').style.display = type==='video'?'block':'none';

    await pc.setRemoteDescription(call.offer);
    const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
    await update(callRef,{ answer, status:'answered' });

    pc.onicecandidate = e=>{ if(e.candidate) push(ref(db,`calls/${call.id}/candidates/${me.uid}`), e.candidate.toJSON()); };
    onValue(ref(db,`calls/${call.id}/candidates/${call.caller}`), s=>{ const list=s.val(); if(list){ Object.values(list).forEach(c=> pc.addIceCandidate(c).catch(()=>{})); } });
    saveHistory({uid:call.caller},'incoming',type,'answered');
  }

  function endCall(){
    try{ pc?.getSenders()?.forEach(s=>s.track && s.track.stop()); localStream?.getTracks()?.forEach(t=>t.stop()); }catch{}
    pc?.close(); pc=null; localStream=null; remoteStream=null; hide($('#callUI'));
  }

  function saveHistory(peer, dir, type, status){
    const rec={ peer: peer.uid, dir, type, status, ts: Date.now() };
    set(ref(db,`callHistory/${me.uid}/${push(ref(db)).key}`), rec);
  }

  // Drag local video
  (function(){
    const el = $('#localVideo'); let sx=0, sy=0, dx=0, dy=0, dragging=false;
    el.addEventListener('pointerdown',e=>{ dragging=true; sx=e.clientX; sy=e.clientY; el.setPointerCapture(e.pointerId); el.style.cursor='grabbing'; });
    el.addEventListener('pointermove',e=>{ if(!dragging) return; dx+=e.clientX-sx; dy+=e.clientY-sy; sx=e.clientX; sy=e.clientY; el.style.transform=`translate(${dx}px,${dy}px)`; });
    el.addEventListener('pointerup',()=>{ dragging=false; el.style.cursor='grab'; });
  })();

  // Incoming call listener + popup
  onValue(ref(db,'calls'), async (snap)=>{
    const data = snap.val()||{}; for(const id in data){ const c=data[id]; if(!me) continue; if(c.callee===me.uid && c.status==='ringing'){
      const us = await get(ref(db,'users/'+c.caller)); const name = us.exists()? us.val().name : 'Unknown';
      $('#incomingType').textContent = c.type+' call'; $('#incomingFrom').textContent = name; $('.incoming').classList.add('show');
      const accept=()=>{ $('.incoming').classList.remove('show'); receiveCall(c); clearTimeout(callTimeout); };
      const reject=async()=>{ $('.incoming').classList.remove('show'); await update(ref(db,'calls/'+c.id),{ status:'rejected' }); saveHistory({uid:c.caller},'incoming',c.type,'rejected'); };
      $('#acceptCall').onclick=accept; $('#rejectCall').onclick=reject;
      clearTimeout(callTimeout); callTimeout=setTimeout(async()=>{ if($('.incoming').classList.contains('show')){ $('.incoming').classList.remove('show'); await update(ref(db,'calls/'+c.id),{ status:'missed' }); saveHistory({uid:c.caller},'incoming',c.type,'missed'); } }, 30000);
    }
  });

  // Call UI buttons
  $('#audioCallBtn').onclick=()=>startCall('audio');
  $('#videoCallBtn').onclick=()=>startCall('video');
  $('#endCall').onclick=()=>{ endCall(); };
  $('#toggleMic').onclick=()=>{ if(!localStream) return; localStream.getAudioTracks().forEach(t=>t.enabled=!t.enabled); };
  $('#toggleCam').onclick=()=>{ if(!localStream) return; localStream.getVideoTracks().forEach(t=>t.enabled=!t.enabled); };

  // Call history render
  async function loadCallHistory(){
    const list=$('#callHistory'); list.innerHTML='';
    const s=await get(ref(db,'callHistory/'+me.uid)); const data=s.val()||{}; const arr=Object.values(data).sort((a,b)=>b.ts-a.ts);
    for(const h of arr){
      const peerSnap=await get(ref(db,'users/'+h.peer)); const u=peerSnap.val()||{name:'Unknown',avatar:defaultAvatar('u')};
      const it=document.createElement('div'); it.className='item';
      it.innerHTML=`<img class="avatar" src="${u.avatar}"><div class="col grow"><div class="name">${u.name}</div><div style="color:var(--muted);font-size:.85rem">${new Date(h.ts).toLocaleString()} • ${h.type} • ${h.dir} • ${h.status}</div></div>`;
      list.appendChild(it);
    }
  }

  // Profile popup trigger in header
  $('#profileBtn').addEventListener('click',()=>{});

  // Search (simple filter for friends list by name)
  $('#search').addEventListener('input',()=>{
    const q=$('#search').value.toLowerCase();
    $$('#friendsList .item').forEach(it=>{ const name=it.querySelector('.name').textContent.toLowerCase(); it.style.display = name.includes(q)?'flex':'none'; });
  });

  // Chat presence update (peer)
  async function watchPeerPresence(){
    if(!currentChat || currentChat.type!=='dm') return;
    const us = await get(ref(db,'users/'+currentChat.peer.uid)); if(us.exists()){ const u=us.val(); $('#chatPresence').textContent = u.online? 'online' : ('last seen '+timeAgo(u.lastSeen)); }
  }
  setInterval(watchPeerPresence, 4000);

  // Profile button mirrors settings
  function setProfileUI(){
    $('#navAvatar').src=me.avatar; $('#settingsAvatar').src=me.avatar; $('#settingsName').textContent=me.name; $('#settingsEmail').textContent=me.email; $('#settingsShort').textContent=me.shortId;
  }

  // Auth state
  onAuthStateChanged(auth, async (user)=>{
    if(user){
      $('#auth').classList.add('hidden'); $('#mainHeader').classList.remove('hidden'); $('#pages').classList.remove('hidden'); $('#bottomNav').classList.remove('hidden');
      const uSnap = await get(ref(db,'users/'+user.uid));
      if(uSnap.exists()){ me = uSnap.val(); } else {
        // Edge case: google login without profile yet
        const shortId = await generateShortId();
        const avatar = user.photoURL || defaultAvatar(user.uid);
        me = { uid:user.uid, name:user.displayName||'QuickChatter', email:user.email, avatar, shortId, createdAt: Date.now(), online:true, lastSeen: Date.now() };
        await set(ref(db,'users/'+user.uid), me); await set(ref(db,'shortIds/'+shortId), { uid:user.uid });
      }
      setupPresence(user.uid);
      setProfileUI(); switchTab('home'); refreshFriends(); listenRequests(); loadCommunities(); loadCallHistory();
    } else {
      $('#auth').classList.remove('hidden'); $('#mainHeader').classList.add('hidden'); $('#pages').classList.add('hidden'); $('#bottomNav').classList.add('hidden'); $('#fab').classList.add('hidden');
    }
  });
</script>

<!-- Lightweight QRCode library (minified) -->
<script>
/*! QRCode.js v1.0.0 (minimal build) https://github.com/davidshimjs/qrcodejs */
(function(o){function p(a){this.mode=s;this.data=a}function t(a,b){this.typeNumber=a;this.errorCorrectLevel=b;this.modules=null;this.moduleCount=0;this.dataCache=null;this.dataList=[]}function u(a,b){if(void 0==a.length)throw Error(a.length+"/"+b);for(var c=0;c<a.length&&0==a[c];)c++;this.num=Array(a.length-c+b);for(var d=0;d<a.length-c;d++)this.num[d]=a[d+c]}function v(a,b){this.totalCount=a;this.dataCount=b}function w(){this.buffer=[];this.length=0}var x={L:1,M:0,Q:3,H:2},s=4,y=2;u.prototype={get:function(a){return this.num[a]},getLength:function(){return this.num.length},multiply:function(a){for(var b=Array(this.getLength()+a.getLength()-1),c=0;c<this.getLength();c++)for(var d=0;d<a.getLength();d++)b[c+d]^=q.gexp(q.glog(this.get(c))+q.glog(a.get(d)));return new u(b,0)},mod:function(a){if(0>this.getLength()-a.getLength())return this;for(var b=q.glog(this.get(0))-q.glog(a.get(0)),c=Array(this.getLength()),d=0;d<this.getLength();d++)c[d]=this.get(d);for(d=0;d<a.getLength();d++)c[d]^=q.gexp(q.glog(a.get(d))+b);return(new u(c,0)).mod(a)}};var q={glog:function(a){if(1>a)throw Error("glog("+a+")");return r[a]},gexp:function(a){for(;0>a;)a+=255;for(;256<=a;)a-=255;return z[a]}};t.prototype={addData:function(a){this.dataList.push(new p(a));this.dataCache=null},isDark:function(a,b){if(0>a||this.moduleCount<=a||0>b||this.moduleCount<=b)throw Error(a+","+b);return this.modules[a][b]},getModuleCount:function(){return this.moduleCount},make:function(){if(1>this.typeNumber){for(var a=1;40>a;a++){for(var b=v.getRSBlocks(a,this.errorCorrectLevel),c=new w,d=0;d<b.length;d++)c.put(4,4),c.put(8,8);for(d=0;d<this.dataList.length;d++)c.put(4,4),c.put(8,this.dataList[d].data.length);var e=0;for(d=0;d<b.length;d++)e+=b[d].dataCount;if(c.getLengthInBits()<=8*e){this.typeNumber=a;break}}}this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(a,b){this.moduleCount=4*this.typeNumber+17;this.modules=Array(this.moduleCount);for(var c=0;c<this.moduleCount;c++){this.modules[c]=Array(this.moduleCount);for(var d=0;d<this.moduleCount;d++)this.modules[c][d]=null}A(this,this.typeNumber,b);for(c=0;c<this.dataList.length;c++){d=this.dataList[c];for(var e=0;e<d.data.length;e++)B(this,d.data.charCodeAt(e))}C(this,b)},getBestMaskPattern:function(){var a=0,b=0;for(var c=0;8>c;c++){this.makeImpl(!0,c);var d=D(this);if(0==c||a>d)a=d,b=c}return b}};w.prototype={getBuffer:function(){return this.buffer},getLengthInBits:function(){return this.length},put:function(a,b){for(var c=0;c<b;c++)this.putBit(a>>>b-c-1&1)},putBit:function(a){this.buffer.push(a);this.length++}};var z=Array(256),r=Array(256);(function(){for(var a=1,b=0;256>b;b++)z[b]=a,a<<=1,256<=a&&(a^=285);for(b=0;255>b;b++)r[z[b]]=b})();t.stringToBytes=function(a){for(var b=[],c=0;c<a.length;c++){var d=a.charCodeAt(c);b.push(255<d?63:d)}return b};v.RS_BLOCK_TABLE=[[1,26,19],[1,44,34],[1,70,55],[1,100,80],[1,134,108],[2,86,68],[2,98,78],[2,121,97],[2,146,116],[2,86,68],[2,98,78],[2,121,97],[2,146,116],[2,86,68],[2,98,78],[2,121,97],[2,146,116],[2,86,68],[2,98,78],[2,121,97],[2,146,116],[2,86,68],[2,98,78],[2,121,97],[2,146,116],[2,86,68],[2,98,78],[2,121,97],[2,146,116],[2,86,68],[2,98,78],[2,121,97],[2,146,116],[2,86,68],[2,98,78],[2,121,97],[2,146,116],[2,86,68],[2,98,78],[2,121,97]];v.getRSBlocks=function(a,b){var c=v.RS_BLOCK_TABLE[a-1],d=[];for(a=0;a<c.length;a++){var e=c[a];d.push(new v(e[0],e[2]))}return d};
function A(a,b,c){for(var d=0;d<7;d++)for(var e=0;e<7;e++){var f=d,e=e;E(a,f,e,0<=f&&f<=6&&(0==e||6==e)||0<=e&&e<=6&&(0==f||6==f)||2<=f&&f<=4&&2<=e&&e<=4)}for(d=0;d<a.moduleCount;d++)E(a,d,6,0==d%2);for(d=0;d<a.moduleCount;d++)E(a,6,d,0==d%2)}function B(a,b){for(var c=0;8>c;c++)E(a,a.moduleCount-1-c, a.moduleCount-1,!1);for(c=0;c<8;c++)E(a,a.moduleCount-1, a.moduleCount-1-c,!1)}function C(a,b){for(var c=0;c<a.moduleCount;c++)for(var d=0;d<a.moduleCount;d++)if(null==a.modules[c][d]){var e=!1;switch(b){case 0:e=0==(c+d)%2;break;case 1:e=0==c%2;break;case 2:e=0==d%3;break;case 3:e=0==(c+d)%3;break;case 4:e=0==(Math.floor(c/2)+Math.floor(d/3))%2;break;case 5:e=0==(c*d)%2+(c*d)%3;break;case 6:e=0==(c*d)%2+(c*d)%3;break;case 7:e=0==(c*d)%3+(c+d)%2}a.modules[c][d]=e}}function D(a){for(var b=0,c=0;c<a.moduleCount;c++)for(var d=0;d<a.moduleCount;d++){var e=a.modules[c][d];b+=e?0:1}return b}
function QRCode(a,b){this._el=a;this._htOption=b;this._oQRCode=null;this._oDrawing=null;this.makeCode(b.text)}
QRCode.prototype.makeCode=function(a){var b=new t(0,x.M);b.addData(a);b.make();for(var c=b.getModuleCount(),d=document.createElement('div'),e=0;e<c;e++){for(var f=document.createElement('div'),g=0;g<c;g++){var h=document.createElement('span');h.style.display='inline-block';h.style.width=this._htOption.width/c+'px';h.style.height=this._htOption.height/c+'px';h.style.background=b.isDark(e,g)?'#000':'#fff';f.appendChild(h)}d.appendChild(f)}this._el.innerHTML='';this._el.appendChild(d)}
window.QRCode=QRCode;
})(this);
</script>

</body>
</html>
